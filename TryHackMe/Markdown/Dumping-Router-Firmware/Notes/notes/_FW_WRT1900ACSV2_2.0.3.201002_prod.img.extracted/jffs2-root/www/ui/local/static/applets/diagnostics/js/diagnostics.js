(function(){var u=$("#diagnostics-applet"),k=u.find("#status"),ac=u.find("#sysinfo-report"),J=u.find("#text-sysinfo"),D=ac.find("#text-search"),x=false,X=false,f=0,M,am,m,g,o,P,w=null,ad={},Y=[],z=[];var l={deviceInfo:JNAP.cache.data["/core/GetDeviceInfo"].output,totalWirelessClients:0,totalWiredClients:0,dmz:{},firmware:{},firmwareStatus:{},fwUpdate:{},fwLastSuccessfulCheckTime:null,guestAccess:{},parentalControl:{},singlePortForwarding:{},portForwarding:{},portTriggering:{},portRanges:{},qos:{},wanStatus:{},wireless:{},ftpServerSettings:{},smbServerSettings:{},sysinfo:{},sysData:{}};var K={isCurrentFW:"display-only","deviceInfo.isCurrentFW":"display-only","sysData.certRegion":"display-only","sysData.upTime":"display-only",radioLabel:"display-only",competingNetworks:"display-only",mostCongestedChannel:"display-only",radio24_label:"display-only",radio5_label:"display-only",radio52_label:"display-only"};var q,an,O,Q;var b=RAINIER.ui.radStrings.noSysinfoData,j=RAINIER.ui.radStrings.textNotFound,aa=RAINIER.ui.radStrings.qosDevice,C=RAINIER.ui.radStrings.qosApp;var al=u.find("#templateSpinner").html();var p=/UpTime:[\r\n].+ up (.+)(,  \d+ users|, load)/,ai=/device::serial_number=(.+)/,v=/device::cert_region=(.+)/,ab=/ath0 Settings(.|[\r\n])+?(-+) /,U=/ath1 Settings(.|[\r\n])+?(-+) /,h=/ath10 Settings(.|[\r\n])+?(-+) /,G=/Site Survey on 2.4GHz:(.|[\r\n])+Site Survey/,ae=/Site Survey on 5GHz:(.|[\r\n])+?=(=+)/,d=/Frequency: ?(\d+\.\d+) ?GHz/,s=new RegExp(d,"g");var A={healthCheck:false,nodes:false,qos:false,storage:false,sysinfo:false,};function r(aq){RAINIER.jnap.send({action:"/jnap/firmwareupdate/UpdateFirmwareNow",data:{onlyCheck:true},cb:function(ar){aq(ar)},disableDefaultJnapErrHandler:true,disableDefaultAjaxErrHandler:true,disableDefaultRebootErrHandler:true})}function ap(){var aq=(l.firmwareStatus.lastSuccessfulCheckTime!==l.fwLastSuccessfulCheckTime),ar=(!l.firmwareStatus.pendingOperation||l.firmwareStatus.pendingOperation!=="Checking");if(l.firmwareStatus.availableUpdate||(aq&&ar)||f>15){ao()}else{f++;setTimeout(function(){V(ap)},2500)}}function V(aq){var ar=null;RAINIER.jnap.send({action:"/jnap/firmwareupdate/GetFirmwareUpdateStatus",data:{},cb:function(at){if(at.result==="OK"){l.firmwareStatus=at.output||{}}else{ar=at.result}if(typeof aq==="function"){aq(ar)}},disableDefaultJnapErrHandler:true,disableDefaultAjaxErrHandler:true,disableDefaultRebootErrHandler:true,timeoutMs:10000})}function ao(aq){var ar,at;if(!A.nodes){ar=l.firmwareStatus.availableUpdate?"no":"yes";l.deviceInfo.isCurrentFW=RAINIER.ui.button.strings[ar];RAINIER.binder.toDom(l,k,K)}else{k.find(".router-node").each(function(){var av=$(this),aw=av.data("deviceid"),au=lodash.find(aq.firmwareUpdateStatus,{deviceUUID:aw},null);if(au){ar=au.availableUpdate?"no":"yes";at=RAINIER.ui.button.strings[ar];av.find(".current-fw-row > label + label").html(at)}})}m.resolve()}function E(aq){aq.add({action:RAINIER.jnapActions.getRadioInfo(),data:{},cb:function(ar){if(ar.result==="OK"){l.wireless=ar.output||{};RAINIER.applets.wireless.sortRadios(l.wireless.radios)}else{}}});aq.add({action:RAINIER.jnapActions.getGuestRadioSettings(),data:{},cb:function(ar){if(ar.result==="OK"){l.guestAccess=ar.output||{}}}});if(A.storage){aq.add({action:"/jnap/storage/GetFTPServerSettings",data:{},cb:function(ar){if(ar.result==="OK"){l.ftpServerSettings=ar.output}}});aq.add({action:"/jnap/storage/GetSMBServerSettings",data:{},cb:function(ar){if(ar.result==="OK"){l.smbServerSettings=ar.output}}})}aq.add({action:RAINIER.jnapActions.getWANStatus(),data:{},cb:function(ar){if(ar.result==="OK"){l.wanStatus=ar.output}else{}}});aq.add({action:"/jnap/firmwareupdate/GetFirmwareUpdateSettings",data:{},cb:function(ar){if(ar.result==="OK"){l.firmware=ar.output||{}}else{}}});if(A.qos){o.jnap.getQoS(aq,function(ar){l.qos=ar||{}})}aq.add({action:"/jnap/firewall/GetSinglePortForwardingRules",data:{},cb:function(ar){if(ar.result==="OK"){l.singlePortForwarding=ar.output||{}}}});aq.add({action:"/jnap/firewall/GetPortRangeForwardingRules",data:{},cb:function(ar){if(ar.result==="OK"){l.portForwarding=ar.output||{}}}});aq.add({action:"/jnap/firewall/GetPortRangeTriggeringRules",data:{},cb:function(ar){if(ar.result==="OK"){l.portTriggering=ar.output||{}}}});aq.add({action:"/jnap/firewall/GetDMZSettings",data:{},cb:function(ar){if(ar.result==="OK"){l.dmz=ar.output||{}}}});aq.add({action:"/jnap/parentalcontrol/GetParentalControlSettings",data:{},cb:function(ar){if(ar.result==="OK"){l.parentalControl=ar.output||{}}}});if(A.nodes){symmetryUtil.firmwareUpdate.check({success:function(ar){ao(ar.output)},error:function(ar){}})}else{V(function(){l.fwLastSuccessfulCheckTime=l.firmwareStatus.lastSuccessfulCheckTime;r(function(ar){if(ar.result==="OK"){setTimeout(function(){V(ap)},2500)}else{}})})}}function B(){var aq=Y.length;console.warn("connectionsToDom");$.each(Y,function(au,at){ad.routerLabel=at.routerLabel;ad.routerName=at.routerName;ad.wiredClientsCount=at.wired;$.each(at.wirelessConnections,function(){if(this.radioID==="RADIO_2.4GHz"){ad.clientsCount24=this.clients}else{if(this.radioID==="RADIO_5GHz"){ad.clientsCount5=this.clients}else{if(this.radioID==="RADIO_5GHz_2"){ad.clientsCount5_2=this.clients}}}});console.warn("connectionData",ad);var ar=RAINIER.ui.template.createBlock(Q,ad,K);if(!at.isOnline){ar.find(".radio24-row > label + label").addClass("error");ar.find(".radio5-row > label + label").addClass("error");ar.find(".radio52-row > label + label").addClass("error");ar.find(".wired-row > label + label").addClass("error")}k.find("#router-clients").append(ar);if(au<aq-1){k.find("#router-clients").append("<hr />")}})}function T(){var aq=$.extend(true,{},l.wireless),ar=aq.radios.length,au=z.length,at,aw,av;aq.isBandSteeringEnabled=false;aq.combineNetworks=false;RAINIER.binder.toDom(l,k,K);l.deviceInfo.isCurrentFW=al;if(!A.sysinfo){l.sysData.upTime=b;l.sysData.certRegion=b}else{if(!X){l.sysData.upTime=al;l.sysData.certRegion=al}}av=RAINIER.ui.template.createBlock(q,l,K);k.find("#router-section").append(av);if(A.nodes){console.warn("authorityDevice",P);k.find(".authority-device").data("deviceid",P.deviceID());if(z.length){k.find("#router-section").append("<hr />");$.each(z,function(ax,aA){var ay=$.extend(true,{},aA.data),az=ax+1;ay.isCurrentFW=aA.isOnline()?al:"--";av=RAINIER.ui.template.createBlock(an,ay,K);if(!aA.isOnline()){av.find(".ip-row > label + label").addClass("error");av.find(".current-fw-row > label + label").addClass("error")}k.find("#router-section").append(av);k.find("#router-section .router-node:last").data("deviceid",aA.deviceID());if(ax<au-1){k.find("#router-section").append("<hr />")}})}}$.each(aq.radios,function(aA,ay){var aB=RAINIER.shared.util.getLabeledRadio(aq,ay.radioID),ax=ay.settings.broadcastSSID?"yes":"no";aB.radioLabel=aB.labels["short"];if(aB.radioID==="RADIO_2.4GHz"){ad.radio24_label=aB.radioLabel+":"}else{if(aB.radioID==="RADIO_5GHz"){ad.radio5_label=aB.radioLabel+":"}else{if(aB.radioID==="RADIO_5GHz_2"){ad.radio52_label=aB.radioLabel+":"}}}if(!ay.settings.isEnabled){aB.radioLabel+=" ("+RAINIER.ui.common.strings.off+")"}aB.isBroadcasting=RAINIER.ui.button.strings[ax];if(ay.settings.channel===0){aB.settings.channel="0 ("+RAINIER.ui.common.strings.auto+")"}if(!A.sysinfo){aB.competingNetworks=b;aB.mostCongestedChannel=b}else{if(!X){aB.competingNetworks=al;aB.mostCongestedChannel=al}}console.warn("radioData",aB);var az=RAINIER.ui.template.createBlock(O,aB,K);if(!ay.settings.isEnabled){az.find(".enabled-only-row").hide()}else{if(ay.radioID==="RADIO_5GHz_2"){az.find(".competing-networks-row").hide();az.find(".most-congested-row").hide()}}k.find("#radio-section").append(az);k.find("#radio-section .wireless-radio:last").data("radioid",ay.radioID);if(aA<ar-1){k.find("#radio-section").append("<hr />")}});k.find("#speed-test-results").html(RAINIER.ui.strings.mediaPrioritization.upDownOnly.formatObj({downloadSpeed:(l.qos.downstreamBandwidthbps/o.Mb).toFixed(2),uploadSpeed:(l.qos.upstreamBandwidthbps/o.Mb).toFixed(2)}));B();am.resolve()}function e(){}function I(ar){function aq(aw,av){var at=0;if(av){at=lodash.findIndex(Y,{deviceID:av})||0}if(aw==="Wired"){Y[at].wired++}else{var au;au=lodash.find(Y[at].wirelessConnections,{radioID:aw});au.clients++}}Y.push({routerLabel:A.nodes?RAINIER.ui.radStrings.parentNode:null,routerName:P.friendlyName(),deviceID:P.deviceID(),isOnline:true,wired:0,wirelessConnections:[]});if(z.length){$.each(z,function(at){this.data.childLabel=RAINIER.ui.radStrings.childNodeLabel.format(at+1);var au={routerLabel:this.data.childLabel,routerName:this.friendlyName(),deviceID:this.deviceID(),isOnline:this.isOnline(),wired:0,wirelessConnections:[]};if(!this.isOnline()){au.routerName+=" ("+RAINIER.ui.common.strings.offline+")";au.wired="--"}Y.push(au)})}$.each(Y,function(au,at){$.each(l.wireless.radios,function(){var av={radioID:this.radioID,clients:0};if(!at.isOnline){av.clients="--"}Y[au].wirelessConnections.push(av)})});console.warn("connectionsBreakdown",Y);$.each(ar,function(at,au){if(au.isOnline()&&!au.isAuthority()&&(!A.nodes||au.nodeType()!=="Slave")){$.each(au.data.connections,function(av,aw){if(aw.wireless){l.totalWirelessClients++;if(aw.wireless.band==="5GHz"){if(aw.wireless.radioID){aq(aw.wireless.radioID,aw.parentDeviceID)}else{aq("RADIO_5GHz",aw.parentDeviceID)}}else{aq("RADIO_2.4GHz",aw.parentDeviceID)}}else{l.totalWiredClients++;aq("Wired",aw.parentDeviceID)}})}})}function c(aq){console.warn("processDevices");$.each(aq,function(at,au){if(au.isAuthority()){l.deviceInfo.routerName=au.friendlyName();l.deviceInfo.modelNumberLabel=symmetryUtil.firmwareUpdate.getRouterModelLabel(au.data);l.deviceInfo.ipAddress=au.data.connections[0].ipAddress;l.deviceInfo.connectionType=RAINIER.network.getCurrentWanType();P=au}else{if(A.nodes&&au.nodeType()==="Slave"){var av=z.length+1,ar=lodash.find(au.connections(),function(aw){return aw.ipAddress});au.data.routerName=au.friendlyName();au.data.modelNumberLabel=symmetryUtil.firmwareUpdate.getRouterModelLabel(au.data);au.data.ipAddress=ar?ar.ipAddress:"Offline";z.push(au)}}});if(A.nodes){k.find("#router-additional-details").html("&nbsp;"+RAINIER.ui.radStrings.nodeCount.format(z.length+1));z=lodash.sortBy(z,function(ar){return ar.isOnline()?0:1})}console.warn("childNodes",z);I(aq);T()}function W(){var aC=l.firmware.updatePolicy!=="Manual"?"on":"off",az=l.qos.isQoSEnabled?"on":"off",aq=l.dmz.isDMZEnabled?"on":"off",ay=l.parentalControl.isParentalControlEnabled?"on":"off",av=l.guestAccess.isGuestNetworkEnabled?"on":"off",aA=l.ftpServerSettings.isEnabled?"on":"off",aw=l.smbServerSettings.isEnabled?"on":"off",ar=l.singlePortForwarding.rules.length,au=l.portForwarding.rules.length,at=l.portTriggering.rules.length,aB=o.sortRules(l.qos.deviceRules,l.qos.applicationRules),ax=0;l.deviceInfo.autoFWUpdateOn=RAINIER.ui.common.strings[aC];l.qos.qosOn=RAINIER.ui.common.strings[az];l.dmz.dmzOn=RAINIER.ui.common.strings[aq];l.parentalControl.pcOn=RAINIER.ui.common.strings[ay];l.guestAccess.gaOn=RAINIER.ui.common.strings[av];l.ftpServerSettings.ftpOn=RAINIER.ui.common.strings[aA];l.smbServerSettings.smbOn=RAINIER.ui.common.strings[aw];if(az==="on"){$.each(aB.high,function(aD){ax=aD+1;if(this.ruleType==="dev"){l.qos["ruleType"+ax]=aa.format(ax)}else{l.qos["ruleType"+ax]=C.format(ax)}l.qos["rule"+ax]=this.rule.description})}else{l.qos.rule1="--";l.qos.rule2="--";l.qos.rule3="--"}if(A.nodes&&ax<3){lodash.range(ax+1,4).forEach(function(aD){l.qos["ruleType"+aD]=aa.format(aD)})}l.portRanges.singleForwardingText=ar;l.portRanges.forwardingText=au;l.portRanges.triggeringText=at;RAINIER.deviceManager.getDevices({cb:c,threshold:-1,doPollForChange:false});if(!x){x=true;RAINIER.ui.hideWaiting()}}function ag(){W();e()}function N(){RAINIER.util.trapEnter(D,function(){var aq=D.val();console.warn("it's happening!",aq);R(aq)});J.keydown(function(ar){var aq=ar.which||ar.keyCode;if([16,17,33,34,35,36,37,38,39,40].contains(aq)||([65,67].contains(aq)&&ar.ctrlKey)){return true}else{return $.cancelEvents(ar)}});ac.find("#button-search").click(function(){R(D.val())});ac.find("#button-top").click(function(){Z()});ac.find("#btn-wifi").click(function(){R("wi-fi development debug information")})}function L(aq,ar){J.blur();if(aq){J.val(aq)}else{if(ar){J.val(l.sysinfo.substr(0,ar))}}J.focus();J.val(l.sysinfo)}function Z(aq){L(" ")}function a(aw,av,ar){var au=av.exec(aw),aq=ar?0:1,at=au&&au.length?au[aq]:j;return at}function H(ar,aq){return a(l.sysinfo,ar,aq)}function R(at){var au=new RegExp(at,"i"),aq=au.exec(l.sysinfo),ar;if(at){Z();if(aq&&aq.length){ar=aq.index;L(null,ar);J[0].setSelectionRange(ar,ar+at.length)}}}function y(){if(A.sysinfo){$.when(am).then(function(){var ar=H(ab,true),at=a(ar,d),au=H(U,true),aq=a(au,d);l.sysData.upTime=H(p);l.sysData.certRegion=H(v);console.warn("sysData",l.sysData);J.val(l.sysinfo);RAINIER.binder.toDom({sysData:l.sysData},k,K);k.find(".wireless-radio").each(function(){var az=$(this),aB=az.data("radioid");if(["RADIO_2.4GHz","RADIO_5GHz"].indexOf(aB)!==-1){var aw=aB==="RADIO_2.4GHz"?G:ae,aG=aB==="RADIO_2.4GHz"?at:aq,aD=H(aw,true),aC=RAINIER.ui.radStrings.noSysinfoData;if(aD!==j){var aE=aD.match(s),aA="None",av=0,aF=[],ay,ax;if(aE&&aE.length){$.each(aE,function(aH,aI){if(aI.indexOf(aG)>-1){av++}aF.push(a(aI,d))});if(aF.length>1){if(lodash.uniq(aF).length>1){aF=lodash.map(lodash.groupBy(aF));if(aF.length>1){aF=aF.sort(function(aI,aH){return aI.length<aH.length});if(aF[0].length>1){ay=aF[0][0]}}}else{ay=aF[0]}console.warn("frequencyArr",aF)}}}if(!ay&&av){ay=aG}if(ay){ay=lodash.padEnd(ay,5,"0");ax=symmetryUtil.wireless.lookupChannelDataByFrequency(ay);aC=ax.channel}az.find(".competing-networks-row > label + label").text(av?av:b);az.find(".most-congested-row > label + label").text(aC)}})})}X=true;ac.find("#spinner-section").hide();ac.find("#report-section").show();g.resolve()}function S(){var aq="/jnap/diagnostics/GetSysinfoData";$.when(am).then(function(){console.warn("calling GetSysinfoData");RAINIER.jnap.send({action:aq,data:{},cb:function(ar){if(ar.result==="OK"){l.sysinfo=ar.output.sysinfo;if(sessionStorage){sessionStorage.setItem("sysInfoData",JSON.stringify(l.sysinfo))}y()}else{if(ar.result==="_AjaxError"){ar.result="ErrorGetFailed"}if(RAINIER.ui.validation.strings.errors[ar.result]){RAINIER.ui.alert("",RAINIER.ui.validation.strings.errors[ar.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(ar,aq)}}},disableDefaultJnapErrHandler:true,timeoutMs:45000})})}function t(){if(sessionStorage&&sessionStorage.getItem("sysInfoData")){var ar,aq=l.deviceInfo.serialNumber;l.sysinfo=JSON.parse(sessionStorage.getItem("sysInfoData"));ar=H(ai);console.warn("getSysinfoData",ar,aq);if(ar!==aq){S()}else{y()}}else{S()}}function af(){if(A.sysinfo){t()}else{y()}N()}function ak(){if(l.wireless.radios.length<3){u.find(".radio52-row").remove()}if(!A.sysinfo){u.find("#sysinfo-tab").remove()}if(!A.healthCheck){k.find("#speed-check-server-row").hide()}if(!A.qos){k.find(".qos-row").hide()}if(!A.nodes){u.find("#router-details-parent-node").remove();k.find("#qos-device-prioritization").remove();k.find("#parent-node-txt").html("&nbsp;")}else{u.find("#router-details-router-name").remove();k.find("#qos-media-prioritization").remove();aa=RAINIER.ui.radStrings.qosNodeDevice}if(!A.storage){k.find(".storage-row").hide()}q=RAINIER.ui.template.createTemplate(u.find("#templateRouterDetailsBlock > *"));an=RAINIER.ui.template.createTemplate(u.find("#templateChildNodesDetailsBlock > *"));O=RAINIER.ui.template.createTemplate(u.find("#templateWirelessRadioBlock > *"));Q=RAINIER.ui.template.createTemplate(u.find("#templateRouterClientsBlock > *"));ag();af();RAINIER.event.fire("applet.loaded")}function aj(){$("#router-clients").empty();l.totalWiredClients=0;l.totalWirelessClients=0;Y=[];ad={routerLabel:"",routerName:"",radio24_label:ad.radio24_label||"",radio5_label:ad.radio5_label||"",radio52_label:ad.radio52_label||"",clientsCount24:0,clientsCount5:0,clientsCount5_2:0,wiredClientsCount:0}}function F(ar){var aq=RAINIER.jnap.Transaction({onComplete:ak});u.find("#refresh-updating").show();u.find("#refresh-updated").hide();u.find("#refresh-button").attr("disabled","disabled");ac.find("#spinner-section").show();ac.find("#report-section").hide();X=false;z=[];if(ar&&A.sysinfo&&sessionStorage){sessionStorage.setItem("sysInfoData",JSON.stringify({}))}aj();$("#router-section").empty();$("#radio-section").empty();am=$.Deferred();m=$.Deferred();g=$.Deferred();$.when(am,m,g).then(function(){u.find("#refresh-updating").hide();u.find("#refresh-updated").show();u.find("#refresh-button").attr("disabled",false);w=setTimeout(function(){u.find("#refresh-updated").hide()},6000)});E(aq);aq.send()}function i(){u.find("#refresh-button").click(function(){if(w!==null){clearTimeout(w);w=null}F(true)})}function n(){if(A.nodes){RAINIER.deviceManager.stopUpdateNodeConnections()}RAINIER.event.disconnect("applet.unloaded",n)}function ah(){RAINIER.ui.showWaiting();o=RAINIER.applets.MediaPrioritization;A.healthCheck=RAINIER.network.isHealthCheckerSupported();A.nodes=RAINIER.network.isBehindNode();A.qos=RAINIER.shared.util.areServicesSupported(o.requiredServices);A.storage=RAINIER.network.storageSupported();A.sysinfo=RAINIER.shared.util.areServicesSupported(["/jnap/diagnostics/Diagnostics3"]);var aq=RAINIER.ui.tabs.init({fireEvents:true,initialTab:$.cookie("initial-tab")});if(A.nodes){RAINIER.deviceManager.updateNodeConnections(function(){aj();RAINIER.deviceManager.getDevices(function(ar){I(ar);B()})})}RAINIER.event.connect("applet.unloaded",n);i();F()}ah()}());