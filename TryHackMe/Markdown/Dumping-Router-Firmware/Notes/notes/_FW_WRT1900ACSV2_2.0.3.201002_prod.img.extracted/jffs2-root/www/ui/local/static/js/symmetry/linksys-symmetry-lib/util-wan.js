(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","./symmetry-jnap","./side-effects-manager"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("./symmetry-jnap"),require("./side-effects-manager"))}else{a.utilWAN=b(a.$,(a.lodash||a._),a.JNAP,a.sideEffectsManager)}}}(this,function(e,v,m,b){var p;var f=5000,o=12,w={},d,l={};function c(x){m.send("/router/GetWANStatus",{},d).success(function(y){if(!y.output||y.output.isDetectingWANType){x(false);return}l=y.output;x(true)}).error(function(){x(false)})}function k(x){if(!x){w.powercycleModem()}else{if(l.wanStatus==="Connected"&&l.wanConnection&&p.ip.notZero(l.wanConnection.ipAddress)){var y=l.wanConnection.ipAddress;if((p.ip.ipInRange(y,"172.16.0.0","172.31.255.255"))||(y.substring(0,7)==="192.168")||(y.substring(0,3)==="10.")){w.connectedBehindRouter()}else{w.connected()}}else{if(((l.wanStatus==="Connected"||l.wanStatus==="Connecting")&&l.detectedWANType!=="DHCP")){w.configurePPPoE()}else{if(l.wanStatus==="Disconnected"){w.cableUnplugged()}else{w.powercycleModem()}}}}}function n(y,x){w.connected=y.connected||e.noop;w.connectedBehindRouter=y.connectedBehindRouter||e.noop;w.configurePPPoE=y.configurePPPoE||e.noop;w.cableUnplugged=y.cableUnplugged||e.noop;w.powercycleModem=y.powercycleModem||e.noop;d=x;b.poll(c,k,o,null,f)}function g(x){if(x.behavior==="ConnectOnDemand"){delete x.reconnectAfterSeconds}else{if(x.behavior==="KeepAlive"){delete x.maxIdleMinutes}}}function h(x){x.networkPrefixLength=p.ip.subnetMaskToPrefixLength(x.subnetMask);delete x.subnetMask;if(v.isEmpty(x.dnsServer2)||x.dnsServer2==="0.0.0.0"){delete x.dnsServer2}if(v.isEmpty(x.dnsServer3)||x.dnsServer3==="0.0.0.0"){delete x.dnsServer3}}function t(x){return x.wanType==="DHCP"}function r(y){var x=y.ipv6AutomaticSettings||y;return v.result(x,"isIPv6AutomaticEnabled",false)}function s(){var x=m.Deferred(),y;m.send("/router/GetWANSettings",{}).success(function(z){y=z.output;if(y.wanType==="Static"){y.staticSettings.subnetMask=p.ip.prefixLengthToSubnetMask(y.staticSettings.networkPrefixLength)}else{if(y.wanType==="PPTP"&&y.tpSettings.useStaticSettings){y.tpSettings.staticSettings.subnetMask=p.ip.prefixLengthToSubnetMask(y.tpSettings.staticSettings.networkPrefixLength)}}if(v.result(y,"wanTaggingSettings.isEnabled")===false||v.result(y,"wanTaggingSettings.vlanTaggingSettings.vlanID")===0){y.wanTaggingSettings.vlanTaggingSettings.vlanID=""}x.resolve(y)}).error(function(z){x.reject(z)});return x}function q(y){var x=v.cloneDeep(v.omit(y,"domainName"));if(m.isServiceSupported("/router/Router10")&&x.wanTaggingSettings){delete x.wanTaggingSettings.vlanLowerLimit;delete x.wanTaggingSettings.vlanUpperLimit}switch(x.wanType){case"Static":h(x.staticSettings);break;case"PPPoE":g(x.pppoeSettings);if(!x.pppoeSettings.serviceName){x.pppoeSettings.serviceName=""}if(!x.pppoeSettings.username){x.pppoeSettings.username=""}if(!x.pppoeSettings.password){x.pppoeSettings.password=""}break;case"PPTP":g(x.tpSettings);if(x.tpSettings.useStaticSettings){h(x.tpSettings.staticSettings)}else{delete x.tpSettings.staticSettings}break;case"L2TP":g(x.tpSettings);x.tpSettings.useStaticSettings=false;break;case"Bridge":if(x.bridgeSettings&&x.bridgeSettings.staticSettings){x.bridgeSettings.useStaticSettings=x.bridgeSettings.staticSettings.ipAddress||false}else{if(x.bridgeSettings){x.bridgeSettings.useStaticSettings=false}else{x.bridgeSettings={useStaticSettings:false}}}break}if(m.isServiceSupported("/router/Router8")){if(x.wanTaggingSettings&&x.wanTaggingSettings.isEnabled){x.wanTaggingSettings=a(x.wanTaggingSettings.vlanTaggingSettings.vlanID)}else{if(x.wanTaggingSettings){x.wanTaggingSettings.isEnabled=false;if(x.wanTaggingSettings.vlanTaggingSettings){delete x.wanTaggingSettings.vlanTaggingSettings}}}}else{delete x.wanTaggingSettings}return x}function i(B,y){var x=m.Deferred(),A=q(B),z=y?y.add:m.send;z("/router/SetWANSettings",A).success(function(){x.resolve(A)}).error(function(C){x.reject(C)});return x}function a(x){return{isEnabled:true,vlanTaggingSettings:{vlanID:parseInt(x,10),vlanPriority:0,vlanStatus:"Tagged"}}}function u(A,y,z){var x=m.Deferred();s().success(function(C){var B={username:A,password:y,serviceName:C.pppoeSettings?C.pppoeSettings.serviceName:"",behavior:"KeepAlive",maxIdleMinutes:1,reconnectAfterSeconds:20};var D={wanType:"PPPoE",mtu:parseInt(C.mtu,10),pppoeSettings:B};if(m.isServiceSupported("/router/Router8")){if(z){D.wanTaggingSettings=a(z)}else{D.wanTaggingSettings={isEnabled:false}}}i(D).success(function(E){x.resolve(E)}).error(function(E){x.reject(E)})}).error(function(B){x.reject(B)});return x}function j(x){b.poll(p.monitors.connectivity.testRouterOnline,x,24,null,f)}return function(x){p=x;return{detectConnected:n,waitToConnect:j,canReleaseRenewIPv4:t,canReleaseRenewIPv6:r,getWANSettings:s,setWANSettings:i,sanitizeWANSettings:q,setPPPoESettings:u}}}));