window.RAINIER=window.RAINIER||{};RAINIER.applets=RAINIER.applets||{};RAINIER.applets.networkmap=RAINIER.applets.networkmap||{};RAINIER.applets.networkmap.Views=(function(){var g={},e=50,f="{0}px";var b=RAINIER.ui.template.createTemplate($("#templateNMDevice > div")),i=RAINIER.ui.template.createTemplate($("#templateBWTotalRow > li")),d=RAINIER.ui.template.createTemplate($("#templateBWReportRow > li")),c=RAINIER.ui.template.createTemplate($("#templatePaging > span"));var a=Backbone.View.extend({id:"#bandwidth-report",tagName:"div",bandwidthCollection:{rawData:{numDevices:0,totals:{totalBytesPerSecond:0,totalMBitsPerSecond:0},sent:{totalBytesPerSecond:0,totalMBitsPerSecond:0},received:{totalBytesPerSecond:0,totalMBitsPerSecond:0}},devices:[]},initialize:function(){this.sortBy="totals";this.addEvents()},addEvents:function(){var j=this;this.$el.on("change",'input[type="radio"]',function(){j.filterBandwidth($(this).val())})},open:function(){var j=this;j.$el.find("#total-bar").empty();j.$el.find(".device-list").empty().addClass("center");$(this.id).find('input[name="filters"]').attr("disabled","disabled");$(this.id).find(".filter-list label").css("color","#CCC");$(this.id).find(".refresh").attr("disabled","disabled");$(this.id).find("#device-usage span span").text("-");RAINIER.ui.spinner.build(".device-list",55).spin(".device-list");RAINIER.applets.devicelist.unfoldSection(j.$el)},showBandwidth:function(k){var j=this;j.bandwidthCollection.devices=[];$(j.id).find("#device-usage span span").text(k.numDevices);j.bandwidthCollection.rawData=$.extend({},k);$.each(k.devices,function(l,m){j.bandwidthCollection.devices.push(m)});$(j.id).find('input[name="filters"]').removeAttr("disabled");$(j.id).find(".filter-list label").css("color","#000");$(j.id).find(".refresh").removeAttr("disabled");j.render()},showAlreadyRunningError:function(){RAINIER.ui.dialogError({result:RAINIER.ui.validation.strings.errors.ErrorStatisticsTrackingStarted})},filterBandwidth:function(j){this.sortBy=j;this.render()},render:function(){var u=this,j=u.bandwidthCollection.rawData,t=u.bandwidthCollection.devices,m=$("<ul>"),o,r,p=$(this.id).find("#total-bar"),n=$(this.id).find(".device-list"),s=$(this.id).find("#infoGlyphText").text(),l=0,k=0,q=2;t.sort(function(y,x){var w=y[u.sortBy].totalBytesPerSec,v=x[u.sortBy].totalBytesPerSec;if(w===v){return 0}else{if(w<v){return 1}else{return -1}}});l=j[u.sortBy].totalBytesPerSecond;k=j[u.sortBy].totalMBitsPerSecond;console.warn(u.sortBy+" - ttlBytesPerSec: "+l+" - ttlMBitsPerSec: "+k);o=RAINIER.ui.template.createBlock(i,{ttlmbitspersecond:j[u.sortBy].totalMBitsPerSecond.toFixed(2)});o.find("#info-glyph").attr("tooltip",s.format(q));$.each(t,function(v,w){if(k>0){w.percentageOfBandwidth=(w[u.sortBy].totalMBitsPerSec/k)*100}else{w.percentageOfBandwidth=0}r=RAINIER.ui.template.createBlock(d,{friendlyName:w.friendlyName(),mbitspersecond:w[u.sortBy].totalMBitsPerSec.toFixed(2)});r.attr("id",w.deviceID());r.find(".name").attr("tooltip",w.friendlyName());r.find(".graph-inner").css("width",w.percentageOfBandwidth+"%");r.find(".device-icon").addClass(RAINIER.ui.getDeviceIcon(w));if(v%2!==0){r.addClass("alt-row")}m.append(r)});$(this.id).find("#total-bar *, .device-list *").fadeOut(300,function(){n.removeClass("center");p.empty().append(o);n.empty().append(m);$(this).fadeIn(300);RAINIER.ui.tooltip.add(p.find("#info-glyph"));RAINIER.ui.tooltip.add(n.find(".name"))})}});var h=Backbone.View.extend({id:"#networkmap-applet",$dialogDeviceAction:null,dialogDeviceAction:null,validationChecks:{},currentDeviceId:null,currentTabId:"online-network",elementIds:{allDevices:"#all-devices",allGuestDevices:"#all-guest-devices",pagePrev:"#page-prev",pageNext:"#page-next",networkFooter:"#network-footer",pagingSummary:"#paging-summary"},events:{"click .refreshButton":"refreshData","click .filter-device":"changeCollectionFilterByClass","click .filter-connection":"changeCollectionFilterByClass","click #page-prev":"changePage","click #page-next":"changePage"},hasFinishedFirstRendering:false,isLocked:true,tabIds:{onlineNetwork:"online-network",guestNetwork:"guest-network"},tagName:"article",_filterClassNames:["filter-type-computer","filter-type-mobile","filter-type-printer","filter-type-other","filter-type-lan","filter-type-wirelessTwo","filter-type-wirelessFive","filter-type-wirelessFive-2","filter-type-offline"],_filterModelNames:["computer","mobile","printer","other","lan","wirelessTwo","wirelessFive","wirelessFive-2","offline"],_geometryForEllipsis:[[191,106],[191,106,676,375],[172,115,780,210,379,427],[172,114,633,95,688,367,180,381],[173,114,536,70,786,236,482,424,76,301],[173,115,464,63,734,149,712,353,355,423,65,279],[172,114,431,62,681,114,779,276,574,409,245,404,61,261],[173,114,378,63,592,82,768,185,726,342,480,424,200,390,61,236],[175,113,361,65,568,77,743,158,769,299,600,402,372,426,138,359,62,223],[173,113,362,66,542,72,727,142,781,269,685,369,515,420,309,417,130,353,62,225],[151,125,291,75,452,62,611,87,745,159,780,276,676,374,503,422,312,418,129,353,61,230],[159,120,292,74,432,62,574,78,709,130,785,229,731,340,593,403,419,426,231,400,97,327,67,210],[176,111,298,73,427,62,561,75,689,119,774,199,766,301,659,381,501,422,327,421,168,377,74,298,76,189],[179,110,292,75,416,62,544,72,670,109,764,180,778,278,690,366,565,412,420,428,264,409,139,359,64,278,73,179],[169,114,282,77,402,61,532,69,649,101,751,165,786,257,720,338,607,395,499,422,371,424,246,404,144,363,69,289,71,190],[112,145,212,97,315,71,422,61,535,71,643,98,734,148,785,227,755,316,657,381,539,415,422,426,313,416,199,377,89,318,50,226]],initialize:function(){var j=this,k="computer,mobile,printer,other,lan,wirelessTwo,wirelessFive,wirelessFive-2",l=$.cookie("smartmap-filter-values");j.isLocked=true;j.collection.excludeAuthorityFromFilter=true;j.collection.clearFilterSet(j.tabIds.onlineNetwork);j.collection.clearFilterSet(j.tabIds.guestNetwork);j.collection.createFilterSet(j.tabIds.guestNetwork,"guest");if(!l){$.cookie("smartmap-filter-values",k,{expires:null,path:"/"});j.collection.createFilterSet(j.tabIds.onlineNetwork,k.split(","))}else{j.collection.createFilterSet(j.tabIds.onlineNetwork,l.split(","))}$.each(j._filterModelNames,function(m,n){if(!RAINIER.applets.networkmap.App.deviceCollection.filterSets["online-network"].contains(n)){j.$(".filter-type-"+n).addClass("disabled")}});j.collection.changeFilters(j.currentTabId)},changeCollectionFilterByClass:function(k){var l=$(k.currentTarget);$.cancelEvents(k);var j="";_.each(this._filterClassNames,function(m){if(l.hasClass(m)){j=this._convertFiltersAndClasses(true,m)}},this);console.warn("changeCollectionFilterByClass",j);if(this.collection.changeFilters(this.currentTabId,j)){this.render();l.toggleClass("disabled")}else{RAINIER.ui.alert(this.$("#filters-disabled-dialog").text())}},changePage:function(l){var j=$(l.currentTarget);$.cancelEvents(l);if(j.hasClass("disabled")){return}var k=j.hasClass("right");if(k){this.collection.paging.pageNumber++}else{this.collection.paging.pageNumber--}this.render()},getCurrentDevice:function(){var j=this.collection.getModelByID(this.currentDeviceId);return j},makeDeviceListEllipsis:function(m,l){m=$(m).empty();if(l.length===0){return}var k=this._geometryForEllipsis[l.length-1],n=0,j=this;$.each(l,function(o,p){j.pinPointToElement(m,j.renderDeviceBasic(p),k[n],k[++n]);n++});if(RAINIER.ui.popmenu.isOpen()){RAINIER.ui.popmenu.checkState()}},pinPointToElement:function(k,l,j,m){k.append(l);l.css({left:f.format(j-e),top:f.format(m-(l.height()/2))})},refreshData:function(){this.collection.fetch({update:true})},render:function(){var k=this.collection.paging,j=this.collection.filteredCollection,o=(k.pageNumber-1)*(k.perPage),l=k.perPage*k.pageNumber;if(this.isLocked){return}if($.isEmptyObject(g)){this.$(".primary-device").click(function(){RAINIER.applets.devicelist.onInfoClick.apply(g.attributes)});RAINIER.ui.tooltip.add(this.$("#filter-toggle"))}g=this.collection.getAuthority();if(j&&j.length>0){if(j.length<l){l=j.length}var q=j.slice(o,l),p=this.currentTabId===this.tabIds.onlineNetwork?this.elementIds.allDevices:this.elementIds.allGuestDevices;if(q.length>0){this.makeDeviceListEllipsis(p,q)}}else{this.$("#all-devices").add("#all-guest-devices").empty()}if(this.currentTabId===this.tabIds.onlineNetwork){this.$("#online-network .network-name").text(g.attributes.friendlyName())}var n=(k.pageNumber>1)?true:false,r=false;if(k.totalPages>1&&k.pageNumber<k.totalPages){r=true}if(n){this.$(this.elementIds.pagePrev).removeClass("disabled")}else{this.$(this.elementIds.pagePrev).addClass("disabled")}if(r){this.$(this.elementIds.pageNext).removeClass("disabled")}else{this.$(this.elementIds.pageNext).addClass("disabled")}if((this.$("#"+this.currentTabId).css("display")==="none")||!(n||r)){this.$(this.elementIds.networkFooter).hide()}else{var m=RAINIER.ui.template.createBlock(c,{currentPage:k.pageNumber,totalPages:k.totalPages});this.$(this.elementIds.pagingSummary).text(m.text());this.$(this.elementIds.networkFooter).show()}this.$("#tab-header-online-network span").text(this.collection.countOnlineDevices);if(RAINIER.applets.devicelist.isGuestAccessEnabled()){this.$("#tab-header-guest-network span").text(this.collection.countGuestDevices);if(!this.collection.countGuestDevices){this.$(".no-guests").show();this.$("#guest-net-label").hide()}else{this.$(".no-guests").hide();this.$("#guest-net-label").show()}}},updateDeviceMenu:function(m,o){var n=m.attributes,k=[{id:"device-info-lnk",action:"RAINIER.applets.networkmap.App.smartmapView.showDeviceInfo",hidden:false}],j={id:"dhcp-edit-reservation-lnk",action:"RAINIER.applets.networkmap.Loader.openDHCPReservationsEditMode",hidden:false},l={id:"dhcp-set-reservation-lnk",action:"RAINIER.applets.networkmap.Loader.reserveDhcpAddress",hidden:false};if(!n.isGuest()){k.push({id:"parental-controls-lnk",action:"RAINIER.applets.networkmap.Loader.openParentalControls",hidden:false});if(RAINIER.applets.dhcpReservations.isDHCPEnabled()){if(RAINIER.applets.dhcpReservations.deviceHasDhcpReservation(n)){k.push(j)}else{if(n.isOnline()){k.push({id:j.id,action:j.action,hidden:true});k.push(l)}else{k.push({id:l.id,action:l.action,hidden:false,greyed:true})}}}}if(_.contains(m.getFilters(),"offline")){k.push({id:"delete-device-lnk",action:"RAINIER.applets.networkmap.App.smartmapView.deleteDevice",hidden:false})}RAINIER.ui.popmenu.updateLnkEvents(o,k)},renderDeviceBasic:function(m){var k=m.attributes,l=m.getConnectionType(),n=RAINIER.ui.template.createBlock(b,{friendlyName:k.friendlyName()}),j=$("#networkmap-applet").find("#actionMenu").clone();n.attr("id",m.id);n.find(".device-connection-type").addClass("connection-{0}".format(l));n.find(".device-icon").addClass(RAINIER.ui.getDeviceIcon(k));n.find("p").attr("tooltip",k.friendlyName());RAINIER.ui.tooltip.add(n.find("p"));if(l.indexOf("wireless")===0){n.find(".device-connection-type").addClass("signal-quartile-{0}".format(m.getSignalQuartile()))}if(_.contains(m.getFilters(),"offline")){n.addClass("offline")}RAINIER.ui.popmenu.add(n,"side",j,RAINIER.applets.networkmap.App.smartmapView.updateDeviceMenu.curry(m,n));return n},setCurrentTabId:function(j){if(j!==this.currentTabId){this.collection.changeFilters(j)}this.currentTabId=j;this.render()},updateTabs:function(){if(this.currentTabId==="online-network"){RAINIER.applets.networkmap.App.smartmapView.setCurrentTabId("online-network")}else{RAINIER.applets.networkmap.App.smartmapView.setCurrentTabId("guest-network")}},showDeviceInfo:function(k){var j=RAINIER.applets.networkmap.Loader.getDeviceFromElem(k);RAINIER.applets.devicelist.onInfoClick.apply(j.attributes)},deleteDevice:function(k){var j=RAINIER.applets.networkmap.Loader.getDeviceFromElem(k);RAINIER.applets.devicelist.onDeviceDelete.apply(j.attributes)},resetState:function(){g={}},setLockState:function(j){this.isLocked=j},_convertFiltersAndClasses:function(l,k){var j;if(l){j=this._filterModelNames[_.indexOf(this._filterClassNames,k)]}else{j=this._filterClassNames[_.indexOf(this._filterModelNames,k)]}return j}});return{smartmapView:h,bandwidthView:a}}());