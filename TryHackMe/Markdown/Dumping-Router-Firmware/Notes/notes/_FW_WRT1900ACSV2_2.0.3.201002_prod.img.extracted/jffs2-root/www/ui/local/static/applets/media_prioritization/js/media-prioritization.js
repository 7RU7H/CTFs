(function(){var s,N="urn:cisco-com:ui:qos-order",j="not set";var Q={type:{device:"device",application:"application",onlineGame:"onlineGame"},priority:{low:"Low",normal:"Normal",medium:"Medium",high:"High"},trafficType:{background:"Background",generic:"Generic",voice:"Voice",video:"Video"}};var C={portRangeError:RAINIER.ui.validation.strings.security.portRangeError,portRangesOverlapSameApp:RAINIER.ui.validation.strings.mediaPrioritization.portRangeOverlapsWithThisApplication,portRangesOverlapOtherApp:RAINIER.ui.validation.strings.mediaPrioritization.portRangeOverlapsWithAnotherApplication,errorAppExists:RAINIER.ui.validation.strings.errors.ErrorApplicationExists,confirmDeleteApp:RAINIER.ui.strings.mediaPrioritization.confirmDeleteApplication,TCP:RAINIER.ui.common.strings.ipProtocol.TCP,UDP:RAINIER.ui.common.strings.ipProtocol.UDP,Both:RAINIER.ui.common.strings.ipProtocol.BothTCPAndUDP};var w=$("#media-pri-applet"),F=$("#isQoSEnabled"),o=w.find("#high-priority-group"),U=o.find(".list"),S=w.find("#normal-priority-group"),ab=S.find("#normal-priority-devices"),Y=S.find("#app-header"),e=Y.find("a.edit"),A=Y.find("a.delete"),I=S.find("#app-devices-container"),f=I.find("#app-devices"),G=I.find("select"),b=S.find("#game-header"),M=b.find("a.edit"),H=b.find("a.delete"),n=S.find("#game-devices-container"),O=n.find("#game-devices"),P=n.find("select");var g=w.find("#device-templates").html(),h=w.find(".option-templates .empty").outerHtml();var m={high:"high",device:"device",application:"application",game:"game"};var d="online-game",B="application",p="urn:cisco-com:ui:qos";var E={"QoSSettings.isBandwidthAuto":"boolean","QoSSettings.isQoSEnabled":"boolean","WLANQoSSettings.isWMMEnabled":"boolean","WLANQoSSettings.isWirelessAcknowledgementDisabled":"boolean","QoSSettings.downstreamBandwidthbps":"number","QoSSettings.upstreamBandwidthbps":"number"},r={QoSSettings:{}},c={QoSSettings:{}};var Z={setQoS:function V(ae,af,ad){ae.add({action:"/jnap/qos/SetQoSSettings",data:af,cb:function(ag){if(ag.result==="OK"){if(ad){ad()}}else{console.warn("SetQoSSettings: o.output is empty. Terminating...error:"+ag.error+" result: "+ag.result)}}})},setWLANQoSSettings:function X(ae,af,ad){ae.add({action:"/jnap/qos/SetWLANQoSSettings",data:af,cb:function(ag){if(ag.result==="OK"){if(ad){ad()}}else{console.warn("SetWLANQoSSettings: o.output is empty. Terminating...error:"+ag.error+" result: "+ag.result)}}})},resetQoS:function a(ad){var ae={isQoSEnabled:false,isQoSAutoPrioritizingEnabled:c.QoSSettings.isQoSAutoPrioritizingEnabled,upstreamBandwidthbps:0,downstreamBandwidthbps:0,deviceRules:[],applicationRules:[]};var af={isWMMEnabled:true,isWirelessAcknowledgementEnabled:true};function ag(){RAINIER.deviceManager.getAuthorityDevice(function(ai){ai.removeCustomProperty(N);ai.removeCustomProperty("lastBandwidthCalibrationDate");ai.removeCustomProperty("bandwidthSpeedSetBy")});var ah=RAINIER.jnap.Transaction({onComplete:ad});Z.setQoS(ah,ae);Z.setWLANQoSSettings(ah,af);ah.send()}RAINIER.deviceManager.getDevices({threshold:-1,exclusions:{excludeAuthority:true,excludeNodes:true},cb:function(ah){var aj=[],ai=0;$.each(ah,function(){if(!this.isGuest()&&!RAINIER.util.isNoE(this.getCustomProperty(p))){aj.push(this)}});if(aj.length>0){ai=aj.length;$.each(aj,function(){console.warn(['Clearing "{0}" property from {1}'.format(p,this.friendlyName())]);this.removeCustomProperty(p,function(){ai--;if(ai===0){ag()}})})}else{ag()}}})}};U.data({list:m.high});ab.data({list:m.device});f.data({list:m.application});O.data({list:m.game});function y(ad,ag,ah,ae){ae=!!ae;var af=ad.find('option[value="'+ag.value+'"]');if(!af.length&&ah){af=ad.find('option[value="'+ah+'"]')}if(!af.length){ad.find("option:last").before($("<option></option>").data(ag).prop("value",ag.value).text(ag.description));if(!ae){ad.find('option[value="'+ag.value+'"]').prop("selected","selected");ad.change()}}else{af.prop("value",ag.value);af.text(ag.description);af.data(ag);if(!ae){af.prop("selected","selected");ad.change()}}}function i(ad,af){var ae=ad.find('option[value="'+af+'"]');ad.val("none");if(ae.length){ae.remove()}ad.change()}function t(ae,ai){var ah=ae.value,ag='li:[name="'+ah+'"]'+(ai?',li:[name="'+ai+'"]':""),ad=U.add(f).add(O).find(ag),af;ad.each(function(aj,ak){af=$(ak);af.attr("name",ah);af.find("h3").text(unescape(ah));af.data(ae)})}function T(ae,ad){var af=false;U.find("li").each(function(ag,ah){if(ae===$(ah).data("description")){af=true}});if(ad){$.each([G,P],function(ag,ah){if(ah.find('option[value="'+escape(ae)+'"]').length){af=true}})}return af}function L(ad){if(!ad.hasOwnProperty("lastPort")||ad.lastPort===""){ad.lastPort=ad.firstPort}}function v(ae){for(var ad=0;ad<ae.length;ad++){for(var af=0;af<ae[ad].portRanges.length;af++){L(ae[ad].portRanges[af])}}}var q=(function(){var al=false,av;U.find("li").each(function(){$(this).data({mediaType:Q.type.device})});ab.find("li").each(function(){$(this).data({mediaType:Q.type.device})});f.find("li").each(function(){$(this).data({mediaType:Q.type.application})});O.find("li").each(function(){$(this).data({mediaType:Q.type.onlineGame})});var ag="disabled";var aq,ai;function aj(aw){S.toggleClass(ag,!aw);o.toggleClass(ag,!aw);G.prop(ag,!aw);P.prop(ag,!aw);w.find("#drag-n-drop-arrows").toggleClass(ag,!aw);at(aw);ad(aw);au(aw);RAINIER.ui.shield.toggle(w.find(".bucket"),!aw);w.find(".ui-sortable").sortable("refresh")}function ak(aw){o.toggleClass(ag,!aw);U.sortable(aw?"enable":"disable");U.sortable("refresh")}function at(aw){ab.toggleClass(ag,!aw);ab.sortable(aw?"enable":"disable");ab.sortable("refresh")}function ad(aw){Y.toggleClass(ag,!aw);G.prop(ag,!aw);f.toggleClass(ag,!aw);f.sortable(aw?"enable":"disable");f.sortable("refresh")}function au(aw){b.toggleClass(ag,!aw);P.prop(ag,!aw);O.toggleClass(ag,!aw);O.sortable(aw?"enable":"disable");O.sortable("refresh")}function af(aw){o.toggleClass("highlight",aw===m.high);ab.toggleClass("highlight",aw===m.device);f.toggleClass("highlight",aw===m.application);O.toggleClass("highlight",aw===m.game)}F.change(function(){var aw=F.is(":checked");c.QoSSettings.isQoSEnabled=aw;aj(aw)});function ah(ay,az){var ax=$(this),aw=$(az.item);al=true;av=$(".ui-sortable-helper");aw.data("sourceList",ax.data("list"))}function ae(az,aA){if(!F.is(":checked")){return}var ay=$(this),aB=ay.data("list"),ax=$(aA.item),aw=ax.data("mediaType");S.removeClass(ag);o.removeClass(ag);switch(aB){case m.high:ak(true);break;case m.device:at(aw===Q.type.device);break;case m.application:ad(aw===Q.type.application);break;case m.game:au(aw===Q.type.onlineGame);break}}function an(az,aB){var ay=$(this),aC=ay.data("list"),ax=$(aB.item),aA=ax.data(),aw=aA.mediaType;if(aw===Q.type.application){if(aC===m.application){G.val(aA.value);G.change()}}else{if(aw===Q.type.onlineGame){if(aC===m.game){P.val(aA.value);G.change()}}else{if(aw===Q.type.device){aA.userPrioritized=true;ax.data(aA)}}}}function am(){var aw=U.find("li");al=false;av.removeClass("invalid");av=null;af("none");function ax(az,ay){if(ay===Q.type.application){f.empty();f.prepend(az);G.val(az.data("value"))}else{if(ay===Q.type.onlineGame){O.empty();O.prepend(az);P.val(az.data("value"))}}}if(aw.length<3&&aq){U.append(aq)}else{if(aq){ax(aq,ai)}}f.removeClass("active");O.removeClass("active");$(".list li").each(function(ay,az){az.removeAttribute("style")});aq=null;ai=null;aj(true)}function ap(aA,aC){var az=$(this),aD=az.data("list"),ay=U.find("li"),ax=$(aC.item),aB=ax.data(),aw=aB.mediaType;af(aD);if(ay.length<3&&aq){U.append(aq);aq=null;ai=null}if(aw===Q.type.application){if(aD===m.application){if(f.children.length>1){f.find("li:not(.ui-sortable-placeholder)").remove()}}}else{if(aw===Q.type.onlineGame){if(aD===m.game){if(O.children.length>1){O.find("li:not(.ui-sortable-placeholder)").remove()}}}}}function ar(az,aA){var ay=$(this),aC=ay.data("list"),ax=U.find("li"),aw=$(aA.item),aB=aw.data("sourceList");if(aB!==m.high||aC!==m.high){if(ax.length>3){if(!aq){aq=U.find("li:not(.ui-sortable-placeholder):last");ai=aq.data("mediaType")}if(ai===Q.type.device){ab.prepend(aq)}else{if(ai===Q.type.application){aq=aq.detach()}else{if(ai===Q.type.onlineGame){aq=aq.detach()}}}}}}function ao(){w.find(".ui-sortable").sortable({containment:"article#media-pri-applet > section",activeClass:"ui-state-hover",hoverClass:"ui-state-active",tolerance:"intersect",revert:true,connectWith:"ul.list",start:ah,activate:ae,stop:am,over:ap,receive:an,sort:ar});w.find(".ui-sortable").disableSelection();f.sortable("option","cursorAt",{right:10});f.sortable("refresh");O.sortable("option","cursorAt",{right:10});O.sortable("refresh")}return{init:ao}}());var D=$("#reset-media-pri"),x=$("#edit-media-pri-settings"),R,k;var K=(function(){var ai=w.find("#custom-application-dialog"),ao=ai.find("#portRanges-list"),ak=RAINIER.ui.buildInputValidBalloon,al=RAINIER.ui.validation.tests,ae={},aA={validationType:"utf8LengthTooLong",whiteSpace:true,isRequired:true},ay={validCharSet:"numeric",minLen:0,minVal:1,maxVal:65535,whiteSpace:false,isBlankOkOnBlur:true},ah,av,at,ad,am;function ax(aE,aC){var aD=aE.val(),aB;if(aD===""&&aC===""){return true}else{if($.isNumeric(aD)&&$.isNumeric(aC)){aD=parseInt(aD,10);aB=parseInt(aC,10);if(aD<=aB){return true}}}return false}function an(aF,aB){var aD=aF.find('input:[name="firstPort"]'),aC=aF.find('input:[name="lastPort"]'),aE={};aE.firstPort=ak($.extend(true,{},ay,{isRequired:(aB===0),els:aD,group:"media"}));aE.lastPort=ak($.extend(true,{},ay,{isRequired:(aB===0),els:aC,errors:[{test:ax.curry(aD),when:false,message:C.portRangeError}],group:"media"}));aF.data({checks:aE})}function aw(){aA.maxLen=r.QoSSettings.maxDescriptionLength;ae.name=ak($.extend(true,{},aA,{els:ai.find('input:[name="description"]'),group:"media"}));ae.rangesOverlapp=RAINIER.ui.inputBalloon.add({isComposite:true,els:ai.find('input:[name="firstPort"], input:[name="lastPort"]'),elContainer:ai.find('input:[name="description"]'),errors:[{test:function(){return false},when:true,message:""}],isRequired:false})}function ag(aB){while(aB.length<3){aB.push({protocol:"Both",firstPort:"",lastPort:""})}}function aq(aB){for(var aC=aB.length-1;aC>=0;aC--){if(aB[aC].firstPort===""){aB[aC].firstPort=-1}L(aB[aC]);aB[aC].firstPort=parseInt(aB[aC].firstPort,10);aB[aC].lastPort=parseInt(aB[aC].lastPort,10);aB[aC].rowIndex=aC+1;if(aB[aC].firstPort===-1&&aB[aC].lastPort===-1){aB.splice(aC,1)}}}function az(aE,aD,aC){var aB;ah=aC;at=aD;ad=aE;av={};aa.refreshStoreFromDom();ai.removeClass("add-app edit-app add-game edit-game").addClass(aE+"-"+aD);if(aE==="edit"){aB=aC.find(":selected").data();if(!aB.portRanges){return}}else{aB={id:"",description:"",portRanges:[]}}ag(aB.portRanges);av=$.extend({},aB);ao.empty();RAINIER.binder.toDom(aB,ai,E);RAINIER.binder.toDom(aB,$("#application-template"),E,ao);RAINIER.ui.validation.removeInvalidMarks(ai);RAINIER.ui.inputBalloon.reset("media");$("#portRanges-list tr").each(function(aF,aG){an($(aG),aF)});am.show()}function af(aC){var aB=aC.data("checks");return aB.firstPort.isValid(true)&&aB.lastPort.isValid(true)}function ar(){var aB=ae.name.isValid(true),aH,aM=0,aF,aC,aG,aI,aD;if(aB){$("#portRanges-list tr").each(function(aN,aO){aM=aN;aB=af($(aO));if(!aB){return aB}})}if(aB){$("#custom-application-dialog").each(function(aN,aO){if($(aO).parents("dialog-cache").length===0){aH=$(aO)}});aF=RAINIER.binder.fromDom(aH,E);if(ad!=="edit"||av.description!==aF.description){if(T(aF.description,true)){ae.name.message({"class":"icon warning",message:C.errorAppExists});aB=false}}}if(aB){aC=aF.portRanges||[];aq(aC);for(aG=0,aI=aC.length;aG<aI;aG++){for(aD=aG+1;aD<aI;aD++){if(aD!==aG&&aB){if(!((aC[aG].protocol==="UDP"&&aC[aD].protocol==="TCP")||(aC[aG].protocol==="TCP"&&aC[aD].protocol==="UDP"))){if(al.doesRangeOverlap(aC[aG].firstPort,aC[aG].lastPort,aC[aD].firstPort,aC[aD].lastPort)){ae.rangesOverlapp.elContainer=$("#portRanges-list tr:nth-of-type("+aC[aG].rowIndex+")");ae.rangesOverlapp.message({"class":"icon warning",message:C.portRangesOverlapSameApp.format(aC[aD].firstPort,aC[aD].lastPort,C[aC[aD].protocol])});aB=false;break}}}}}}if(aB){var aE=c.QoSSettings.applicationRules,aL=[],aK,aJ;for(aG=0;aG<aE.length;aG++){if(ad==="add"||av.description!==aE[aG].description){for(aD=0;aD<aE[aG].portRanges.length;aD++){aK=aE[aG].portRanges[aD];aL.push({first:aK.firstPort,last:aK.lastPort||aK.firstPort,protocol:aK.protocol,description:aE[aG].description})}}}for(aG=0,aI=aC.length;aG<aI;aG++){if(al.doPortRangesOverlap(aL,aC[aG].firstPort,aC[aG].lastPort,aC[aG].protocol)){aJ=al.doPortRangesOverlap.conflict.range;ae.rangesOverlapp.elContainer=$("#portRanges-list tr:nth-of-type("+aC[aG].rowIndex+")");ae.rangesOverlapp.message({"class":"icon warning",message:C.portRangesOverlapOtherApp.format(RAINIER.util.htmlEncode(aJ.description),aJ.first,aJ.last||aJ.first,C[aJ.protocol])});aB=false;break}}}if(aB){for(aG=0,aI=aC.length;aG<aI;aG++){delete aC[aG].rowIndex}}return aB?aF:false}function ap(){var aB=ar();if(aB){aB.id=aB.description;aB.value=escape(aB.description);y(ah,aB,escape(av.description),ad==="edit");t(aB,av.value);am.close();ah="";at="";ad="";av={}}}function aj(){if(ad!=="edit"){ah.val("none")}ah="";at="";ad="";av={}}function au(){am=RAINIER.ui.dialog(ai,{onSubmit:ap,onCancel:aj,cancelClose:true});ai.find("div.close-button").unbind("click");ai.find("div.close-button").click(function(){aj();am.close()});aw()}return{init:au,show:az}}());var J=(function(){var an=$("#bandwidth-dialog"),ap=RAINIER.ui.buildInputValidBalloon,ad=an.find('input:[name="QoSSettings.downstreamBandwidth"]'),am=an.find('input:[name="QoSSettings.upstreamBandwidth"]'),ah={},ae="",ak={whiteSpace:false,isRequired:true,maxLen:7},af;function ag(){function av(ax){if($.isNumeric(ax)){var aw=parseInt(ax,10);return(aw===0||(aw>=1&&aw<=2000))}else{return false}}ah.downstreamBandwidth=ap($.extend(true,{},ak,{els:ad,errors:[{test:av,when:false,message:function(){return RAINIER.util.outOfRangeMessage(1,2000)}}]}));ah.upstreamBandwidth=ap($.extend(true,{},ak,{els:am,errors:[{test:av,when:false,message:function(){return RAINIER.util.outOfRangeMessage(1,2000)}}]}))}function au(){var av=true,aw=true;av=ah.downstreamBandwidth.isValid(true);aw=ah.upstreamBandwidth.isValid(true);if(av&&aw){RAINIER.ui.validation.removeInvalidMarks(an)}return av&&aw}function ai(){var av=$("#bandwidth-dialog");var aw=$.extend(true,{},c)||{};aw.QoSSettings.downstreamBandwidth=(aw.QoSSettings.downstreamBandwidthbps/s.Mb).toFixed(2);aw.QoSSettings.upstreamBandwidth=(aw.QoSSettings.upstreamBandwidthbps/s.Mb).toFixed(2);delete aw.QoSSettings.downstreamBandwidthbps;delete aw.QoSSettings.upstreamBandwidthbps;RAINIER.binder.toDom(aw,av,E)}function aj(){var av=$("#bandwidth-dialog");$.extend(true,c,RAINIER.binder.fromDom(av,E));c.QoSSettings.downstreamBandwidthbps=c.QoSSettings.downstreamBandwidth*s.Mb;c.QoSSettings.upstreamBandwidthbps=c.QoSSettings.upstreamBandwidth*s.Mb;delete c.QoSSettings.downstreamBandwidth;delete c.QoSSettings.upstreamBandwidth}function ao(){ai();af.show()}function al(){if(au()){aj();j=ae==="Manual"?"userDefined":"auto";u();af.close()}}function at(){ai();RAINIER.ui.validation.removeInvalidMarks(an);RAINIER.ui.inputBalloon.hide()}function ar(){var aw=$("#bandwidth-dialog"),av=aw.find("#speed-test-content"),ax=aw.find("#manual-speed-content");RAINIER.deviceManager.getAuthorityDevice(function(ay){_deviceAuthority=ay;if(ay.getCustomProperty("bandwidthSpeedSetBy")==="userDefined"){ae="Manual";av.hide()}else{ae="SpeedTest";ax.hide()}})}function aq(){var ax=$("#bandwidth-dialog"),av=ax.find("#speed-test-content"),az=ax.find("#manual-speed-content"),ay=ax.find("#run-speed-test"),aw=ax.find("#run-speed-test, #manual-speed a, .cancel, .submit");ar();ag();af=RAINIER.ui.dialog(ax,{cancelClose:true,onClose:at,onSubmit:al});ax.find("div.close-button").unbind("click").click(function(){at();af.close()});ax.find("#speed-test").unbind("click").click(function(){at();av.show();az.hide();ae="Auto"});ax.find("#manual-speed a").unbind("click").click(function(){if(!$(this).hasClass("disabled")){at();av.hide();az.show();ae="Manual"}});ay.unbind("click").click(function(){aw.prop("disabled",true).addClass("disabled");ax.addClass("running");l({skipLastCheck:true,cb:function(){ax.removeClass("running");aw.prop("disabled",false).removeClass("disabled");J.toDom()}})})}return{init:aq,toDom:ai,fromDom:aj,isValid:au,show:ao}}());var z=(function(){var ak=$("#settings-dialog"),ad=ak.find('input:[name="QoSSettings.downstreamBandwidth"]'),am=RAINIER.ui.buildInputValidBalloon,ae={},ai={validCharSet:"numeric",whiteSpace:false,isRequired:true,maxLen:7},an;function af(){function ar(au){if($.isNumeric(au)){var at=parseInt(au,10);return(at===0||(at>=500&&at<=2000000))}else{return false}}ae.downstreamBandwidth=am($.extend(true,{},ai,{els:ad,errors:[{test:ar,when:false,message:function(){return RAINIER.util.outOfRangeMessage(500,2000000)}}]}))}function aq(){var ar=true;ar=ae.downstreamBandwidth.isValid(true);if(ar){RAINIER.ui.validation.removeInvalidMarks(ak)}return ar}function ag(){var ar=$("#settings-dialog");var at=$.extend(true,{},c)||{};at.QoSSettings.downstreamBandwidth=parseInt(at.QoSSettings.downstreamBandwidthbps/s.Kb,10);at.WLANQoSSettings.isWirelessAcknowledgementDisabled=!at.WLANQoSSettings.isWirelessAcknowledgementEnabled;delete at.QoSSettings.downstreamBandwidthbps;delete at.WLANQoSSettings.isWirelessAcknowledgementEnabled;RAINIER.binder.toDom(at,ar,E)}function ah(){var ar=$("#settings-dialog");$.extend(true,c,RAINIER.binder.fromDom(ar,E));c.QoSSettings.downstreamBandwidthbps=c.QoSSettings.downstreamBandwidth*s.Kb;c.WLANQoSSettings.isWirelessAcknowledgementEnabled=!c.WLANQoSSettings.isWirelessAcknowledgementDisabled;delete c.QoSSettings.downstreamBandwidth;delete c.WLANQoSSettings.isWirelessAcknowledgementDisabled}function al(){ag();an.show()}function aj(){if(aq()){ah();an.close()}}function ap(){ag()}function ao(){var ar=$("#settings-dialog");af();an=RAINIER.ui.dialog(ar,{cancelClose:true,onClose:ap,onSubmit:aj});ar.find("div.close-button").unbind("click");ar.find("div.close-button").click(function(){ap();an.close()})}return{init:ao,toDom:ag,fromDom:ah,isValid:aq,show:al}}());var aa=(function(){var ae={};function al(){U.empty();ab.empty();f.empty();O.empty()}function am(aC,aB){$.each(aB,function(){aC.append($(h.formatObj(this)))})}function av(){G.empty();G.append($(w.find(".option-templates .select-app").clone(true)));am(G,s.applicationStaticList);G.append($(w.find(".option-templates .add-new-app").clone(true)));aa.enableAppLinks(false)}function at(){P.empty();P.append($(w.find(".option-templates .select-game").clone(true)));am(P,s.gameStaticList);P.append($(w.find(".option-templates .add-new-game").clone(true)));aa.enableGameLinks(false)}function aw(aC){var aB=I.find("select");aC.value=escape(aC.description);y(aB,aC,undefined,true)}function ah(){var aB;al();v(c.QoSSettings.applicationRules);av();at();var aE=s.sortRules(c.QoSSettings.deviceRules,c.QoSSettings.applicationRules),aD={};function aC(aG,aF){if(aG==="dev"){aD[aF.macAddress]=true}}$.each(aE.high,function(aF){var aG=this.rule;aC(this.ruleType,aG);aB=s.getMediaData(this.ruleType,aG,false);s.buildLi(g,U,aB);if(aB.isUserDefined){aw(aB)}if(this.ruleType==="app"){$.each(r.QoSSettings.applicationRules,function(){if(this.description===aG.description){this.order=aF;return false}})}else{$.each(r.QoSSettings.deviceRules,function(){if(this.macAddress===aG.macAddress){this.order=aF;return false}})}});$.each(r.devices,function(aF,aJ){var aI=aJ.knownMACAddresses(),aG;for(var aH=0;aH<aI.length;aH++){if(aD[aI[aH]]){aG=true}}if(!aG){s.buildLi(g,ab,{macAddress:aI[0],icon:RAINIER.ui.getDeviceIcon(aJ),description:aJ.friendlyName(),value:escape(aJ.friendlyName()),mediaType:Q.type.device})}})}function ad(aB,aD){for(var aC=0;aC<aB.length;aC++){aB[aC].priority=aD}return aB}function ao(){RAINIER.ui.showWaiting();Z.resetQoS(ap)}function ap(){var aB=RAINIER.jnap.Transaction({onComplete:function(){ac();RAINIER.event.fire("connection.applets.mediaPrioritization.change");RAINIER.event.fire("connection.applets.mediaPrioritization.reset");RAINIER.ui.hideWaiting()}});Z.getQoS(aB,function(aC){r.QoSSettings=$.extend(true,{},aC);c.QoSSettings=$.extend(true,{},aC)});Z.getWLANQoSSettings(aB,function(aC){r.WLANQoSSettings=$.extend(true,{},aC);c.WLANQoSSettings=$.extend(true,{},aC)});aB.send()}function af(){R=RAINIER.ui.dialog($("#confirm-reset-dialog"),{onSubmit:function(){if(!F.is(":checked")){F.prop("checked",true);F.change()}ao()}});k=RAINIER.ui.dialog($("#confirm-delete-dialog"),{onSubmit:function(){var aD=k.elSelect.find("option:selected").prop("value"),aC=U.add(f).add(O).find('li:[name="'+aD+'"]');if(aC&&aC.length&&aC.hide){aC.hide(500,function(){aC.detach();aC.remove()})}i(k.elSelect,aD)}});var aB=k.show;k.show=function(aC){var aE=aC.find("option:selected").data(),aD=$("#confirm-delete-dialog");k.elSelect=aC;aD.find(".del-app").toggle(aE.mediaType===Q.type.application);aD.find(".del-game").toggle(aE.mediaType===Q.type.onlineGame);aD.find("#message").html(C.confirmDeleteApp.format(aE.description));aB()}}function aA(aB){e.toggleClass("disabled",!aB);e.unbind("click");A.toggleClass("disabled",!aB);A.unbind("click");Y.find("span").toggleClass("disabled",!aB);if(aB){e.click(function(){K.show("edit","app",G)});A.click(function(){k.show(G,Q.type.application)})}}function aq(aB){M.unbind("click");M.toggleClass("disabled",!aB);H.unbind("click");H.toggleClass("disabled",!aB);b.find("span").toggleClass("disabled",!aB);if(aB){M.click(function(){K.show("edit","game",P)});H.click(function(){k.show(P,Q.type.onlineGame)})}}function an(){D.click(R.show);x.click(z.show);w.find("#showWidget").bind("click",function(){RAINIER.connect.AppletManager.toggleWidgetShowState(s.appletId,s.widgetId)})}function ax(){ae.appConflict=RAINIER.ui.inputBalloon.add({isComposite:true,els:G,elContainer:G,errors:[{test:function(){return false},when:true,message:""}],isRequired:false})}function ag(){RAINIER.ui.MainMenu.closeApplet()}function ay(){var aB=[],aD=[];function aC(aF,aM,aH,aI,aG){var aK=$(aM),aL=aK.data(),aJ=aL.macAddress;aD.push({description:aK.data("description"),macAddress:aJ,trafficType:aH,priority:aI,userPrioritized:aG,order:aF})}function aE(aF,aK,aG,aH){var aI=$(aK),aJ=aI.data();if(!aJ){console.warn(["addAppRule","data does not exist","data:",aJ])}else{if(!aJ.portRanges){console.warn(["addAppRule","data.portRanges does not exist","data:",aJ])}}aB.push({description:aI.data("description"),portRanges:ad(aJ.portRanges,aH),trafficType:aG,order:aF})}U.find("li").each(function(aF,aI){var aH=$(this).data("mediaType"),aG=Q.trafficType.video;switch(aH){case Q.type.device:aC(aF,aI,aG,Q.priority.high,!!$(this).data("userPrioritized"));break;case Q.type.onlineGame:case Q.type.application:aE(aF,aI,aG,Q.priority.high);break;default:console.warn("app didn't get saved in the high pri list because the mediaType was unknown")}});c.QoSSettings.applicationRules=$.extend(true,[],aB);c.QoSSettings.deviceRules=$.extend(true,[],aD)}function aj(){$.extend(true,c,RAINIER.binder.fromDom($("#media-pri-applet section"),E));z.fromDom();if(RAINIER.network.isHealthCheckerSupported()){J.fromDom()}else{delete c.QoSSettings.upstreamBandwidth}delete c.QoSSettings.bandwidthUnit;delete c.QoSSettings.isBandwidthAuto;ay()}function az(){$.delAttr(r.QoSSettings,"maxDescriptionLength","maxApplicationRules","maxPortRanges","maxDeviceRules");$.delAttr(c,"devices");$.delAttr(c.QoSSettings,"maxDescriptionLength","maxApplicationRules","maxPortRanges","maxDeviceRules")}function ar(){var aC={};aj();az();$.each(r.QoSSettings.deviceRules,function(){aC=this;$.each(c.QoSSettings.deviceRules,function(){if(aC.macAddress===this.macAddress){this.description=aC.description;if(!RAINIER.util.isNoE(this.userPrioritized)){aC.userPrioritized=this.userPrioritized}return false}})});if(!$.compare(r.QoSSettings,c.QoSSettings)||!$.compare(r.WLANQoSSettings,c.WLANQoSSettings)){var aB={apps:[],devices:[]};RAINIER.ui.showWaiting();$.each(c.QoSSettings.deviceRules,function(aD){aB.devices[aD]={macAddress:this.macAddress,order:this.order};delete this.order;if(this.userPrioritized){RAINIER.deviceManager.getDeviceByMACAddress({macAddress:this.macAddress,cb:function(aE){aE.setCustomProperty(p,"userPrioritized")}})}delete this.userPrioritized});$.each(c.QoSSettings.applicationRules,function(aD){aB.apps[aD]={name:this.description,order:this.order};delete this.order});console.warn(["sortOrder:",aB]);RAINIER.deviceManager.getAuthorityDevice(function(aD){aD.setCustomProperty(N,JSON.stringify(aB),function(){var aE=RAINIER.jnap.Transaction({onComplete:function(aG){if(aG&&aG.responses){var aH=true;for(var aF=0;aF<aG.responses.length;aF++){if(aG.responses[aF].result!=="OK"){aH=false}}RAINIER.ui.hideWaiting();if(aH){RAINIER.event.fire("connection.applets.mediaPrioritization.change");ag()}}}});aD.setCustomProperty("bandwidthSpeedSetBy",j);Z.setQoS(aE,c.QoSSettings,function(){$.extend(true,r.QoSSettings,c.QoSSettings)});Z.setWLANQoSSettings(aE,c.WLANQoSSettings,function(){$.extend(true,r.WLANQoSSettings,c.WLANQoSSettings)});aE.send()})})}else{ag()}}function ai(aF,aI,aN,aO,aK){var aD=RAINIER.ui.validation.tests,aP=[],aE,aM,aC,aJ,aL,aB=true;aI.empty();if(this.value==="AddNew"){K.show("add",(aN===Q.type.onlineGame?"game":"app"),aF)}else{if(this.value!=="none"){aE=aO[unescape(this.value)];if(!aE){if($(this).find(":selected").length){aE=$(this).find(":selected").data();aL=true}}if(aE){aC=aE.portRanges||[];U.find("li").each(function(){var aQ=$(this).data();if(aQ.description!==aE.description){if(aQ.mediaType===Q.type.application||aQ.mediaType===Q.type.onlineGame){for(var aR=0;aR<aQ.portRanges.length;aR++){aM=aQ.portRanges[aR];aP.push({first:aM.firstPort,last:aM.lastPort||aM.firstPort,protocol:aM.protocol,description:aQ.description})}}}});for(var aG=0,aH=aC.length;aG<aH;aG++){if(aD.doPortRangesOverlap(aP,aC[aG].firstPort,aC[aG].lastPort,aC[aG].protocol)){aJ=aD.doPortRangesOverlap.conflict.range;ae.appConflict.elContainer=aF;ae.appConflict.message({"class":"icon warning",message:C.portRangesOverlapOtherApp.format(RAINIER.util.htmlEncode(aJ.description),aJ.first,aJ.last||aJ.first,C[aJ.protocol])});aB=false;break}}if(aB&&!T(aE.description)){aE.mediaType=aN;aE.icon=aK;aE.value=this.value;s.buildLi(g,aI,aE)}}if(aB){RAINIER.ui.inputBalloon.hide()}}else{if(this.value==="none"){aI.empty()}}}if(aN===Q.type.onlineGame){aq(aE&&aL)}else{aA(aE&&aL)}}function ak(){G.change(ai.curry(G,f,Q.type.application,s.applicationStaticList,B));P.change(ai.curry(P,O,Q.type.onlineGame,s.gameStaticList,d));ah()}function au(){af();an();ax()}return{init:au,populate:ak,refreshStoreFromDom:aj,enableAppLinks:aA,enableGameLinks:aq,scrubData:az,save:ar,close:ag}}());function ac(){F.prop("checked",c.QoSSettings.isQoSEnabled);F.change();w.find("#showWidget").prop("checked",RAINIER.connect.AppletManager.getWidgetShowState(s.appletId,s.widgetId));aa.populate();z.toDom();if(RAINIER.network.isHealthCheckerSupported()){J.toDom();u()}U.sortable("refresh")}function u(){var ad;w.find("#speed-result .speed-test-complete").html(RAINIER.ui.strings.mediaPrioritization.speedTestResult.formatObj({downloadSpeed:(c.QoSSettings.downstreamBandwidthbps/s.Mb).toFixed(2),uploadSpeed:(c.QoSSettings.upstreamBandwidthbps/s.Mb).toFixed(2)}));ad=$("#speed-result a");ad.unbind("click");ad.click(J.show)}function W(ad){s=ad;if(!RAINIER.shared.util.areServicesSupported(s.requiredServices)){RAINIER.event.fire("applet.unsupportedFirmware");return}$.extend(true,Z,s.jnap);s.load(function(af){r=af;$.extend(true,c,r);K.init();ac();RAINIER.event.fire("applet.loaded")});setTimeout(function ae(){RAINIER.network.checkInternetConnection(function(af){if(af){if(RAINIER.network.isHealthCheckerSupported()){w.find(".embedded-speedtest-supported").show();w.find("#settings-download-bandwidth").hide();l({autoSave:true,cb:J.toDom})}else{if(!RAINIER.network.isAuthorityRemote()){OOKLA.check_bandwidth_calibration(function(ag){if(c&&c.QoSSettings){c.QoSSettings.downstreamBandwidthbps=ag.output.downstreamBandwidthbps}})}}}});aa.init();q.init();z.init();J.init();RAINIER.ui.placeholders.init();w.find("footer .cancel").click(aa.close);w.find("footer .submit").click(aa.save)},0)}function l(ae){ae=ae||{};var aj,ad=w.find("#speed-result"),ai=(typeof ae.cb==="function")?ae.cb:$.noop;function af(ak){var am=new Date(),al=ak.output.healthCheckResults[0].speedTestResult;r.QoSSettings.downstreamBandwidthbps=al.downloadBandwidth*s.Kb;r.QoSSettings.upstreamBandwidthbps=al.uploadBandwidth*s.Kb;c.QoSSettings.downstreamBandwidthbps=r.QoSSettings.downstreamBandwidthbps;c.QoSSettings.upstreamBandwidthbps=r.QoSSettings.upstreamBandwidthbps;aa.scrubData();ad.removeClass("running");if(ae.autoSave){RAINIER.jnap.send({action:"/jnap/qos/SetQoSSettings",data:r.QoSSettings,cb:function(an){aj.setCustomProperty("lastBandwidthCalibrationDate",am.getTime().toString());aj.setCustomProperty("bandwidthSpeedSetBy","auto");u();ai()},disableDefaultAjaxErrHandler:true,disableDefaultJnapErrHandler:true,disableDefaultRebootErrHandler:true})}else{ai()}}function ah(ak){if(ak.allStepsDone&&c&&c.QoSSettings){setTimeout(function(){symmetryUtil.monitors.healthCheck.getResults("SpeedTest",1).success(af)},5000)}}function ag(ak){if(ak==="ErrorHealthCheckAlreadyRunning"){symmetryUtil.monitors.healthCheck.stop().success(function(){setTimeout(function(){symmetryUtil.monitors.healthCheck.start("SpeedTest",ah,$.noop,{timeout:35000,retry:1})},3000)})}}RAINIER.deviceManager.getAuthorityDevice(function(ak){aj=ak;if(!ak.getCustomProperty("lastBandwidthCalibrationDate")||ak.getCustomProperty("lastBandwidthCalibrationDate").length===0||ae.skipLastCheck){w.find("#speed-result").addClass("running");symmetryUtil.monitors.healthCheck.start("SpeedTest",ah,ag,{timeout:35000,retry:1})}})}W(RAINIER.applets.MediaPrioritization)}());