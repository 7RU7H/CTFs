(function(){var w=RAINIER.applets.USBStorage,e=$("#external-storage-applet"),g=RAINIER.ui.template.createTemplate(e.find("#template-drive-info > section")),D=RAINIER.ui.template.createTemplate(e.find("#template-partition-info > div")),h=RAINIER.ui.template.createTemplate(e.find("#template-unsupported-partition-info > div")),u=RAINIER.ui.template.createTemplate(e.find("#template-drive-ejected > section")),m=RAINIER.ui.template.createTemplate(e.find("#template-no-drives > section")),r="96015299-6364-4ABE-A68E-969E5BE093E9",B="0482141A-5B9F-42E0-B980-A48EA914BC27",q=true,x=true,o=0;var a={};var s={storageCapabilities:{},storageNodes:[],smbServerSettings:{}};var j={smbServerSettings:{}};var n={"smbServerSettings.secureAccessEnabled":"boolean"};var b={onToggleWidget:function(){RAINIER.connect.AppletManager.toggleWidgetShowState(r,B)},onClose:function(){RAINIER.ui.MainMenu.closeApplet()},onApply:function(){A(false)},onSave:function(){A(true)},onSaveComplete:function(){RAINIER.ui.hideWaiting();if(x){if(q){b.onClose()}}}};function A(G){var F=false;q=G||false;x=true;if(c()){F=true;if(v()){l()}}if(q&&!F){b.onClose()}}function c(){i();if(!$.compare(j.smbServerSettings,s.smbServerSettings)){return true}return false}function v(){var F=true;if(F){F=a.username.isValid(true)}if(F){F=a.password.isValid(true)}return F}function t(){var G=RAINIER.ui.buildInputValidBalloon,F={validCharSet:"storageUserName",minLen:1,maxLen:12,whiteSpace:false,isRequired:false},H={validCharSet:"alpha",minLen:4,maxLen:64,whiteSpace:false,isRequired:false};a.username=G($.extend(true,{},F,{els:e.find("#smb-username")}));a.password=G($.extend(true,{},H,{els:e.find("#smb-password")}))}function E(){var F=0;e.find("#drive-list").empty();$.each(s.storageNodes,function(G,H){$.each(H.storageDevices,function(I,K){var J=RAINIER.ui.template.createBlock(g,H,{});if(K.partitionTableFormat==="Unsupported"){J.find(".drive-slide-window div.partition-list").append(RAINIER.ui.template.createBlock(h,{},{}))}else{$.each(K.partitions,function(L,N){var M,O=N.usedKB+N.availableKB;if(N.fileSystem==="Unsupported"){M=RAINIER.ui.template.createBlock(h,N,{})}else{M=RAINIER.ui.template.createBlock(D,N,{});if(s.storageCapabilities.supportedReadOnlyFileSystems.indexOf(N.fileSystem)>-1){M.find(".partition-read-only-icon").show()}M.find("progress").attr("max",O).attr("value",N.usedKB);if(N.usedKB/O>0.95){M.find("progress").addClass("high-usage")}M.find(".storageInfo").text(M.find(".storageInfo").text().replace("{storageUsed}",w.humanFileSize(N.usedKB*1024)).replace("{storageAvailable}",w.humanFileSize(O*1024)))}J.find(".drive-slide-window div.partition-list").append(M)})}J.find(".eject-button").on("click",function(M,L){z.call(this,M,L);return false}.bind(J,H.deviceID,K.deviceName));e.find("#drive-list").append(J);F++})});if(F===0){e.find("#drive-list").append(RAINIER.ui.template.createBlock(m,{},{}))}}function d(){E();RAINIER.binder.toDom(s,e,n)}function i(){var F=RAINIER.binder.fromDom(e,n);j.smbServerSettings=$.extend(true,{},s.smbServerSettings,F.smbServerSettings);if(!j.smbServerSettings.username){delete j.smbServerSettings.username}if(!j.smbServerSettings.password){delete j.smbServerSettings.password}j.smbServerSettings.isAnonymousAccessEnabled=!j.smbServerSettings.secureAccessEnabled}function p(F){deviceManager.getDevices(true,true).success(function(){var G=RAINIER.jnap.Transaction({onComplete:F});G.add({action:"/jnap/nodes/storage/GetStorageCapabilities",data:{},cb:function(H){if(H.result==="OK"){s.storageCapabilities=H.output}}});G.add({action:"/jnap/nodes/storage/GetSMBServerSettings",data:{},cb:function(H){if(H.result==="OK"){s.smbServerSettings=H.output;s.smbServerSettings.secureAccessEnabled=!H.output.isAnonymousAccessEnabled;j.smbServerSettings=$.extend(true,{},s.smbServerSettings)}}});G.add({action:"/jnap/nodes/storage/GetNodesPartitions",data:{},cb:function(I){var H;if(I.result==="OK"){s.storageNodes=I.output.storageNodes;$.each(s.storageNodes,function(J,K){K.deviceName=deviceManager.getDeviceByID(K.deviceID).deviceName;K.ipAddress=deviceManager.getDeviceByID(K.deviceID).connections[0].ipAddress});H=deviceManager.nodes.getMaster();s.storageNodes.sort(function(K,J){return K.deviceID===H.deviceID?-1:J.deviceID===H.deviceID?1:0})}}});G.send()})}function l(){RAINIER.ui.showWaiting();delete j.smbServerSettings.secureAccessEnabled;RAINIER.jnap.send({action:"/jnap/nodes/storage/SetSMBServerSettings",data:j.smbServerSettings,cb:function(F){if(F.result==="OK"){s.smbServerSettings=$.extend(true,{},s.smbServerSettings,j.smbServerSettings);s.smbServerSettings.secureAccessEnabled=!j.smbServerSettings.isAnonymousAccessEnabled}else{x=false}k()}})}function k(){if(x){d();b.onSaveComplete()}}function z(J,I){var F=RAINIER.ui.template.createBlock(u,{},{}),H=this;function G(K){RAINIER.jnap.send({action:"/jnap/nodes/storage/GetNodesPartitions",data:{},cb:function(M){var L=false;if(M&&M.result==="OK"){L=M.output.storageNodes.filter(function(N){return N.deviceID===J&&N.storageDevices.some(function(O){return O.deviceName===I})}).length>0;if(L){if(K>=1){setTimeout(function(){G(--K)},5000)}else{RAINIER.ui.hideWaiting()}}else{RAINIER.ui.hideWaiting();H.slideUp(function(){H.remove()});F.insertAfter(H).slideDown().delay(5000).slideUp(function(){var N=e.find("#drive-list");F.remove();if(N.children().length===0){N.append(RAINIER.ui.template.createBlock(m,{},{}))}});RAINIER.event.fire("externalstorage.updated")}}}})}RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/nodes/storage/RemoveStorageDevice",data:{deviceID:J,storageDeviceName:I},cb:function(K){if(K&&(K.result==="OK"||K.result==="ErrorUnknownStorageDevice")){G(6)}else{RAINIER.ui.hideWaiting();if(!K||K.result!=="_AjaxError"){RAINIER.ajax().executeDefaultJnapErrorHandler(K,action)}}},disableDefaultJnapErrHandler:true})}function f(F){var G="/jnap/nodes/storage/RefreshStorageDevices";if(!F){RAINIER.ui.showWaiting()}RAINIER.jnap.send({action:G,data:{},cb:function(H){if(H&&H.result==="OK"){setTimeout(function(){p(function(){E();if(!F){RAINIER.ui.hideWaiting()}RAINIER.event.fire("externalstorage.updated")})},5000)}else{RAINIER.ajax().executeDefaultJnapErrorHandler(H,G)}}})}function C(){e.find("#refresh-drive-list").on("click",function(){f()});d()}function y(){RAINIER.ui.placeholders.init();RAINIER.ui.initPasswordReveal(e.find("#smb-password"));p(function(){C();RAINIER.event.fire("applet.loaded")});t();e.find("#cbAddWidget").attr("checked",RAINIER.connect.AppletManager.getWidgetShowState(r,B));e.find("footer .cancel").click(b.onClose);e.find("footer .submit").click(b.onSave);e.find("footer .apply").click(b.onApply);e.find("#cbAddWidget").click(b.onToggleWidget);o=setInterval(function(){f(true)},120000);RAINIER.event.connect("applet.unloaded",F);function F(){clearInterval(o);RAINIER.event.disconnect("applet.unloaded",F)}}y()}());