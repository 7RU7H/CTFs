(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","jnap-js/jnap"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("@linksys/jnap-js").JNAP)}else{a.cacheManager=b(a.$,(a.lodash||a._),a.JNAP)}}}(this,function(g,n,i){var d="",c;var o={"/router/SetLANSettings":["/router/GetLANSettings"],"/wirelessap/SetRadioSettings":["/wirelessap/GetRadioInfo"]};function k(r){if(r){delete i.cache.data[r]}else{g.each(i.cache.data,function(s){delete i.cache.data[s]})}if(d){b(d)}}function p(s){if(!s){throw"You need to pass a serialNumber to loadCache, or things will break"}if(s!==d){var r=JSON.parse(localStorage.getItem("dataCache"));i.cache.data=r&&r[s]||{};d=s}if(n.size(i.cache.data)===0){return false}return true}function b(s){var r=JSON.parse(localStorage.getItem("dataCache"))||{};r[s]=i.cache.data;localStorage.setItem("dataCache",JSON.stringify(r))}function j(s){s=s||d;var r=JSON.parse(localStorage.getItem("dataCache"));return r[s]}function f(){var r=JSON.parse(localStorage.getItem("dataCache"));return r}window.getCache=j;function q(s){var r={supportedForCaching:{"/core/GetDeviceInfo":true},defaultCacheExpirationTime:120000,cacheSettings:{},disableCacheClearing:false};i.setOptions(r);c=s;i.cache={load:p,save:b,get:j,getAll:f,clear:k,data:{}}}function a(r){return r.replace(i.getOptions().baseUrl,"")}function m(v,r,u,t){var s;var w;if(!t){for(s=0;s<v.length;s++){w=a(v[s].action);if(w==="/core/GetDeviceInfo"){t=r.responses[s].output.serialNumber}}}for(s=0;s<v.length;s++){w=a(v[s].action);if(u[w]&&t){i.cache.data[w]=r.responses[s];i.cache.data[w].cachedAt=Date.now()}}}function h(u,y,r){var z=i.getOptions(),s=z.cacheSettings,v=z.appCaching,x=z.defaultCacheExpirationTime,w=s[u]&&s[u].useOnStartup||true,t=s[u]&&s[u].expirationTime||x;y=y||{};r=r||{};if(y[u]&&v==="forceCache"||!n.isEmpty(r)){return r[u]?r[u]:y[u]}else{if(v==="refreshCache"||!y[u]||!y[u].cachedAt||Date.now()-y[u].cachedAt>t&&!(v==="useCache"&&w)){return null}else{return y[u]}}}function l(w,r,t,u){var x,z={result:"OK",responses:[]};var y=false;for(x=0;x<w.length;x++){var v=a(w[x].action);if(t[v]){var s=h(v,t,u);if(!s){y=true}}if(!r[v]||!t[v]||y){return null}z.responses.push(t[v])}return z}function e(t,u,A,x){A=A||{};if(A.serialNumber&&!A.cacheOverrides){p(A.serialNumber)}var r=i.getOptions(A).supportedForCaching;var z=n.result(A,"cacheOverrides")?A.cacheOverrides:i.cache.data;var s=null;var v=[];if(!i.getOptions(A).disableCacheClearing){v=o[t]}if(t==="/core/Transaction"){s=l(x,r,z,A.cacheOverrides)}else{if(r[t]){s=h(t,z,A.cacheOverrides)}}if(s){if(window.DEBUG){}var y=i.Deferred();s.fromCache=true;y.resolve(s);return y}var w=i.actionSupportedByRouter(t,A);return c(w,u,A).success(function(B){if(v){console.warn("[ cacheManager - clearing cache: "+v+" ]");v.forEach(function(D){k(D)})}if(!n.result(A,"cacheOverrides")){var C=A.serialNumber;if(t==="/core/GetDeviceInfo"&&r[t]){C=B.output.serialNumber;p(C)}else{if(i.cache.data["/core/GetDeviceInfo"]){C=i.cache.data["/core/GetDeviceInfo"].output.serialNumber}}if(r[t]&&C){i.cache.data[t]=B;i.cache.data[t].cachedAt=Date.now()}if(t==="/core/Transaction"){m(x,B,r,C)}if(C){b(C)}}})}return{init:q,send:e}}));