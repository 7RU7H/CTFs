RAINIER.connect=RAINIER.connect||{};RAINIER.connect.widgetManager=(function(){var e=[],k=[],g=0,c=false,d=false;var i="6B749D0D-1E3B-4C2A-B0CE-D19EDA0225AC";function a(){function n(s){var t=RAINIER.connect.AppletManager.getAppletById(s.appletId);if(t){if(!t.widgets){t.widgets={}}t.widgets[s.widgetId]=s}}var r=[],q=0,p=0,o;for(q=0;q<k.length;q++){for(p=0;p<e.length;p++){if(e[p]&&k[q].widgetId===e[p].widgetId){r.push(e[p]);e[p]=null}}if(k[q].appletId){n(k[q])}}for(q=0;q<e.length;q++){o=e[q];if(o){if(o.prependedIfNew){r.splice(g,0,o)}else{r.push(o)}n({widgetId:o.widgetId,appletId:o.appletId,show:true})}}e=r}function f(n){return{widgetPreferences:{widgetPreference:n,displayFeedback:c}}}function b(o,p){var n=[],r;for(var s=0;s<o.length;s++){r=o[s];if(!r.appletId){n.push({widgetId:r.widgetId,show:true})}else{n.push(RAINIER.connect.AppletManager.getAppletById(r.appletId).widgets[r.widgetId])}for(var q=0;q<p.length;q++){if(p[q].widgetId===r.widgetId){p.splice(q,1);break}}}p=n.concat(p);if(RAINIER.network.uiLoadedFromCloud()){RAINIER.cloud.send({url:"/cloud/storage-service/rest/maps/user-preference/entry?networkId="+RAINIER.network.getCurrentNetworkID(),type:"POST",data:f(p),cb:function(){},cbError:function(){return true}})}else{if(localStorage){localStorage.setItem("widgetPreferences",JSON.stringify(p))}}}function h(){var u=$("#widget-container"),H=$("#widget-shield"),y=$(".templates").find("#widget").get(0),r=false,s=2,C=0,B=0,G=275+30,n=130+60,x=document.getElementById("cache"),F=$("#placeholder"),z=$("body"),A,v;RAINIER.connect.widgetManager.handleWidgetShowChange=D;function D(M){var K=0,J,L=false;if(M.show){for(K=0;K<e.length;K++){if(M.widgetId===e[K].widgetId){J=e[K];e.splice(K,1);break}}for(K=0;K<e.length;K++){if(!e[K].fixed&&!RAINIER.connect.AppletManager.getWidgetShowState(e[K].appletId,e[K].widgetId)){e.splice(K,0,J);L=true;break}}if(!L){e.push(J)}E(J)}else{$("."+M.widgetId).remove();for(K=0;K<e.length;K++){if(M.widgetId===e[K].widgetId){J=e[K];J.coord=null;e.splice(K,1);e.push(J);break}}}o();b(e,k)}function E(J){J.root=J.url.substring(0,J.url.lastIndexOf("/"));var N=y.cloneNode(true),L="url({root}/{widgetIcon})".formatObj({root:J.root.replace(/dynamic/,"static"),widgetIcon:J.widgetIcon}),M=$(N),O=M.find(".widget-header"),K;N.url=J.url;if(J.wide){M.addClass("wide")}if(J.fixed){O.html(J.title);O.removeClass("widget-header");O.addClass("widget-header-fixed")}else{O.html('<div class="close-button"></div>'+J.title);K=M.find(".close-button");K.mousedown(function(){r=true});K.mouseup(function(){RAINIER.connect.AppletManager.toggleWidgetShowState(J.appletId,J.widgetId);r=false})}O.css("background-image",L);M.find(".widget-content").load(J.url,function(){RAINIER.ui.fixCustomControls(M.find(".widget-content"))});J.nd=N;J.el=M;M.addClass(J.widgetId);u.get(0).appendChild(N)}function q(){e.forEach(function(J){if(!J.appletId||RAINIER.connect.AppletManager.getWidgetShowState(J.appletId,J.widgetId)){E(J)}})}function t(J){if(r){return}J=J||window.event;var K;A=$(this);if(!A.hasClass("widget")&&$(this.parentNode.parentNode).hasClass("widget")){A=$(this.parentNode.parentNode)}else{z.removeClass("widget-drag")}v=A.get(0);z.toggleClass("widget-drag",J.which===1);if(J.which===1){A.addClass("drag");K=A.parent().offset();C=((J.offsetX===undefined)?J.layerX:J.offsetX)+K.left;B=((J.offsetY===undefined)?J.layerY:J.offsetY)+K.top;z.bind("mousemove.widget-drag",w);z.bind("mouseup.widget-drag",p);$("#widget-shield").bind("mousemove.widget-drag",w);$("#widget-shield").bind("mouseup.widget-drag",p);document.body.focus();A.parent().append(F);F.css(A.position()).toggleClass("wide",A.hasClass("wide"));return false}}$("div.widget-header").live("mousedown",t);function w(O){if(r){return}var K=-1,P=-1,N;O=O||window.event;if(A&&A.css){A.css({left:window.scrollX+O.clientX-C,top:window.scrollY+O.clientY-B})}K=I({left:O.pageX,top:O.pageY});if(K!==-1){N=e[K];for(P=0;P<e.length;P++){if(v===e[P].nd){break}}if(K!==P&&!N.fixed){if(N.el.hasClass("wide")&&!A.hasClass("wide")){var M=A.innerWidth(),L=N.coords.left,J=O.clientX;if(J>L+M){return}}e[K]=e.splice(P,1,N)[0];o()}}}function p(){if(r){return}z.unbind("mousemove.widget-drag",w).unbind("mouseup.widget-drag",p).removeClass("widget-drag");$("#widget-shield").unbind("mousemove.widget-drag",w);$("#widget-shield").unbind("mouseup.widget-drag",p);A.css(F.position()).addClass("highlight").removeClass("drag");o();var J=A;A=null;setTimeout(function(){J.removeClass("highlight")},400);x.appendChild(u[0].removeChild(F.get(0)));for(var K=0;K<e.length;K++){e[K].drag=undefined}b(e,k)}function I(M){var L=-1,N,J;for(var K=0;K<e.length;K++){J=e[K];if(!J.drag&&!J.fixed&&RAINIER.connect.AppletManager.getWidgetShowState(J.appletId,J.widgetId)){N=J.coords;if(N.top<M.top&&M.top<N.bottom&&N.left<M.left&&M.left<N.right){L=K;break}}}return L}function o(){var R=[],K=0,S=0,J,P,N,O,M;function Q(W,T){var V=false,U=0;for(U=0;U<R.length;U++){if(R[U]===""&&!T){R[U]=W;V=true;break}}if(!V){U=R.length;if(!T){R.push(W)}else{if(U%s+2>s){R.push("");U++}R.push(W+":left");R.push(W+":right")}}S=Math.floor(U/s);K=U%s}for(var L=0;L<e.length;L++){P=e[L];if(P.appletId){if(!RAINIER.connect.AppletManager.getWidgetShowState(P.appletId,P.widgetId)){continue}}Q(P.url,P.wide);J=P.el;N={left:(K*G),top:(S*n)};if(J.hasClass("drag")){F.css(N);P.coords={top:N.top,bottom:N.top+J.innerHeight(),left:N.left,right:N.left+J.innerWidth()}}else{J.css(N);O=J.offset();P.coords={top:O.top,bottom:O.top+J.innerHeight(),left:O.left,right:O.left+J.innerWidth()}}}M=(S+1)*n;if(M<500){M=500}u.css("height",M);H.css("height",M)}q();o();b(e,k)}function m(p){var n=[];try{n=p.widgetPreferences.widgetPreference;if(!$.isArray(n)){throw"array expected"}}catch(o){return[]}return n}function l(){var n=[];var p=RAINIER.taskmanager({parallel:true,callback:function(){var q=null;if(!k.length){e.sort(function(t,s){return t.defaultOrder>s.defaultOrder})}n.sort(function(t,s){return t.defaultOrder>s.defaultOrder});for(var r=0;r<n.length;r++){q=n[r];e.splice(q.defaultOrder-1,0,q);g++}a();h();RAINIER.event.fire("applet.widgetsSetup")}});p.add(function(){var q=this;$.ajax({url:RAINIER.shared.util.uniqueURL("/ui/dynamic/config.json"),dataType:"json",success:function(r){if(r&&r.widgets){r.widgets.forEach(function(s){if(!s.remoteOnly||RAINIER.network.uiLoadedFromCloud()){n.push(s)}})}q.completed()},error:q.failed})});if(RAINIER.network.uiLoadedFromCloud()){p.add(function(){var q=this;RAINIER.cloud.send({url:"/cloud/storage-service/rest/maps/user-preference/entry?networkId="+RAINIER.network.getCurrentNetworkID(),type:"GET",cb:function(r){k=m(r);if(!(RAINIER.browser.ieVersion>-1&&RAINIER.browser.ieVersion<=8)&&r.widgetPreferences.displayFeedback){c=r.widgetPreferences.displayFeedback;$("#feedback-survey-link").show()}q.completed()},cbError:function(r){k=[];q.completed();return true}})})}else{if(localStorage&&localStorage.getItem("widgetPreferences")){k=JSON.parse(localStorage.getItem("widgetPreferences"))}}var o=RAINIER.connect.AppletManager.getAppletList();o.forEach(function(r){var q=r.url.substring(0,r.url.lastIndexOf("/"));p.add(function(){var s=this;$.ajax({url:RAINIER.shared.util.uniqueURL("{0}/config.json".format(q)),dataType:"json",success:function(t){if(t&&t.widgets){t.widgets.forEach(function(u){console.warn("applet",!r.isAppletDisabled&&(!d||r.appletId!==i),r);if(!r.isAppletDisabled&&(!d||r.appletId!==i)){e.push(u)}})}s.completed()},error:s.failed})})});if(RAINIER.network.isNetworkSecuritySupported()){RAINIER.applets.ParentalControls.isShieldSubscriptionActive(function(q){d=q;console.warn("isShieldSubscriptionActive",d);p()})}else{p()}}function j(p,o){if(RAINIER.network.isBehindNode()&&p.velop){var n=_.find(p.velop.widgets,{widgetId:o.widgetId});_.extend(o,n)}}return{setupWidgets:l,saveWidgetPreferences:b}}());