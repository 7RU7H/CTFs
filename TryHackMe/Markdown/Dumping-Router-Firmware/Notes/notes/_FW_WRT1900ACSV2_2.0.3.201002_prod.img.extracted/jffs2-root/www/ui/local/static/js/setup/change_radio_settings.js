RAINIER.timeSettings={};RAINIER.guestSettings={radio:{}};RAINIER.INVALID_HOST_NAME_CHARACTER_REPLACEMENT="-";RAINIER.MAX_HOST_NAME_LENGTH=15;RAINIER.CHECK_FOR_LAN_BREAK_INTERVAL=5000;RAINIER.CHECK_FOR_LAN_BREAK_MAX_RETRIES=12;RAINIER.ROUTER_RESTART_INTERVAL=5000;RAINIER.ROUTER_RESTART_MAX_RETRIES=8;RAINIER.DEFAULT_SECURITY_TYPE="WPA-Mixed-Personal";RAINIER.ALT_SECURITY_TYPE="WPA2-Personal";var isGuestNetwork3Supported=false,settingsNotChanged=false,securityType=RAINIER.DEFAULT_SECURITY_TYPE,radiosCollapsed=false,radioInfo={},radio24GHz,radio5GHz;function goToNextPage(){RAINIER.shared.util.deleteCookie("radioSettingsChanged");RAINIER.setup.goToVerifiedPage("change_router_password")}function addNewRadioSetting(c,a,d){var b={radioID:a.radioID,settings:RAINIER.shared.util.clone(a.settings)};b.settings.ssid=(a.band==="5GHz")?d.ssid5Ghz:d.ssid;b.settings.wpaPersonalSettings=b.settings.wpaPersonalSettings||{};b.settings.wpaPersonalSettings.passphrase=(a.band==="5GHz")?d.password5GHz:d.password;b.settings.security=securityType;c.push(b)}function saveRadioSettingsInCookie(b){if(!b){b={ssid:radio24GHz.settings.ssid,password:radio24GHz.settings.wpaPersonalSettings.passphrase};if(radio5GHz){b.ssid5Ghz=radio5GHz.settings.ssid;b.password5GHz=radio5GHz.settings.wpaPersonalSettings.passphrase}}for(var a=0;a<getRadioCount();a++){var c=[];addNewRadioSetting(c,getRadioByIndex(a),b);c[0].band=getRadioByIndex(a).band;saveWirelessSsid(c[0]);saveWirelessPassword(c[0])}if(isBandSteeringSupported()){RAINIER.shared.util.setCookie("bandSteeringMode",(isTriBandSteeringSupported()&&radiosCollapsed)?"TriBand":"Basic",null,"/")}}function saveRadioSettings(d,c){var b=[];for(var a=0;a<getRadioCount();a++){addNewRadioSetting(b,getRadioByIndex(a),d)}var e={radios:b};if(isBandSteeringSupported()){e.isBandSteeringEnabled=true;e.bandSteeringMode=isTriBandSteeringSupported()&&radiosCollapsed?"TriBand":"Basic"}c.add({action:RAINIER.jnapActions.setRadioSettings(),data:e,cb:function(f){if(f.result==="OK"){}else{if(f.result!=="_AjaxError"&&f.result!=="_ErrorAbortedAction"){if(f.result==="ErrorInvalidSSID"){showInputValidationError("ssidInputValidation",true,RAINIER.setup.ui.inputInvalid)}else{if(f.result==="ErrorInvalidPassphrase"){showInputValidationError("passwordInputValidation",true,RAINIER.setup.ui.inputInvalid)}else{RAINIER.executeDefaultJnapErrorHandler(f)}}showView("landing")}}}})}function getHostNameFromSsid(b){var e="",a;for(a=0;a<b.length;a++){if(e.length>=RAINIER.MAX_HOST_NAME_LENGTH){break}else{if(e.length===0){if(/[a-zA-Z]/.test(b.charAt(a))){e=b.charAt(a)}}else{var d=b.charAt(a);if(/[a-zA-Z0-9-]/.test(d)){e=e.concat(d)}else{e=e.concat(RAINIER.INVALID_HOST_NAME_CHARACTER_REPLACEMENT)}}}}for(a=e.length-1;a>=0;a--){if(e.charAt(a)!==RAINIER.INVALID_HOST_NAME_CHARACTER_REPLACEMENT){break}}e=e.slice(0,a+1);return e}function saveLanSettings(c,a){var d=getHostNameFromSsid(c);if(d.length>0){var b={ipAddress:RAINIER.lanSettings.ipAddress,networkPrefixLength:RAINIER.lanSettings.networkPrefixLength,hostName:d,isDHCPEnabled:RAINIER.lanSettings.isDHCPEnabled,dhcpSettings:RAINIER.lanSettings.dhcpSettings};a.add({action:"/jnap/router/SetLANSettings",data:b,cb:function(e){if(e.result==="OK"){}else{if(e.result!=="_AjaxError"&&e.result!=="_ErrorAbortedAction"){if(e.result==="ErrorInvalidHostName"){showInputValidationError("ssidInputValidation",true,RAINIER.setup.ui.inputInvalid);showView("landing")}else{RAINIER.executeDefaultJnapErrorHandler(e)}}}}})}}function saveRouterProperties(c,b){var d=RAINIER.shared.util.getCookie("hasInternet")==="true"?"true":"false",a=[{name:"setupState",value:"wifiReconnect"},{name:"hasInternet",value:d},{name:"userDeviceName",value:c}];RAINIER.setup.addRouterPropertiesInTransaction(b,a,null,function(e){RAINIER.executeDefaultJnapErrorHandler(e)})}function saveTimeZoneSettings(c){var f=new Date(),a=f.getTimezoneOffset(),g=false,b=null,e,d;for(d=0;d<12;d++){f.setMonth(d,1);e=f.getTimezoneOffset();if(e!==a){g=true;if(e>a){a=e;break}}}b=lodash.find(RAINIER.timeSettings.supportedTimeZones,{utcOffsetMinutes:-a,observesDST:g});if(b&&b.timeZoneID!==RAINIER.timeSettings.timeZoneID){var h={timeZoneID:b.timeZoneID,autoAdjustForDST:b.observesDST};c.add({action:"/jnap/locale/SetTimeSettings",data:h,cb:function(i){if(i.result==="OK"){}else{if(i.result!=="_AjaxError"&&i.result!=="_ErrorAbortedAction"){RAINIER.executeDefaultJnapErrorHandler(i)}}}})}}function generateGuestPassword(){var a=Math.floor(Math.random()*RAINIER.setup.ui.guestpassword.strings.length);var b=RAINIER.setup.ui.guestpassword.strings[a];b+=Math.floor(Math.random()*10);b+=Math.floor(Math.random()*10);b=b.replace(/{/gi,"");b=b.replace(/}/gi,"");return b}function setGuestNetworkSettings(a,d,g,b){var c=generateGuestPassword();var f="/jnap/guestnetwork/SetGuestNetworkSettings",e={isGuestNetworkEnabled:true,broadcastGuestSSID:true,guestSSID:d,guestPassword:c,maxSimultaneousGuests:a.maxSimultaneousGuests};if(isGuestNetwork3Supported){f="/jnap/guestnetwork/SetGuestRadioSettings";e={isGuestNetworkEnabled:true,maxSimultaneousGuests:a.maxSimultaneousGuests,radios:[{radioID:"RADIO_2.4GHz",isEnabled:a.radio.band24.isEnabled,broadcastGuestSSID:a.radio.band24.isEnabled,guestSSID:d,guestPassword:c}]};if(radio5GHz){e.radios.push({radioID:"RADIO_5GHz",isEnabled:a.radio.band50.isEnabled,broadcastGuestSSID:a.radio.band50.isEnabled,guestSSID:g,guestPassword:c})}}b.add({action:f,data:e,cb:function(h){if(h.result==="OK"){}else{if(h.result!=="_AjaxError"&&h.result!=="_ErrorAbortedAction"){RAINIER.executeDefaultJnapErrorHandler(h)}}}})}function saveGuestSettings(e,a,b){var c=RAINIER.shared.util.formatGuestSsid(e,RAINIER.setup.ui.guest),d=RAINIER.shared.util.formatGuestSsid(a,RAINIER.setup.ui.guest);setGuestNetworkSettings(RAINIER.guestSettings,c,d,b)}function reconnectToRouterIfNecessary(a,c){if(c.status===200){goToNextPage()}else{if(settingsNotChanged){var b=document.getElementById("updatingInstructions");document.addClass(b,"hidden")}showView("reconnect");document.getElementById("nextButton").disabled=true;pollForRouterConnection({cb:function(){goToNextPage()}})}}function pollForLanDisconnect(a){if(typeof a==="undefined"){a=0}RAINIER.jnap.send({action:"/jnap/core/IsAdminPasswordDefault",data:{},cb:function(b,c){if(c.status!==200){var d={cb:reconnectToRouterIfNecessary,interval:RAINIER.ROUTER_RESTART_INTERVAL,maxRetries:RAINIER.ROUTER_RESTART_MAX_RETRIES,disableDefaultAjaxErrorHandler:true};pollForRouterConnection(d)}else{if(a<RAINIER.CHECK_FOR_LAN_BREAK_MAX_RETRIES){setTimeout(function(){pollForLanDisconnect(++a)},RAINIER.CHECK_FOR_LAN_BREAK_INTERVAL)}else{goToNextPage()}}},disableDefaultAjaxErrHandler:true})}function changeRadioSettingsCompleted(e,d){if(e.result==="OK"){saveRadioSettingsInCookie(d);RAINIER.shared.util.setCookie("radioSettingsChanged","true",null,"/");var c=false,a=e.sideEffects;if(a){for(var b=0;b<a.length;b++){if(a[b]==="WirelessInterruption"){c=true;break}}}if(c){pollForLanDisconnect()}else{goToNextPage()}}}function isSsidValid(d,a,e,b,c){if(a==="ssidInputValidation5GHz"&&(radiosCollapsed||!radio5GHz)){return true}if(d.length===0){showInputValidationError(a,true,RAINIER.setup.ui.inputRequired);return false}else{if(RAINIER.shared.util.lengthInBytes(d)>32){showInputValidationError(a,false);return false}else{if(RAINIER.shared.util.beginsOrEndsWithSpace(d)){showInputValidationError(a,true,RAINIER.setup.ui.inputCannotBeginOrEndWithSpace);return false}else{if(c!==b&&d===e){showInputValidationError(a,true,RAINIER.setup.ui.mustChangeSsid);return false}}}}return true}function isPasswordValid(b,a){if(a==="passwordInputValidation5GHz"&&(radiosCollapsed||!radio5GHz)){return true}if(b.length===0){showInputValidationError(a,true,RAINIER.setup.ui.inputRequired);return false}else{if(b.length<8||b.length>63){showInputValidationError(a,false);return false}else{if(RAINIER.shared.util.beginsOrEndsWithSpace(b)){showInputValidationError(a,true,RAINIER.setup.ui.inputCannotBeginOrEndWithSpace);return false}}}return true}function validateInput(a){clearAllInputErrors();return isSsidValid(a.ssid,"ssidInputValidation",a.oldSsid,a.password,a.oldPassword)&&isPasswordValid(a.password,"passwordInputValidation")&&isSsidValid(a.ssid5Ghz,"ssidInputValidation5GHz",a.oldSsid5Ghz,a.password5GHz,a.oldPassword5GHz)&&isPasswordValid(a.password5GHz,"passwordInputValidation5GHz")}function isTriBandSteeringSupported(){return isBandSteeringSupported()&&radioInfo.supportedBandSteeringModes.indexOf("TriBand")>0}function isBandSteeringSupported(){return(RAINIER.shared.util.areServicesSupported(["/jnap/wirelessap/WirelessAP3"])&&!RAINIER.shared.util.areServicesSupported(["/jnap/wirelessap/WirelessAP4"]))||(RAINIER.shared.util.areServicesSupported(["/jnap/wirelessap/WirelessAP4"])&&radioInfo.isBandSteeringSupported)}function continueSaving(d,c){document.getElementById("triBandSteeringDialog").style.display="none";startPleaseWaitTimer();showView("working");saveGuestSettings(d.ssid,d.ssid5Ghz,c);saveTimeZoneSettings(c);saveLanSettings(d.ssid,c);saveRouterProperties(d.ssid,c);var b=document.getElementsByClassName("reconnectSsid");for(var a=0;a<b.length;a++){RAINIER.setup.setTextForNode(b[a],d.ssid)}RAINIER.setup.setTextForNode(document.getElementById("reconnectPassword"),d.password);if(d.ssid===d.oldSsid&&d.password===d.oldPassword&&d.oldSsid5Ghz===d.ssid5Ghz&&d.oldPassword5GHz===d.password5GHz){settingsNotChanged=true;c.send();return}saveRadioSettings(d,c);c.send()}function changeRadioSettings(a){var e=document.getElementById("wirelessSsidInput").value,b=document.getElementById("wirelessPasswordInput").value,d={ssid:e,ssid5Ghz:radiosCollapsed?e:document.getElementById("wirelessSsidInput5GHz").value,password:b,password5GHz:radiosCollapsed?b:document.getElementById("wirelessPasswordInput5GHz").value,oldSsid:getWirelessSsid(),oldSsid5Ghz:getWirelessSsid("5GHz"),oldPassword:getWirelessPassword(),oldPassword5GHz:getWirelessPassword("5GHz")},c=RAINIER.jnap.Transaction({onComplete:function(f){changeRadioSettingsCompleted(f,d)},disableDefaultJnapErrHandler:true});if(!validateInput(d)){return}if(!a&&isTriBandSteeringSupported()&&!radiosCollapsed){document.getElementById("triBandSteeringDialog").style.display="block";return}continueSaving(d,c)}function collapseRadios(a){radiosCollapsed=a;if(isBandSteeringSupported()){radioInfo.bandSteeringMode=a&&isTriBandSteeringSupported()?"TriBand":"Basic"}if(a){document.addClassById("dialog","radiosCollapsed");document.getElementById("labelSsid24").innerHTML=radioLabel("RADIO_2.4GHz",true);if(isTriBandSteeringSupported()){document.getElementById("bandSteeringStaticHelp").style.display="none";document.getElementById("triBandSteeringStaticHelp").style.display="block"}}else{document.removeClassById("dialog","radiosCollapsed");document.getElementById("labelSsid24").innerHTML=radioLabel("RADIO_2.4GHz",false);if(radio5GHz){document.getElementById("labelSsid5GHz").innerHTML=radioLabel("RADIO_5GHz",false);document.getElementById("wirelessSsidInput5GHz").value=RAINIER.shared.util.ssidAppend(document.getElementById("wirelessSsidInput").value,"_5GHz")}if(isTriBandSteeringSupported()){document.getElementById("bandSteeringStaticHelp").style.display="block";document.getElementById("triBandSteeringStaticHelp").style.display="none"}}return false}function cancelSave(a){document.getElementById("triBandSteeringDialog").style.display="none";if(a){collapseRadios(true)}}function initFinished(a){if(a.result==="OK"){showView("landing");document.getElementById("nextButton").disabled=false}}function dualSsidLearnMore(){document.getElementById("learnMoreLink").style.display="none";document.getElementById("learnMoreSpan").style.display="inline";return false}function dualSsidLearnLess(){document.getElementById("learnMoreLink").style.display="inline";document.getElementById("learnMoreSpan").style.display="none";return false}function radioLabel(b,c){if(c&&!isTriBandSteeringSupported()){if(radioInfo.bandSteeringMode){return RAINIER.ui.shared.strings.allBands.threeRadios}else{return RAINIER.ui.shared.strings.allBands.twoRadios}}var a=RAINIER.shared.util.getLabeledRadio(radioInfo,b);return a.labels["short"]}function init(){var a=RAINIER.jnap.Transaction({onComplete:initFinished});getRouterInfo(false,function(b){if(b.result==="OK"){RAINIER.jnapCache.set(RAINIER.jnapActions.getDeviceInfo(),b.output);isGuestNetwork3Supported=RAINIER.shared.util.areServicesSupported(["/jnap/guestnetwork/GuestNetwork3"])}a.add({action:"/jnap/router/GetLANSettings",data:{},cb:function(c){if(c.result==="OK"){RAINIER.lanSettings=c.output}}});a.add({action:"/jnap/locale/GetTimeSettings",data:{},cb:function(c){if(c.result==="OK"){RAINIER.timeSettings=c.output}}});a.add({action:isGuestNetwork3Supported?"/jnap/guestnetwork/GetGuestRadioSettings":"/jnap/guestnetwork/GetGuestNetworkSettings",data:{},cb:function(d){if(d.result==="OK"){RAINIER.guestSettings=d.output;if(isGuestNetwork3Supported){RAINIER.guestSettings.radio={band24:null,band50:null};for(var c=0;c<RAINIER.guestSettings.radios.length;c++){switch(RAINIER.guestSettings.radios[c].radioID){case"RADIO_2.4GHz":RAINIER.guestSettings.radio.band24=RAINIER.guestSettings.radios[c];break;case"RADIO_5GHz":RAINIER.guestSettings.radio.band50=RAINIER.guestSettings.radios[c];break}}}}}});getRadioSettingsInTransaction(a,function(d){var c,e=false;if(d.result==="OK"){radioInfo=d.output;radio24GHz=getRadioById("RADIO_2.4GHz");radio5GHz=getRadioById("RADIO_5GHz");document.getElementById("wirelessSsidInput").value=radio24GHz.settings.ssid;if(radio24GHz.settings.wpaPersonalSettings){document.getElementById("wirelessPasswordInput").value=radio24GHz.settings.wpaPersonalSettings.passphrase;if(!RAINIER.shared.util.getCookie("wirelessSsid")){saveRadioSettingsInCookie()}}if(radio5GHz){document.getElementById("wirelessSsidInput5GHz").value=radio5GHz.settings.ssid;if(radio5GHz.settings.wpaPersonalSettings){document.getElementById("wirelessPasswordInput5GHz").value=radio5GHz.settings.wpaPersonalSettings.passphrase}}else{document.addClassById("dialog","fiveGHzBandNotSupported")}for(c=0;c<radio24GHz.supportedSecurityTypes.length;c++){if(radio24GHz.supportedSecurityTypes[c]===RAINIER.DEFAULT_SECURITY_TYPE){e=true;break}}if(!e){securityType=RAINIER.ALT_SECURITY_TYPE}collapseRadios(isTriBandSteeringSupported());if(isBandSteeringSupported()){document.addClassById("dialog","bandSteeringOn");if(!isTriBandSteeringSupported()){document.getElementById("defaultBandSteeringStaticHelp").style.display="block"}}}});a.send()})}window.onbeforeunload=function(){return RAINIER.shared.util.decodeHtml(RAINIER.setup.ui.confirmExit)};window.onload=function(){if(RAINIER.shared.util.getCookie("radioSettingsChanged")==="true"){goToNextPage()}showView("loading");init()};