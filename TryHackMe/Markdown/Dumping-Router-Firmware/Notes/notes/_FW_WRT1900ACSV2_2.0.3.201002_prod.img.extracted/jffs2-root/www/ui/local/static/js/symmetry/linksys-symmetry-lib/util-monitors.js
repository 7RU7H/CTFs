(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","./symmetry-jnap"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("./symmetry-jnap"))}else{a.utilMonitors=b(a.$,(a.lodash||a._),a.JNAP)}}}(this,function(v,O,j){var G;var l=3000;var w=null,N=[{result:"speedTestResult",step:"latency"},{result:"speedTestResult",step:"downloadBandwidth"},{result:"speedTestResult",step:"uploadBandwidth"}];function H(P){return j.send("/nodes/healthcheck/GetHealthCheckStatus",{},P||w)}function y(Q,R,P){return j.send("/nodes/healthcheck/GetHealthCheckResults",{includeModuleResults:true,healthCheckModule:Q,lastNumberOfResults:R},P||w)}function r(P){return P.output.speedTestResult.exitCode==="SpeedTestExecutionError"&&P.output.speedTestResult.latency&&P.output.speedTestResult.downloadBandwidth&&P.output.speedTestResult.uploadBandwidth}function k(P){if(P.result!=="OK"){return P.result||P}else{if(P.output.speedTestResult&&P.output.speedTestResult.exitCode!=="Success"&&P.output.speedTestResult.exitCode!=="Unavailable"&&!r(P)){return P.output.speedTestResult.exitCode}}return null}function h(P){return !P.output.healthCheckModuleCurrentlyRunning||k(P)}function e(P){if(P.output.healthCheckModuleCurrentlyRunning==="SpeedTest"&&P.output.speedTestResult.downloadBandwidth){return"uploadBandwidth"}else{if(P.output.healthCheckModuleCurrentlyRunning==="SpeedTest"&&P.output.speedTestResult.latency){return"downloadBandwidth"}else{if(P.output.healthCheckModuleCurrentlyRunning==="SpeedTest"){return"latency"}}}}function t(Q,P){var R;v.each(P,function(S,T){if(T.step===Q){R=S}});return R+1}var z,K,B=false;function s(){z=null;K=null;B=false}function n(P,R,Q){setTimeout(function(){R=R||v.noop;Q=Q||v.noop;H().success(function(S){if(h(S)){if(k(S)){Q(k(S))}else{R({allStepsCount:P.length,stopped:B,allStepsDone:!B,speedTestResult:K.output.speedTestResult})}s();return}else{n(P,R,Q);K=S;if(B){return}}var T=e(S);if(T!==z){R({stepName:T,stepNumber:t(T,P),allStepsCount:P.length,allStepsDone:false,speedTestResult:S.output.speedTestResult});z=T}}).error(function(S){Q(k(S));s()})},l)}function M(R,T,S,Q){w=Q;var P=[];if(R==="SpeedTest"){P=P.concat(N)}j.send("/nodes/healthcheck/RunHealthCheck",{runHealthCheckModule:R},w).success(function(){n(P,T,S)}).error(function(U){S(k(U))})}function L(S,R,P){w=P;var Q=[];Q=Q.concat(N);j.send("/nodes/healthcheck/RunHealthCheck",{},w).success(function(){n(Q,S,R)}).error(function(T){R(k(T))})}function A(P){B=true;return j.send("/nodes/healthcheck/StopHealthCheck",{},P||w)}var q,x,E,F,i,c=0,D=15000,b=5000,C=2,p=null;function J(P){var S=P.complete;function R(T,U,V){return S(Q(T,U,V))}function Q(T,U,V){return{getAllResponseHeaders:function(){var W="";V=V||{};O.each(V,function(Y,X){W+=X+": "+Y+" "});return W},statusText:U,responseText:T}}if(typeof cordova!=="undefined"){cordova.exec(R,R,"Http","request",[P])}else{v.ajax(P)}}function u(R,P,S,Q){if(P||!Q){S(P)}else{setTimeout(function(){R(S,Q-1)},b/(C+1))}}function a(T,P){var R=/content-type:\s+image\/png/i,S=function(U){return R.test(U.getAllResponseHeaders())};var Q="/cloud/ping.png";J({headers:{Expires:"Fri, 10 Oct 2015 14:19:41 GMT","Cache-Control":"no-cache"},url:Q,type:"GET",timeout:10000,cache:false,contentType:"image/png",complete:function(U){if(S(U)){console.info("testPingPng: Cloud is online.");T(true)}else{console.info("testPingPng: Cloud not online (jqXHR)",U);u(a,false,T,P)}}})}function I(Q,P){j.send("/router/GetWANStatus").success(function(R){u(I,R.output.wanStatus==="Connected"||R.output.wanIPv6Status==="Connected",Q,P)}).error(function(){u(I,false,Q,P)})}function g(){setTimeout(function(){if(F!==x||i!==E){F=x;i=E;q()}},500)}function f(){var Q=(x)?C:0,P=(E)?C:0;if(c){return}else{c=2}G.connectivity.testRouterOnline(function(R){c--;if(R!==x){x=R;g();if(p){o();d()}}},Q);G.connectivity.testCloudOnline(function(R){c--;if(R!==E){E=R;g()}},P)}function m(P){x=undefined;E=undefined;q=P;d()}function o(){if(p){clearInterval(p);p=null}}function d(){o();var P=(x)?D:b;p=setInterval(f,P);f()}G={connectivity:{init:m,pause:o,resume:d,get xfunction(){return x},set xfunction(P){x=P;F=P},get Efunction(){return E},set Efunction(P){E=P;i=P},testRouterOnline:I,testCloudOnline:a},healthCheck:{startAll:L,start:M,stop:A,status:H,getResults:y,getErrorCode:k}};return G}));