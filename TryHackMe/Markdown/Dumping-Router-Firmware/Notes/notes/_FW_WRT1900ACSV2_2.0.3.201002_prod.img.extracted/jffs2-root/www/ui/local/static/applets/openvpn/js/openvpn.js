(function(){var s=$("#openvpn-applet"),L=s.find("#vpn-settings"),g=L.find('[name="serverAddressLabel"]'),p=s.find("#users-settings"),S=RAINIER.ui.template.createTemplate(s.find("#templateVpnUserRow .row")),d=true,A=true,r=RAINIER.ui.buildInputValidBalloon,b=[],C=["maxProfiles","maxConcurrentConnections","serverAddress","clientProfileUpdated"],l=["maxProfiles","maxConcurrentConnections","serverAddress","allowRemoteConfigure","clientProfileUpdated","clientIPStartAddress"],w={validCharSet:"numeric",minLen:1,maxLen:5,minVal:1,maxVal:65535,isRequired:true},i={maxLen:255,validCharSet:"domainName",whiteSpace:false,isRequired:true},k={validCharSet:"numeric",minLen:1,maxLen:3,minVal:0,maxVal:254,isRequired:true};var o={openVpn:{},lanSettings:{},guestNetwork:{}};var a={openVpn:{}};var t={username:"",password:""};var E={"openVpn.isOpenVPNEnabled":"boolean","openVpn.allowRemoteConfigure":"boolean","openVpn.serverPort":"number"};var B={};var z={onEditUsers:function(){p.addClass("edit");L.find("#warningMessage").css("display","none");G()},onDelUser:function(){RAINIER.ui.inputBalloon.hide();$(this).remove();p.find("#maxUsersMessage").css("display","none");p.find("#add-vpn-user").removeAttr("disabled");p.find("#add-vpn-user").removeClass("disabled")},onCancelUsers:function(){RAINIER.ui.inputBalloon.hide();RAINIER.ui.validation.removeInvalidMarks(p);p.find("#maxUsersMessage").css("display","none");p.find("#add-vpn-user").removeAttr("disabled");p.find("#add-vpn-user").removeClass("disabled");p.removeClass("edit");q()},onSaveUsers:function(){var U=p.find(".userRow"),T=[];if(j()){$.each(U,function(){var W=$(this),V=RAINIER.binder.fromDom(W,{});RAINIER.binder.toDom(V,W);T.push(V);W.find("[tooltip].truncate-text").each(function(){$(this).attr("tooltip",$(this).text())})});a.openVpn.profiles=T;u(false,false);p.removeClass("edit")}},onAddUser:function(){var T=p.find(".userRow");if(T.length<o.openVpn.maxProfiles){R(t);p.addClass("edit")}else{p.find("#add-vpn-user").attr("disabled",true);p.find("#add-vpn-user").addClass("disabled");p.find("#maxUsersMessage").css("display","inline-block")}},onEditVPNSettings:function(){L.addClass("edit");L.find(".ovpn-profile-button").attr("disabled",true);L.find(".ovpn-profile-button").addClass("disabled");L.find("#warningMessage").css("display","none")},onToggleRemoteConfigure:function(){function T(){L.find("#chkRemoteConfigure").attr("checked","checked")}if(!RAINIER.network.isBehindAuthority()&&!L.find("#chkRemoteConfigure").is(":checked")){RAINIER.ui.dialogWarning({msg:RAINIER.ui.validation.strings.openVpn.remoteAccessOffWarning,onCancel:T})}},onDownloadVPNSettings:function(){var T=window.document.createElement("a"),V=null,W="clientconfig.ovpn";if(L.hasClass("edit")){return}if(!p.find(".userRow").length){RAINIER.ui.alert(RAINIER.ui.validation.strings.openVpn.noUsersDefined);return}function U(){return window.navigator.msSaveOrOpenBlob||(typeof T.download!=="undefined"&&window.Blob)}if(U()){RAINIER.jnap.send({action:"/jnap/openvpn/DownloadClientConnectionProfile",data:{},cb:function(X){if(X.result==="OK"){V=X.output.clientConnectionProfile;if(window.navigator.msSaveOrOpenBlob){V=new Blob([V]);window.navigator.msSaveOrOpenBlob(V,W)}else{if(typeof T.download!=="undefined"){V=window.btoa(V);T.href="data:application/octet-stream;base64,"+V;T.download=W;document.body.appendChild(T);T.click();document.body.removeChild(T)}}}else{RAINIER.ui.alert(RAINIER.ui.validation.strings.openVpn.profileDownloadFailed)}}})}else{RAINIER.ui.alert(RAINIER.ui.validation.strings.openVpn.remoteDownloadUnsupported)}},onDownloadVPNSettingsForm:function(){if(!p.find(".userRow").length){RAINIER.ui.alert(RAINIER.ui.validation.strings.openVpn.noUsersDefined);return false}},onCancelVPNSettings:function(){a=$.extend(true,{},o);RAINIER.ui.inputBalloon.hide();RAINIER.ui.validation.removeInvalidMarks(L);L.removeClass("edit");L.find(".ovpn-profile-button").removeAttr("disabled");L.find(".ovpn-profile-button").removeClass("disabled");RAINIER.binder.toDom(a,L,E)},onSaveVPNSettings:function(){var T=RAINIER.binder.fromDom(L,E);if(n(T)){$.extend(true,a,T);b[2]=T.thirdOctet;a.openVpn.clientIPStartAddress=b.join(".");f(a);RAINIER.binder.toDom(a,L,E);O(a.openVpn.allowRemoteConfigure);u(false,true);L.find(".ovpn-profile-button").removeAttr("disabled");L.find(".ovpn-profile-button").removeClass("disabled");L.removeClass("edit")}},onClose:function(){RAINIER.ui.MainMenu.closeApplet()}};function N(){return !o.openVpn.allowRemoteConfigure&&!RAINIER.network.isBehindAuthority()}function I(){return !!o.openVpn.hostname||!!o.openVpn.serverIPAddress}function u(V,U){var T=false;d=V||false;A=true;if(v()){T=true;D(U)}if(d&&!T){z.onClose()}}function m(T){T.add({action:"/jnap/openvpn/GetOpenVPNSettings",data:{},cb:function(U){if(U.result==="OK"){o.openVpn=$.extend(true,{},U.output||{});x();K();a.openVpn=$.extend(true,{},o.openVpn);if(!U.output){}}else{}}});T.add({action:"/jnap/router/GetLANSettings",data:{},cb:function(U){if(U.result==="OK"){o.lanSettings=$.extend(true,{},U.output||{});if(!U.output){}}else{}}});T.add({action:"/jnap/guestnetwork/GetGuestNetworkSettings2",data:{},cb:function(U){if(U.result==="OK"){o.guestNetwork=$.extend(true,{},U.output||{});if(!U.output){}}else{}}})}function R(T){var U=RAINIER.ui.template.createBlock(S,T);RAINIER.binder.toDom(T,U);M(U);RAINIER.util.trapEnter(U);U.find(".delete").click(z.onDelUser.bind(U));U.find(".viewPassword").click(function(){$(this).css("display","none");U.find(".hidePassword").css("display","block");U.find(".mask").css("display","none");U.find(".hiddenPassword").css("display","block")});U.find(".hidePassword").click(function(){$(this).css("display","none");U.find(".viewPassword").css("display","block");U.find(".mask").css("display","block");U.find(".hiddenPassword").css("display","none")});U.find("[tooltip].truncate-text").each(function(){$(this).attr("tooltip",$(this).text())});RAINIER.ui.tooltip.add(U.find("[tooltip]"),"top");s.find("#users-list").append(U);RAINIER.util.trapEnter(U.find("input[type=text]"))}function F(){if(o.openVpn.serverIPAddress){s.find("#ipAddress").append(" "+o.openVpn.serverIPAddress)}RAINIER.binder.toDom(o,s,E);q();O(o.openVpn.allowRemoteConfigure)}function q(){s.find("#users-list .userRow").remove();$.each(o.openVpn.profiles,function(){R(this)})}function J(){s.find("#server-address").on("change",function(){if(this.value==="serverIPAddress"){s.find("#hostname").hide()}else{s.find("#hostname").show()}});s.find("#isVPNEnabled").on("change",function(){a.openVpn.isOpenVPNEnabled=this.checked;u(false)});e();L.find(".save-button").click(z.onSaveVPNSettings);L.find(".edit-button").click(z.onEditVPNSettings);L.find(".cancel-button").click(z.onCancelVPNSettings);L.find("#chkRemoteConfigure").click(z.onToggleRemoteConfigure);L.find("#download-profile-btn").click(z.onDownloadVPNSettings);L.find("form").submit(z.onDownloadVPNSettingsForm);p.find(".save-button").click(z.onSaveUsers);p.find(".edit-button").click(z.onEditUsers);p.find(".cancel-button").click(z.onCancelUsers);p.find("#add-vpn-user").click(z.onAddUser)}function y(U){var T=U.data();return T.username.isValid(true)&&T.password.isValid(true)}function j(){var T=p.find(".userRow"),V=null;for(var U=0;U<T.length;U++){V=$(T[U]);if(!y(V)){return false}}return true}function n(){var T=B.port.isValid(true)&&B.thirdOctet.isValid(true);if(L.find("#server-address").val()==="hostname"){T=T&&B.hostname.isValid(true)}return T}function G(){var T=p.find(".userRow");$.each(T,function(){M($(this))})}function M(X){function U(aa){var Y=p.find('input[name="username"]');for(var Z=0;Z<Y.length;Z++){if(Y[Z].value===aa&&Z!==X.index()&&aa!==""){return true}}return false}var W={minLen:8,maxLen:64,validCharSet:"vpnUserName",isRequired:true},V={minLen:8,maxLen:64,validCharSet:"vpnUserName",isRequired:true},T={};T.username=r($.extend(true,{},W,{els:X.find('input[name="username"]'),errors:[{test:U,when:true,message:RAINIER.ui.validation.strings.openVpn.vpnUserDuplicated}]}));T.password=r($.extend(true,{},V,{els:X.find('input[name="password"]')}));X.data(T);return true}function H(){function U(W){var V=o.lanSettings.ipAddress.split("."),X=o.guestNetwork.ipAddress.split(".")||[];if((b[0]===V[0]&&b[1]===V[1]&&W===V[2])||(b[0]===X[0]&&b[1]===X[1]&&W===X[2])){return true}return false}function T(X){var W=X.split("."),V=false;$.each(W,function(){if(this.length>63){V=true}else{if(this.length===0){V=true}}});return V}B.port=r($.extend(true,{},w,{els:L.find("#port input")}));B.hostname=r($.extend(true,{},i,{els:L.find("#hostname input"),errors:[{test:T,when:true,message:RAINIER.ui.common.strings.ddnsStatus.InvalidHostname}]}));B.thirdOctet=r($.extend(true,{},k,{els:L.find('input[name="thirdOctet"]'),errors:[{test:U,when:true,message:RAINIER.ui.validation.strings.invalidIPAddress}]}))}function O(T){if(T){L.find("#remote-on").css("display","block");L.find("#remote-off").css("display","none")}else{L.find("#remote-off").css("display","block");L.find("#remote-on").css("display","none")}}function x(){if(o.openVpn.hostname){o.openVpn.serverAddress="hostname"}else{o.openVpn.serverAddress="serverIPAddress";o.openVpn.hostname=""}f(o)}function f(T){if(T.openVpn.serverAddress==="hostname"){T.serverAddressLabel=T.openVpn.hostname}else{T.serverAddressLabel=T.openVpn.serverIPAddress}g.attr("tooltip",T.serverAddressLabel);RAINIER.ui.tooltip.add(g,"top")}function K(){b=o.openVpn.clientIPStartAddress.split(".");o.startIPAddress=b[0]+"."+b[1];o.thirdOctet=b[2]}function c(){F();J();H();s.find("#server-address").change();if(!RAINIER.network.isAuthorityRemote()){if($.cookie("user-auth-token")){L.find("#download-user-auth-token").attr("value",$.cookie("user-auth-token"));L.find("#download-admin-auth").detach()}else{L.find("#download-admin-auth").attr("value",$.cookie("admin-auth"));L.find("#download-user-auth-token").detach()}L.find("#jcgi-wrapper").css("display","block")}else{L.find("#non-jcgi-wrapper").css("display","block")}if(o.openVpn.clientProfileUpdated){L.find("#warningMessage").css("display","block")}}function v(){var T=false;if(!N()&&I()){if(!$.compare(o.openVpn,a.openVpn)){T=true}}return T}function D(W){if(!$.compare(o.openVpn,a.openVpn)){var U=_.omit(a.openVpn,C),T=_.omit(o.openVpn,l),V=a.openVpn.serverAddress!==o.openVpn.serverAddress;if(a.openVpn.serverAddress==="hostname"){delete U.serverIPAddress;delete T.serverIPAddress}else{delete U.hostname;delete T.hostname}RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/openvpn/SetOpenVPNSettings",data:U,cb:function(X){if(X.result==="OK"){o=$.extend(true,{},o,a);o.openVpn.profiles=$.extend([],a.openVpn.profiles);if(N()){h()}U=_.omit(U,l);if(W&&(!$.compare(T,U)||V)){L.find("#warningMessage").css("display","block")}}RAINIER.ui.hideWaiting()}})}return true}function e(){s.find(".help").click(function(){$("#help-menu").click()})}function h(){e();s.find("#open-vpn, #isVPNEnabled, #isVPNEnabled + span").css("display","none");if(N()){s.find("#no-remote-access").css("display","block")}else{if(!I()){s.find("#no-wan-detected").css("display","block")}}s.find("#applet-locked").css("display","block")}function Q(){if(N()||!I()){h()}else{c()}RAINIER.ui.placeholders.init();RAINIER.event.fire("applet.loaded")}function P(){var T=RAINIER.jnap.Transaction({onComplete:Q});m(T);T.send();s.find("footer .cancel").click(z.onClose)}P()}());