(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","lodash","./symmetry-jnap","./icon-rules"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("jquery"),require("lodash"),require("./symmetry-jnap"),require("./icon-rules"))}else{a.deviceManager=b(a.$,(a.lodash||a._),a.JNAP,a.iconRules)}}}(this,function(a2,am,ao,bo){var aA=false,V=[],x=0,aR=null,ah=null,ai=null,a9=0,h={},W={};var H={},az={},m={};var M=null,ad=null,a=null,ax=null,e=null;var t={byLogic:[],byEvents:[]};var aD={propDeviceName:"userDeviceName",propDeviceIcon:"userDeviceType",propDeviceLocation:"userDeviceLocation",propDeviceModelNumber:"userDeviceModelNumber",propDeviceManufacturer:"userDeviceManufacturer",propDeviceOS:"userDeviceOS"};var K="networkDevice",a3="guestNetworkDevice";var U=[40,25,10],R=[-50,-70,-90];var aC=5*1000;var Y=["dhcpReservation","signalStrengthIndex","radioSSID"];var aL=["subnetMask","minNetworkPrefixLength","maxNetworkPrefixLength","minAllowedDHCPLeaseMinutes","maxAllowedDHCPLeaseMinutes","maxDHCPReservationDescriptionLength"];var bm=["maxUsers","maxUsersLimit"];var Z="00:00:00:00:00:00";var G=["friendlyName","model.deviceType","model.description","model.manufacturer","model.modelNumber","model.hardwareVersion","unit.serialNumber","unit.firmwareVersion","unit.firmwareDate","unit.operatingSystem"];var L=["nodeType","model.modelNumber","model.manufacturer","unit.operatingSystem"];var k=/[^a-zA-Z0-9-]+|^-|-$/g;var E=/^Android$|^android-[a-fA-F0-9]{16}.*|^Android-\d+/i;var aw=/([\d.]+).+/;var o={general:am.template("[ deviceManager - ${message} ]"),generalAddData:am.template("[ deviceManager - ${message} - ${additionalData} ]"),actionFailed:am.template("[ deviceManager - ${action} failed: ${result} ]"),actionFailedAddData:am.template("[ deviceManager - ${action} failed: ${result} - ${additionalData} ]"),deleteOnlineDevice:am.template("[ deviceManager - Cannot delete an Online Device - deviceID: ${deviceID} ]"),lastRevisionReset:am.template("[ deviceManager - lastRevision # has dropped below sinceRevision, resetting current list - lastRevision: ${lastRevision}, sinceRevision: ${sinceRevision} ]"),startNodesConnectionPolling:am.template("[ deviceManager - Starting NodesNetworkConnections Polling - timeout: ${timeout} ]"),jnapOptionsSet:am.template("[ deviceManager - Setting jnapOptions for GetDevices call - jnapOptions: ${options} ]")};function aB(){if(!W.GetDevices3&&this.model&&this.model.deviceType&&["mobile","phone","tablet"].indexOf(this.model.deviceType.toLowerCase())>-1&&!this.preferredConnection.wireless){return false}return this.isAuthority||this.connections.length>0}function a6(){return !am.isEmpty(this.preferredConnection.wireless)}function bn(){var bp=W.GuestNetwork4?"isGuest":"wireless.isGuest";return am.result(this.preferredConnection,bp)||false}function at(){var bq=m.radios,bp="settings.ssid";if(this.isGuest){bq=az.radios;bp="guestSSID"}return am.result(am.find(bq,{radioID:this.radioID}),bp)||"[SSID not found]"}function be(){return am.sortBy(this.connections,"wireless.radioID")[0]||{}}function aP(br){var bq=this.properties,bp;if(am.isEmpty(br)){throw"getCustomProperty - Need to pass the name of the property"}for(bp=0;bp<bq.length;bp++){if(bq[bp].name===br){return bq[bp].value}}}function g(){var bp=this,bq={};am.each(aD,function(br){bq[br]=bp.getCustomProperty(br)||null});return bq}function O(){var bp=this.getCustomProperty(aD.propDeviceName),bs=am.result(this,"friendlyName","")||"",br=am.result(this,"model.deviceType"),bq=am.words(am.result(this,"model.manufacturer"))[0],bu=am.result(this,"model.modelNumber"),bt=am.result(this,"unit.operatingSystem");if(!bp&&["Mobile","Phone","Tablet"].indexOf(br)>-1&&E.test(bs)){if(bq&&bu){bp=bq+" "+bu}else{if(bt){bp=bt+" "+br;if(bq){bp=bq+" "+bp}}}}return bp||this.friendlyName||bu||(this.isGuest?a3:K)}function ar(bq,bs,bp){var br=L.indexOf(bp)!==-1?am.result(bq.trueValues,bp):bp;return bq.getCustomProperty(aD[bs])||br}function aa(){return ar(this,"propDeviceLocation","")}function aT(){return ar(this,"propDeviceModelNumber","model.modelNumber")}function aM(){return ar(this,"propDeviceManufacturer","model.manufacturer")}function bk(){return ar(this,"propDeviceOS","unit.operatingSystem")}function aJ(){var bp=this;return V.filter(function(bq){return am.find(bq.connections,function(br){return br.parentDeviceID===bp.deviceID})})}function Q(bp,bq,br){bp.push({name:bq,value:br})}function a1(br,bs,bt){var bq=br.properties,bp;if(br.getCustomProperty(bs)){for(bp=0;bp<bq.length;bp++){if(bq[bp].name===bs){bq[bp].value=bt;break}}}else{Q(bq,bs,bt)}ay(br.deviceID,br)}function bf(bs,bt){var bq=this,bp=ao.Deferred(),br={deviceID:bq.deviceID,propertiesToModify:[]};if(am.isEmpty(bs)){throw"setCustomProperty - Need to pass the name of the property as first argument"}Q(br.propertiesToModify,bs,bt);ao.send("/devicelist/SetDeviceProperties",br).success(function(){a1(bq,bs,bt);bp.resolve()}).error(function(bu){console.error(o.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bu,null,2)}));bp.reject(bu)});return bp}function aO(br){var bq=this,bp=ao.Deferred();if(am.isEmpty(br)){throw"setUserDefinedName - Need to pass a definedName"}bq.setCustomProperty(aD.propDeviceName,br).success(function(){bp.resolve()}).error(function(bs){console.error(o.actionFailed({action:"setUserDefinedName",result:JSON.stringify(bs,null,2)}));bp.reject(bs)});return bp}function q(br){var bq=this,bp=ao.Deferred();if(am.isEmpty(br)){throw"setUserDefinedIcon - Need to pass a definedIcon"}bq.setCustomProperty(aD.propDeviceIcon,br).success(function(){bp.resolve()}).error(function(bs){console.error(o.actionFailed({action:"setUserDefinedIcon",result:JSON.stringify(bs,null,2)}));bp.reject(bs)});return bp}function p(bs,bt){var bq=this,bp=ao.Deferred(),br={deviceID:bq.deviceID,propertiesToModify:[]};if(am.isEmpty(bs)&&am.isEmpty(bt)){throw"setUserDefinedNameAndIcon - Need to pass a definedName and/or a definedIcon"}if(!am.isEmpty(bs)){Q(br.propertiesToModify,aD.propDeviceName,bs)}if(!am.isEmpty(bt)){Q(br.propertiesToModify,aD.propDeviceIcon,bt)}ao.send("/devicelist/SetDeviceProperties",br).success(function(){br.propertiesToModify.forEach(function(bu){a1(bq,bu.name,bu.value)});bp.resolve()}).error(function(bu){console.error(o.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bu,null,2)}));bp.reject(bu)});return bp}function av(br){var bq=this,bp=ao.Deferred();if(am.isEmpty(br)){throw"setUserDefinedLocation - Need to pass a definedLocation"}bq.setCustomProperty(aD.propDeviceLocation,br).success(function(){bp.resolve()}).error(function(bs){console.error(o.actionFailed({action:"setUserDefinedLocation",result:JSON.stringify(bs,null,2)}));bp.reject(bs)});return bp}function w(bt,br,bq){var bs=this,bp=ao.Deferred(),bu={deviceID:bs.deviceID,propertiesToModify:[]};if(am.isEmpty(bt)&&am.isEmpty(br)&&am.isEmpty(bq)){throw"setUserDefinedNameAndIcon - Need to pass a definedName and/or a definedIcon"}if(!am.isEmpty(bt)){Q(bu.propertiesToModify,aD.propDeviceModelNumber,bt)}if(!am.isEmpty(br)){Q(bu.propertiesToModify,aD.propDeviceManufacturer,br)}if(!am.isEmpty(bq)){Q(bu.propertiesToModify,aD.propDeviceOS,bq)}ao.send("/devicelist/SetDeviceProperties",bu).success(function(){bu.propertiesToModify.forEach(function(bv){a1(bs,bv.name,bv.value)});bp.resolve()}).error(function(bv){console.error(o.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bv,null,2)}));bp.reject(bv)});return bp}function aq(bs){var bq=this,bp=ao.Deferred(),br={deviceID:bq.deviceID,propertiesToRemove:[bs]};if(am.isEmpty(bs)){throw"removeCustomProperty - Need to pass a property name"}if(!bq.getCustomProperty(bs)){console.info(o.general({message:'removeCustomProperty - "'+bs+'" does not exist, exiting'}));bp.resolve();return}ao.send("/devicelist/SetDeviceProperties",br).success(function(){var bu=bq.properties,bt;if(bq.getCustomProperty(bs)){for(bt=0;bt<bu.length;bt++){if(bu[bt].name===bs){bu.splice(bt,1);break}}}bp.resolve()}).error(function(bt){console.error(o.actionFailed({action:"SetDeviceProperties",result:JSON.stringify(bt,null,2)}));bp.reject(bt)});return bp}function c(){var bq=this,bp=ao.Deferred();if(bq.isOnline){console.error(o.deleteOnlineDevice({deviceID:bq.deviceID}));bp.reject()}ao.send("/devicelist/DeleteDevice",{deviceID:bq.deviceID}).success(function(){n(bq.deviceID);bp.resolve()}).error(function(br){console.error(o.actionFailedAddData({action:"DeleteDevice",result:JSON.stringify(br,null,2),additionalData:"deviceID: "+bq.deviceID||"--"}));bp.reject(br)});return bp}function ac(){var br=this,bs=br.getCustomProperty(aD.propDeviceIcon),bp;if(bs&&bs!=="generic-device"){return bs}function bt(by,bv,bx){if(am.isPlainObject(by)){am.each(by,function(bA,bz){if(bv){bz=bv+"."+bz}return bt(bA,bz,bx)})}else{var bw=am.result(br,bv),bu=false;if((am.isRegExp(by)&&by.test(bw))||by===bw){bu=true}bx.push(bu);return bu}}function bq(bu){var bv=[];bt(bu.test,"",bv);return bv.indexOf(false)===-1}bp=am.result(am.find(bo,bq),"iconClass");if(am.isPlainObject(bp)&&bp.lookup){bp=am.result(this,bp.lookup);bp="router-"+bp.toLowerCase()}return bp}function d(bq){var bp=am.cloneDeep(bq);if(!bp.properties){bp.properties=[]}if(!bp.getCustomProperty){bp.deviceName=O.bind(bp);bp.getCustomProperty=aP.bind(bp)}return bp}function ae(bq){var bp;if(am.isEmpty(bq)&&!am.isPlainObject(bq)){throw"findDeviceIcon - Need to pass an object to examine"}bq=d(bq);bp=ac.apply(bq);return bp}function b(bq){var bp;if(am.isEmpty(bq)&&!am.isPlainObject(bq)){throw"findDeviceName - Need to pass an object to examine"}bq=d(bq);bp=O.apply(bq);return bp}function A(){return am.find(H.dhcpSettings.reservations,{macAddress:this.macAddress})}function B(){var br=this.deviceName.replace(k,""),bq=br,bp=1;while(am.find(H.dhcpSettings.reservations,{description:bq})){bq=br+bp++}return bq}function an(){var br=this,bq=0,bs,bp;if(!W.NodesNetworkConnections&&W.GetDevices3&&W.NodesSetup){return 0}bs=br.signalDecibels>0?U:R;bp=am.find(bs,function(bt){return br.signalDecibels>bt});if(bp){bq=3-am.indexOf(bs,bp)}return bq}function bj(bq){var bp=ao.Deferred();bq=am.omit(bq,aL);bq.dhcpSettings=am.omit(bq.dhcpSettings,bm);bq.dhcpSettings.leaseMinutes=parseInt(bq.dhcpSettings.leaseMinutes,10);ao.send("/router/SetLANSettings",bq).success(function(){H.dhcpSettings.reservations=am.cloneDeep(bq.dhcpSettings.reservations);bp.resolve()}).error(function(br){console.error(o.actionFailed({action:"SetLANSettings",result:JSON.stringify(br,null,2)}));bp.reject(br)});return bp}function y(bu,bw){var br=this,bp=ao.Deferred(),bv=am.cloneDeep(H),bt=br.dhcpReservation,bs={macAddress:br.macAddress,ipAddress:bu,description:bw};function bq(bx){return bx.macAddress!==br.macAddress&&bx.description===bw}if(am.isEmpty(bu)){throw"reserveDHCPAddress - Need to pass the ipAddress to use as first argument"}if(am.isEmpty(bw)){bs.description=br.getUniqueDHCPDescription()}else{if(am.find(H.dhcpSettings.reservations,bq)){throw"reserveDHCPAddress - Description specified in use by another Reservation, must be unique"}}if(br.isGuest){throw"reserveDHCPAddress - Cannot operate on a Guest device"}if(bt&&!am.isEqual(bt,bs)){bt=am.find(bv.dhcpSettings.reservations,{macAddress:br.macAddress});bt=am.merge(bt,bs)}else{if(!bt){bv.dhcpSettings.reservations.push(bs)}}if(!am.isEqual(H,bv)){bj(bv).success(function(){aX(br.deviceID);bp.resolve(bs)}).error(function(bx){console.error(o.actionFailed({action:"reserveDHCPAddress",result:JSON.stringify(bx,null,2)}));bp.reject(bx)})}else{bp.resolve()}return bp}function aG(){var bq=this,bp=ao.Deferred(),bt=am.cloneDeep(H),bs=this.dhcpReservation,br;if(bq.isGuest){throw"removeDHCPReservation - Cannot operate on a Guest device"}if(bs){br=am.findIndex(bt.dhcpSettings.reservations,{macAddress:this.macAddress});bt.dhcpSettings.reservations.splice(br,1);bj(bt).success(function(){aX(bq.deviceID);bp.resolve()}).error(function(bu){console.error(o.actionFailed({action:"removeDHCPReservation",result:JSON.stringify(bu,null,2)}));bp.reject(bu)})}else{bp.resolve()}return bp}function al(){var bq;if(W.GetDevices3){var bp=am.find(this.knownInterfaces,{macAddress:this.macAddress});if(!am.isEmpty(bp)){bq=bp.interfaceType}}if(!bq||bq==="Unknown"){bq=this.wireless?"Wireless":"Wired"}return bq}function l(){var bp=null;if(this.parentDeviceID){bp=C(this.parentDeviceID)}return bp}function v(bq,bp){bp=L.indexOf(bq)!==-1?bp.trueValues:bp;return am.result(bp,bq,null)}function I(bq,bs,bp){var br=v(bs,bp||bq);am.set(bq,bs,br)}function a5(bp){G.forEach(function(bq){I(bp,bq)})}function a8(bq){var bp={};G.forEach(function(br){am.set(bp,br,am.result(bq,br))});return bp}function aH(){var bq=[],bp=am.sortBy(am.cloneDeep(V),"deviceName");bp.forEach(a5);bp.forEach(function(bv,bs){var bt=bv.deviceID;if(bq.indexOf(bt)===-1){var bx=a8(bv);bq.push(bt);if(bx.friendlyName&&["Computer","GameConsole"].indexOf(am.result(bv,"model.deviceType"))!==-1){var bw=am.filter(am.reject(bp,function(by){return bq.indexOf(by.deviceID)!==-1}),bx);if(bw.length){var bu=[],br=[];bv.showMatchDetails=true;bv.matchedDeviceIDs=[];bw.forEach(function(bz){var by=bz.deviceID,bA=am.findIndex(bp,{deviceID:by});bz.showMatchDetails=true;bu.push(bA);bv.matchedDeviceIDs.push(by)});bq=am.union(bq,bv.matchedDeviceIDs);br=am.pullAt(bp,bu);br.forEach(function(bz,by){bp.splice(bs+by+1,0,bz)})}}}});return bp}function D(){var bp=am.result(this.trueValues,"nodeType");if(W.GetDevices3&&!am.isEmpty(bp)&&am.result(this,"unit.firmwareVersion")){return bp}else{if(!W.GetDevices3&&(!am.isEmpty(this.deviceLocation)||this.model.modelNumber==="WHW03")){if(this.isAuthority){return"Master"}else{return"Slave"}}}return""}function r(br,bs,bq){var bp,bt;for(bp in bq){if(bq.hasOwnProperty(bp)){bt=bq[bp];if(am.isPlainObject(bt)){if(!br[bp]){br[bp]={}}r(br[bp],bs||br,bt)}else{Object.defineProperty(br,bp,{get:bs?bt.bind(bs):bt,configurable:true,enumerable:true})}}}}function aK(bq){var bp={deviceName:O,deviceIcon:ac,deviceLocation:aa,isGuest:bn,isOnline:aB,preferredConnection:be,nodeType:D,model:{modelNumber:aT,manufacturer:aM},unit:{operatingSystem:bk}};bq=am.cloneDeep(bq);bq.trueValues={};L.forEach(function(br){am.set(bq.trueValues,br,am.result(bq,br))});r(bq,null,bp);bq.hasChanges=false;if(!bq.knownMACAddresses){bq.knownMACAddresses=[];if(bq.knownInterfaces){bq.knownMACAddresses=am.map(bq.knownInterfaces,"macAddress")}}bq.getCustomProperty=aP.bind(bq);bq.getUserDefinedProperties=g.bind(bq);bq.setCustomProperty=bf.bind(bq);bq.setUserDefinedName=aO.bind(bq);bq.setUserDefinedIcon=q.bind(bq);bq.setUserDefinedNameAndIcon=p.bind(bq);bq.setUserDefinedLocation=av.bind(bq);bq.setUserDefinedModelAndUnitData=w.bind(bq);bq.removeCustomProperty=aq.bind(bq);bq.deleteOfflineDevice=c.bind(bq);if(W.GetDevices3){bq.getChildDevices=aJ.bind(bq)}return bq}function aS(bq){var bp={deviceID:function(){return this.macAddress},isGuest:function(){return true},isOnline:a6,isAuthority:function(){return false},deviceName:O,deviceIcon:ac,knownMACAddresses:function(){return[this.macAddress]},model:function(){return{deviceType:""}},preferredConnection:be};bq=am.cloneDeep(bq);r(bq,null,bp);bq.friendlyName=a3;bq.hasChanges=false;bq.connections=[{macAddress:bq.macAddress,ipAddress:bq.ipAddress,wireless:{}}];bq.getCustomProperty=function(){};return bq}function aQ(bq,br){var bp={deviceID:function(){return br.deviceID},deviceName:function(){return br.deviceName},dhcpReservation:A,knownInterfaces:function(){return br.knownInterfaces},interfaceType:al};bq=am.cloneDeep(bq);r(bq,null,bp);bq.reserveDHCPAddress=y.bind(bq);bq.removeDHCPReservation=aG.bind(bq);bq.getUniqueDHCPDescription=B.bind(bq);if(W.GetDevices3){bq.getParentDevice=l.bind(bq)}return bq}function ab(bp){var bq={signalStrengthIndex:an,radioSSID:at};bp=am.cloneDeep(bp);r(bp,null,bq);if(!bp.radioID){bp.radioID="RADIO_"+bp.band}return bp}function ay(br,bp){var bq;bp.hasChanges=true;for(bq=0;bq<V.length;bq++){if(V[bq].deviceID===br){V[bq]=bp;break}}}function n(bq){var bp;for(bp=0;bp<V.length;bp++){if(V[bp].deviceID===bq){if(t.byLogic.indexOf(bq)===-1){t.byLogic.push(bq)}V.splice(bp,1);break}}}function aX(bq){var bp=C(bq);bp.hasChanges=true}function bg(bp){return bp.hasChanges}function aZ(bq,br){var bp=am.omit(bq.wireless,Y);if(!am.isEqual(bp,br||{})){bq.wireless=am.merge(bq.wireless||{},br);if(!bq.wireless.hasOwnProperty("signalStrengthIndex")){bq.wireless=ab(bq.wireless)}return true}return false}function ak(bq){var bp,bs,br,bt;a2.when(M,ad,e).done(function(){if(!W.NodesNetworkConnections){bp=am.result(bq,"output.connections")}else{bp=am.flatten(am.map(am.result(bq,"output.nodeWirelessConnections"),"connections"))}V.forEach(function(bw){var bu=bw.backhaulInfo;bt=W.GetGuestNetworkClients&&bw.isGuest;if(bu){var bv=am.compact([am.find(bw.connections,{ipAddress:bu.ipAddress})]);bw.connections=bv.length?bv:bw.connections}bw.connections.forEach(function(bz,by){if(!(bt||bz.hasOwnProperty("dhcpReservation"))){bz=aQ(bz,bw);bw.hasChanges=true}if(bu){var bB;if(bu.connectionType==="Wireless"){bB=bu.wirelessConnectionInfo;bB.radioID=bB.radioID.replace(aw,"RADIO_$1GHz")+(bB.radioID==="5GH"?"_2":"");bB.signalDecibels=bB.stationRSSI;if(aZ(bz,bB)){bw.hasChanges=true}}if(W.GetDevices3){var bx=am.findIndex(bw.knownInterfaces,{macAddress:bz.macAddress}),bA={macAddress:bz.macAddress,interfaceType:bu.connectionType};if(bu.connectionType==="Wireless"){bA.band=bB.radioID.indexOf("2.4")!==-1?"2.4GHz":"5GHz"}if(bx!==-1){bw.knownInterfaces=[bA]}else{bw.knownInterfaces.unshift(bA)}bw.knownMACAddresses=am.map(bw.knownInterfaces,"macAddress")}}else{if(!am.isEmpty(bp)){bs=am.find(bp,{macAddress:bz.macAddress});if(bs){if(aZ(bz,bs.wireless)){bw.hasChanges=true}}else{if(bt&&!am.isEmpty(bz.wireless)){bz.wireless={};bw.hasChanges=true}}}}if(W.GetDevices3&&W.NodesSetup&&bw.isOnline&&!bu){br=am.find(bw.knownInterfaces,{macAddress:bz.macAddress,interfaceType:"Wireless"});if(br&&!am.result(bs,"wireless")){bz.wireless={signalStrengthIndex:0,band:br.band};bw.hasChanges=true}}if(bw.hasChanges){bw.connections[by]=bz}})});ax.resolve()})}function z(bq,bt,bp){var bx=ao.transaction(),bw=bt||ao.Deferred(),br=F(),bv={},bs,bu;if(bp){console.info(o.general({message:"Ignoring cache for current Device Manager update"}));bv={supportedForCaching:{"/networkconnections/GetNetworkConnections":false,"/networkconnections/GetNetworkConnections2":false,"/devicelist/GetDevices":false,"/devicelist/GetDevices3":false,"/guestnetwork/GetGuestNetworkClients":false,"/router/GetDHCPClientLeases":false,"/nodes/networkconnections/GetNodesWirelessNetworkConnections":false,"/nodes/diagnostics/GetBackhaulInfo":false}}}else{if(!am.isEmpty(br.supportedForCaching)){bv={supportedForCaching:br.supportedForCaching};console.info(o.jnapOptionsSet({options:JSON.stringify(bv,null,2)}))}}a2.when(M,ad,a,ax,e).done(function(){M=ao.Deferred();ad=ao.Deferred();a=ao.Deferred();ax=ao.Deferred();e=ao.Deferred();if(!aA){aV()}if(br.doGetNetworkConnectionsInMainUpdate){if(!W.NodesNetworkConnections){bx.add("/networkconnections/GetNetworkConnections").success(ak).error(function(by){console.error(o.actionFailed({action:"GetNetworkConnections",result:JSON.stringify(by,null,2)}))})}}else{ak()}bx.add("/devicelist/GetDevices",{sinceRevision:bq}).success(function(by){var bA=by.output,bz=bA.deletedDeviceIDs||[];x=bA.revision;bA.devices.forEach(function(bB){bu=aK(bB);bs=C(bB.deviceID);if(bs){ay(bs.deviceID,bu)}else{bu.hasChanges=true;V.push(bu)}});bz=am.difference(bz,am.map(bA.devices,"deviceID"));if(bz.length){t.byEvents=am.union(t.byEvents,bz);bz.forEach(n)}M.resolve()}).error(function(by){console.error(o.actionFailed({action:"GetDevices",result:JSON.stringify(by,null,2)}))});if(az.isGuestNetworkEnabled){if(W.GetGuestNetworkClients){bx.add("/guestnetwork/GetGuestNetworkClients").success(function(by){var bz=by.output.clients,bB=false,bA;bz.forEach(function(bC){bu=aS(bC);bs=C(bu.deviceID);if(!bs){bu.hasChanges=true;V.push(bu)}});bb().forEach(function(bC){bB=bz.some(function(bD){return bD.macAddress===bC.macAddress});if(!bB){n(bC.deviceID)}else{for(bA=0;bA<V.length;bA++){bu=V[bA];if(!bu.isGuest&&bu.knownMACAddresses.indexOf(bC.macAddress)!==-1){if(bu.isOnline){n(bC.deviceID)}else{n(bu.deviceID)}break}}}});ad.resolve()}).error(function(by){console.error(o.actionFailed({action:"GetGuestNetworkClients",result:JSON.stringify(by,null,2)}))})}else{ad.resolve()}bx.add("/router/GetDHCPClientLeases").success(function(by){a2.when(M,ad).done(function(){by.output.leases.forEach(function(bz){bu=T(bz.macAddress);if(bu&&bu.isGuest&&bu.deviceName===a3){bu.friendlyName=bz.hostName;bu.hasChanges=true}});a.resolve()})}).error(function(by){console.error(o.actionFailed({action:"GetDHCPClientLeases",result:JSON.stringify(by,null,2)}))})}else{ad.resolve();a.resolve()}bx.send(bv).success(function(){var by=false;if(W.NodesDiagnostics2){ao.send("/nodes/diagnostics/GetBackhaulInfo").success(function(bz){a2.when(M).done(function(){bz.output.backhaulDevices.forEach(function(bB){var bA=C(bB.deviceUUID);if(bA){bA.backhaulInfo=bB}});e.resolve()})}).error(function(bz){console.error(o.actionFailed({action:"GetBackhaulInfo",result:JSON.stringify(bz,null,2)}));e.resolve()})}else{e.resolve()}if(br.doGetNetworkConnectionsInMainUpdate&&W.NodesNetworkConnections){ao.send("/nodes/networkconnections/GetNodesWirelessNetworkConnections",{},bv).success(ak).error(function(bz){console.error(o.actionFailedAddData({action:"GetNodesWirelessNetworkConnections",result:JSON.stringify(bz,null,2),additionalData:"Continuing"}));ak()})}a2.when(M,ad,a,ax,e).done(function(){if(x<bq){console.warn(o.lastRevisionReset({lastRevision:x,sinceRevision:bq}));V.forEach(function(bz){if(t.byEvents.indexOf(bz.deviceID)===-1){t.byEvents.push(bz.deviceID)}});a7();z(0,bw,true);return}am.forEachRight(V,function(bz){if(!bz.isAuthority&&bz.knownMACAddresses.indexOf(Z)>-1){am.remove(bz.knownMACAddresses,function(bA){return bA===Z});if(bz.knownMACAddresses.length===0){n(bz.deviceID)}}});if(bq>0&&(br.notifyOnEveryPoll||V.some(bg)||t.byLogic.length)){by=true}bw.resolve({devices:V,doNotify:by})})}).error(function(by){console.error(o.actionFailed({action:"updateDeviceList - Transaction failed",result:JSON.stringify(by,null,2)}));M=null;ad=null;a=null;ax=null;bw.reject(by)})});return bw}function X(){V.forEach(function(bp){bp.hasChanges=false});t.byLogic=[]}function bd(){am.forEachRight(t.byEvents,function(br,bq){if(!am.isEmpty(C(br))){t.byEvents.splice(bq,1)}});var bp={changedDevices:am.filter(V,"hasChanges"),deletedDeviceIDs:am.union(t.byLogic,t.byEvents)};X();return bp}function bl(bq,br){var bp=ao.Deferred();br=br||false;if(!h.doPolling||bq){z(bq?0:x,null,br).success(function(bs){bp.resolve(bs.devices)}).error(function(bs){console.error(o.actionFailed({action:"getDevices",result:JSON.stringify(bs,null,2)}));bp.reject(bs)})}else{bp.resolve(V)}return bp}function ag(){var bp=ao.Deferred();z(x).success(function(){bp.resolve(bd())}).error(function(bq){console.error(o.actionFailed({action:"getDeviceChanges",result:JSON.stringify(bq,null,2)}));bp.reject(bq)});return bp}function C(bq){var bp,br;if(am.isEmpty(bq)){throw"getDeviceByID - Need to pass a Device ID"}bp=am.find(V,{deviceID:bq});if(!bp){br=am.map(am.chunk(bq.toUpperCase().substr(24),2),function(bs){return bs.join("")}).join(":");if(br){bp=T(br)}}return bp}function P(bq){var bp,bs,br;if(am.isEmpty(bq)){throw"getDeviceByIPAddress - Need to pass an IP Address"}for(bp=0;bp<V.length;bp++){br=V[bp];for(bs=0;bs<br.connections.length;bs++){if(br.connections[bs].ipAddress===bq){return br}}}}function T(bq){var bp,bs,br;if(am.isEmpty(bq)){throw"getDeviceByMACAddress - Need to pass a MAC Address"}for(bp=0;bp<V.length;bp++){br=V[bp];for(bs=0;bs<br.knownMACAddresses.length;bs++){if(br.knownMACAddresses[bs]===bq){return br}}}}function a7(){V=[];x=0}function N(){return am.find(V,{isAuthority:true})}function bc(){return V.filter(function(bp){return !bp.isGuest&&!bp.isAuthority})}function bb(){return V.filter(function(bp){return bp.isGuest})}function a4(){return am.find(V,{nodeType:"Master"})||N()}function f(){return V.filter(function(bp){return bp.nodeType==="Slave"})}function af(){var bq=a4(),bp=f();if(bq){bp.unshift(bq)}return bp}function aI(br){var bp=ao.Deferred(),bq;br=br.replace(/:/g,"").toLowerCase();ao.send("/nodes/setup/GetConnectedNodesDeviceID",{}).success(function(bs){bq=am.find(bs.output.deviceIDs,function(bt){return am.endsWith(bt.toLowerCase(),br)});bp.resolve(bq)}).error(function(bs){console.error(o.actionFailed({action:"GetConnectedNodesDeviceID",result:JSON.stringify(bs,null,2)}));bp.reject(bs)});return bp}function bh(bp){var bq=a4(),bs=f(),br=am.map(bs,"deviceName");if(am.isEmpty(bp)){throw"isNodeNameUnique - Need to pass a deviceName string to check against"}if(bq){br.push(bq.deviceName)}return br.indexOf(bp)===-1}function s(bp,bq){ao.send("/nodes/networkconnections/GetNodesWirelessNetworkConnections",{}).success(function(br){ak(br);bp(bd());aR=setTimeout(function(){s(bp,bq)},bq)}).error(function(br){console.error(o.actionFailed({action:"GetNodesWirelessNetworkConnections",result:JSON.stringify(br,null,2)}))})}function a0(bq,br){var bp=ao.Deferred();if(W.NodesNetworkConnections){ao.send("/nodes/networkconnections/RefreshNodesWirelessNetworkConnections",{}).success(function(){console.info(o.general({message:"Starting NodesNetworkConnections Refresh"}));if(!aR){if(!br||br<aC){br=aC}console.info(o.startNodesConnectionPolling({timeout:br}));aR=setTimeout(function(){s(bq,br)},br)}bp.resolve()}).error(function(bs){console.error(o.actionFailed({action:"RefreshNodesWirelessNetworkConnections",result:JSON.stringify(bs,null,2)}));bp.reject(bs)})}else{bp.resolve()}return bp}function ap(){if(aR){console.info(o.general({message:"Stopping NodesNetworkConnections polling"}));clearTimeout(aR);aR=null}}function aj(bq){var bp=ao.Deferred(),bs=ao.Deferred(),br=[];function bt(bu){br.push(bu);n(bu)}if(!am.isEmpty(bq)&&!am.isArray(bq)){throw"deleteOfflineDevices - First argument should be an array of DeviceIDs"}if(am.isEmpty(bq)){bq=[];V.forEach(function(bu){if(!bu.isOnline){bq.push(bu.deviceID)}})}bq.forEach(function(bv,bu){ao.send("/devicelist/DeleteDevice",{deviceID:bv}).success(function(){bt(bv)}).error(function(bw){console.error(o.actionFailedAddData({action:"Error trying to delete Device by ID",result:JSON.stringify(bw,null,2),additionalData:bv}));if(bw.result==="ErrorUnknownDevice"){bt(bv)}}).always(function(){if(bu===bq.length-1){bs.resolve()}})});a2.when(bs).done(function(){bp.resolve(br)});return bp}function ba(){return V.filter(function(bp){return !bp.isOnline})}function aW(){bi();ah=setInterval(function(){z(x).success(function(bp){if(bp.doNotify){if(h.notifyWithChanges){ai.notify(bd())}else{ai.notify(bp.devices)}}}).error(function(bp){console.error(o.actionFailed({action:"Device Polling failed",result:JSON.stringify(bp,null,2)}));ai.notify(bp)})},h.pollingFrequencyMs)}function bi(){a9=0;if(ah){clearInterval(ah);ah=null}}function aF(bp){var bq=h.pollingFrequencyMs;if(am.isEmpty(bp)||!am.isObject(bp)){throw"setOptions - Need to pass an object of options; call getOptions() to see format"}h=am.merge(h,bp);console.info(o.general({message:"Updated options: "+JSON.stringify(h,null,2)}));if(h.doPolling){a9--;if(a9>0){return}a9=0;if(!ai){ai=ao.Deferred()}if(x>0){if(!ah){aW()}else{if(bq!==h.pollingFrequencyMs){bi();aW()}}}}else{if(h.doPolling===false){a9++;bi();return}}return ai}function aN(){console.warn(o.general({message:"Resetting options back to base"}));bi();ap();h={doPolling:false,doGetNetworkConnectionsInMainUpdate:true,notifyWithChanges:false,notifyOnEveryPoll:false,pollingFrequencyMs:0,supportedForCaching:{}}}function F(){return am.cloneDeep(h)}function i(){if(!aA){aV()}return am.cloneDeep(W)}function u(){var bp=ao.Deferred();ao.send("/guestnetwork/GetGuestNetworkSettings",{}).success(function(bq){if(!bq.output.isGuestNetworkEnabled&&az.isGuestNetworkEnabled){bb().forEach(function(br){n(br.deviceID)})}az=bq.output;if(!ao.isServiceSupported("/guestnetwork/GuestNetwork3")){az.radios=[{radioID:"RADIO_2.4GHz",guestSSID:az.guestSSID}]}if(ao.isServiceSupported("/guestnetwork/GuestNetwork4")){W.GetGuestNetworkClients=az.isGuestNetworkACaptivePortal}bp.resolve()}).error(function(bq){console.error(o.actionFailed({action:"GetGuestNetworkSettings",result:JSON.stringify(bq,null,2)}));bp.reject(bq)});return bp}function aY(){var bp=ao.Deferred();ao.send("/wirelessap/GetRadioInfo",{}).success(function(bq){m=bq.output;bp.resolve()}).error(function(bq){console.error(o.actionFailed({action:"GetRadioInfo",result:JSON.stringify(bq,null,2)}));bp.reject(bq)});return bp}function j(){var bp=ao.Deferred();ao.send("/router/GetLANSettings",{}).success(function(bq){H=bq.output;bp.resolve()}).error(function(bq){console.error(o.actionFailed({action:"GetLANSettings",result:JSON.stringify(bq,null,2)}));bp.reject(bq)});return bp}function aU(){W={GetDevices3:false,GuestNetwork4:false,GetGuestNetworkClients:false,NodesSetup:false,NodesNetworkConnections:false,NodesDiagnostics2:false}}function aV(){W.GetDevices3=ao.isServiceSupported("/devicelist/DeviceList4");W.GuestNetwork4=ao.isServiceSupported("/guestnetwork/GuestNetwork4");W.GetGuestNetworkClients=ao.isServiceSupported("/guestnetwork/GuestNetwork2")||ao.isServiceSupported("/guestnetwork/GuestNetwork3");W.NodesSetup=ao.isServiceSupported("/nodes/setup/Setup");W.NodesNetworkConnections=ao.isServiceSupported("/nodes/networkconnections/NodesNetworkConnections");W.NodesDiagnostics2=ao.isServiceSupported("/nodes/diagnostics/Diagnostics2")}function J(){var bp=ao.Deferred(),bq=u(),bs=aY(),br=j();a2.when(bq,bs,br).done(function(){bp.resolve()}).fail(function(bt){console.error(o.actionFailed({action:"updateRouterSettings",result:JSON.stringify(bt,null,2)}));bp.reject(bt)});return bp}function S(){H={dhcpSettings:{reservations:[]}};az={radios:[]};m={radios:[]}}function au(bp){var bs=a2.Deferred();function bq(bt){return am.result(bt,"state","[Not a Deferred]")}console.warn(o.general({message:"Entered Reset"}));var br=function(){console.warn(o.general({message:"Resetting Device Manager"}));M=null;ad=null;a=null;ax=null;e=null;ao.unsubscribe("/guestnetwork/SetGuestNetworkSettings",u);ao.unsubscribe("/wirelessap/SetRadioSettings",aY);ao.unsubscribe("/router/SetLANSettings",j);a7();S();aU();aN();aA=false;bs.resolve()};if(bp){console.warn(o.generalAddData({message:"Forcing Reset (states of: dfdGetDevices, dfdGetGuests, dfdGetClientLeases, dfdGetNetworkConnections, dfdGetBackhaulInfo)",additionalData:bq(M)+" : "+bq(ad)+" : "+bq(a)+" : "+bq(ax)+" : "+bq(e)}));br()}else{a2.when(M,ad,a,ax,e).done(function(){br()})}return bs}function aE(){var bp=ao.Deferred();if(aA){console.warn(o.actionFailed({action:"init",result:"Device Manager has already been initialized, skipping"}));return bp.resolve([])}aA=true;aV();J().success(function(){if(h.doPolling){bp.success(aW)}z(0).success(function(bq){bp.resolve(bq.devices)}).error(function(bq){console.error(o.actionFailed({action:"init - updateDeviceList",result:JSON.stringify(bq,null,2)}));bp.reject(bq)});ao.subscribe("/guestnetwork/SetGuestNetworkSettings",u);ao.subscribe("/wirelessap/SetRadioSettings",aY);ao.subscribe("/router/SetLANSettings",j)}).error(function(bq){console.error(o.actionFailed({action:"init - updateRouterSettings",result:JSON.stringify(bq,null,2)}));bp.reject(bq)});return bp}S();aN();return{init:aE,reset:au,updateRouterSettings:J,setOptions:aF,getOptions:F,getRouterSupport:i,resetOptions:aN,clearDeviceList:a7,clearDeviceChanges:X,findDeviceIcon:ae,findDeviceName:b,getDevices:bl,getDeviceChanges:ag,getCurrentChanges:bd,getDeviceByID:C,getDeviceByIPAddress:P,getDeviceByMACAddress:T,getCurrentAuthorityDevice:N,getMainNetworkDevices:bc,getGuestNetworkDevices:bb,getOfflineDevices:ba,deleteOfflineDevices:aj,matchDevices:aH,nodes:{getMaster:a4,getSlaves:f,getAll:af,isNameUnique:bh,getUUIDByMACAddress:aI,startNetworkConnectionsPolling:a0,stopNetworkConnectionsPolling:ap}}}));