if(!window.RAINIER){window.RAINIER={}}var basePath="/cloud/remote-access-service/rest/remoteassistance",loginPage=$.cookie("agent-auth-token")?"/ui/dynamic/agent-login.html":"/",timer,remoteassistance={remoteassistancesession:{remoteAssistanceSessionId:null,pin:null,status:"INVALID"}},sessionStatusInterval;function _remoteErrorHandler(c,a){var e;switch(c){case"_ErrorNetworkUnreachable":e=RAINIER.login.strings.remoteAssistance.errorNetworkUnreachable;break;case"_ErrorUnauthorized":e=RAINIER.login.strings.remoteAssistance.errorUnauthorized;break;case"_ErrorUnknownTarget":e=RAINIER.login.strings.remoteAssistance.errorUnknownTarget;break;case"UNKNOWN":e=RAINIER.login.strings.cloudUnavailable;break;case"invalidPin":e=RAINIER.login.strings.remoteAssistance.invalidPin;break;case"expiredSession":e=RAINIER.login.strings.remoteAssistance.expiredSession;break;default:e=RAINIER.login.strings.unexpectedError;break}var b=$("#generic-dialog-template").clone(),d={parent:$("#error-dialog-wrapper"),dlgClass:"error-dialog",isError:true,onClose:function(){if(typeof a==="function"){a()}}};b.find(".dialog-header h1").text(RAINIER.generic.strings.genericErrorHeaderTitle);b.find(".dialog-content").text(e);RAINIER.ui.dialog(b,d).show()}RAINIER.remote=RAINIER.remote||{};RAINIER.remote.assistance=RAINIER.remote.assistance||(function(){var n=null,q=null,l=null,p=null;function f(t,v,s){var u={remoteassistancesession:{session:{account:{username:t.username,password:t.password}},serialNumber:t.serialnumber,forceCreate:v}};RAINIER.ui.wait();RAINIER.cloud.send({url:basePath+"/sessions",type:"POST",data:u,cb:function(w){if(w.error){if(w.result==="INVALID_PARAMETER"||w.result==="DUPLICATE_ASSISTANCE_SESSION"){s(w.result);return}s(false);_remoteErrorHandler(w.result);return}$.cookie("agent-auth-token",$.cookie("user-auth-token"),{expires:null,path:"/"});$.cookie("temp-user-auth-token",w.remoteAssistanceSession.session.token,{expires:null,path:"/"});$.cookie("user-auth-token",w.remoteAssistanceSession.session.token,{expires:null,path:"/"});$.cookie("admin-auth",null,{path:"/"});$.cookie("agent-remote-assistance-session",JSON.stringify({id:w.remoteAssistanceSession.remoteAssistanceSessionId,token:w.remoteAssistanceSession.session.token,serialNumber:t.serialnumber}),{expires:null,path:"/"});RAINIER.network.setRemoteSetting(true);s(true)},cbError:Account.loginErrorHandler})}function d(s){if($.cookie("agent-remote-assistance-session")){var t=RAINIER.util.parseJSON($.cookie("agent-remote-assistance-session"));s(t?t.id:null);return}if($.cookie("client-remote-assistance-session")){var t=RAINIER.util.parseJSON($.cookie("client-remote-assistance-session"));s(t?t.id:null);return}RAINIER.cloud.send({url:basePath+"/sessions",type:"GET",data:{},cb:function(u){RAINIER.ui.hideWaiting();remoteassistance.remoteassistancesession.remoteAssistanceSessionId=null;if(!u.error&&u.remoteAssistanceSessions.length){remoteassistance.remoteassistancesession.remoteAssistanceSessionId=u.remoteAssistanceSessions[0].remoteAssistanceSession.remoteAssistanceSessionId}if(typeof s==="function"){s(remoteassistance.remoteassistancesession.remoteAssistanceSessionId)}},cbError:function(){if(typeof s==="function"){s(null)}return true}})}function g(v,t){var s=$("#customer-blocking-dialog .current-time");function u(){var w=timer.getElapsedTimeS()+t,x=Math.floor(w/60),y=w-(x*60);s.text(RAINIER.util.addALeadingZero(x)+":"+RAINIER.util.addALeadingZero(y));if(w<v){setTimeout(u,1000)}else{timer.stop();m("sessionEnded")}}u()}function h(){function s(){o(function(v){if(!v||(v&&v.result==="SESSION_NOT_EXIST"||v.result==="_ErrorUnknownSession")){m("sessionEnded");return}if(v&&v.readyState===0){return}var t=v.remoteAssistanceSession.status;if(t==="ACTIVE"){if($.cookie("client-remote-assistance-session")&&!n.isShowing()){var u=Math.abs(v.remoteAssistanceSession.expiredIn),y=v.remoteAssistanceSession.createdAt,x=v.remoteAssistanceSession.currentTime,w=Math.floor((x-y)/1000);RAINIER.event.fire("connection.disableCheck");q.close();timer=new RAINIER.util.timer();timer.start();g(u,w);n.show()}}else{if(t==="INVALID"){m("invalidSession")}else{if(t!=="PENDING"){m("sessionEnded")}}}})}sessionStatusInterval=setInterval(s,7000)}function o(s){d(function(t){if(!t){RAINIER.ui.hideWaiting();if(typeof s==="function"){s(null)}return}RAINIER.cloud.send({url:basePath+"/sessions/"+t,type:"GET",data:{},cb:function(u){RAINIER.ui.hideWaiting();if(!u.error){remoteassistance.remoteassistancesession.remoteAssistanceSessionId=u.remoteAssistanceSession.remoteAssistanceSessionId;remoteassistance.remoteassistancesession.status=u.remoteAssistanceSession.status}if(typeof s==="function"){s(u)}},cbError:function(u){if(typeof s==="function"){s(u)}return true}})})}function e(){RAINIER.ui.wait();function s(){if(!remoteassistance.remoteassistancesession.remoteAssistanceSessionId){$.cookie("client-remote-assistance-session",null,{path:"/"});l.show();return}RAINIER.cloud.send({url:basePath+"/sessions/pin",type:"POST",data:{remoteassistancesession:{remoteAssistanceSessionId:remoteassistance.remoteassistancesession.remoteAssistanceSessionId}},cb:function(t){if(!t||t.error){$.cookie("client-remote-assistance-session",null,{path:"/"});l.show()}else{remoteassistance.remoteassistancesession.id=t.remoteAssistanceSession.remoteAssistanceSessionId;remoteassistance.remoteassistancesession.pin=t.remoteAssistanceSession.pin;remoteassistance.remoteassistancesession.status=t.remoteAssistanceSession.status;$("#access-code").text(t.remoteAssistanceSession.pin);$.cookie("client-remote-assistance-session",JSON.stringify({id:remoteassistance.remoteassistancesession.remoteAssistanceSessionId,pin:t.remoteAssistanceSession.pin,status:t.remoteAssistanceSession.status}),{expires:null,path:"/"});q.show();h()}}})}if(!$.cookie("client-remote-assistance-session")){o(s)}else{s()}}function j(){o(function(s){RAINIER.ui.allowDialogs=true;if(!s||s.error){m("sessionEnded");return}if(s.remoteAssistanceSession.status==="ACTIVE"){h()}})}function k(){o(function(s){if(!remoteassistance.remoteassistancesession.remoteAssistanceSessionId){return}if(s.remoteAssistanceSession.status==="ACTIVE"){$.cookie("client-remote-assistance-session",JSON.stringify({id:remoteassistance.remoteassistancesession.remoteAssistanceSessionId}),{expires:null,path:"/"});h()}})}function a(u,s){var t=RAINIER.util.parseJSON($.cookie("agent-remote-assistance-session"));if(!t){_remoteErrorHandler("invalidPin",s);return}RAINIER.cloud.send({url:basePath+"/temporaryras",type:"POST",data:{remoteAssistanceSession:{remoteAssistanceSessionId:t.id,pin:u}},cb:function(v){if(v.error){_remoteErrorHandler("invalidPin",s);return}RAINIER.network.setCurrentNetworkID(v.temporaryRAS.networkId);$.cookie("user-auth-token",v.temporaryRAS.sessionToken,{expires:null,path:"/"});window.location.replace("/ui/dynamic/home.html")}})}function c(u,s){var t=u||remoteassistance.remoteassistancesession.remoteAssistanceSessionId;RAINIER.cloud.send({url:basePath+"/sessions",type:"delete",data:{remoteAssistanceSession:{remoteAssistanceSessionId:t}},cb:function(v){if(typeof s==="function"){s(v)}},cbError:function(v){if(typeof s==="function"){s(v)}return true}})}function i(t){function u(){$.cookie("agent-remote-assistance-session",null,{path:"/"});RAINIER.event.fire("connection.enableCheck");RAINIER.ui.hideWaiting();if(!t){window.location.replace(loginPage)}}function s(w){var v=new $.Deferred();RAINIER.network.deleteUserSession(function(){$.cookie(w,null,{path:"/"});v.resolve()},$.cookie(w));return v}RAINIER.ui.wait();if($.cookie("agent-auth-token")){$.cookie("user-auth-token",null,{path:"/"});$.cookie("current-network-id",null,{path:"/"});$.when(s("temp-user-auth-token"),s("agent-auth-token")).then(u)}else{u()}}function m(s){clearInterval(sessionStatusInterval);if(n){n.close()}RAINIER.ui.wait();c(null,function(){if(s){RAINIER.event.fire("connection.disableCheck")}$.cookie("client-remote-assistance-session",null,{path:"/"});$.cookie("current-applet",null,{path:"/"});RAINIER.ui.hideWaiting();if(s==="sessionEnded"){p.show()}else{if(s==="invalidSession"){_remoteErrorHandler("expiredSession",i)}else{i()}}RAINIER.ui.allowDialogs=false})}function r(){$("#pin-request-dialog .toggle-link").click(function(){var s=$(this);s.toggleClass("down");s.siblings(".terms").toggleClass("hidden");$("#pin-request-dialog").css("top",s.hasClass("down")?"75px":"150px")});$("#pin-request-dialog .close-button").click(function(){q.close();remoteassistance.remoteassistancesession.remoteAssistanceSessionId=null;remoteassistance.remoteassistancesession.pin=null;$.cookie("client-remote-assistance-session",null,{path:"/"});clearInterval(sessionStatusInterval)});$("#customer-blocking-dialog .close").click(m);$("#unavailable-remote-assistance-dialog .cancel").click(l.close);$("#session-ended-dialog .close-button").click(p.close)}function b(){n=RAINIER.ui.dialog($("#customer-blocking-dialog"));q=RAINIER.ui.dialog($("#pin-request-dialog"));l=RAINIER.ui.dialog($("#unavailable-remote-assistance-dialog"));p=RAINIER.ui.dialog($("#session-ended-dialog"),{btns:$("#session-ended-dialog .form li"),onClose:i});r();if($.cookie("agent-remote-assistance-session")){j()}else{k()}}return{initialize:b,endRemoteAssistanceSession:m,getRemoteAssistanceSession:o,deleteUserSessions:i,deleteRemoteAssistanceSession:c,createRemoteAssistanceSession:f,startRemoteAccessSession:a,requestRemoteAssistancePin:e}}());