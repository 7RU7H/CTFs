(function(){var a=$("#external-storage-widget"),e=RAINIER.applets.USBStorage,h=RAINIER.ui.template.createTemplate(a.find("#template-partition > li")),c=RAINIER.ui.template.createTemplate(a.find("#template-unsupported-partition > li")),b=RAINIER.ui.template.createTemplate(a.find("#template-no-drives > li")),f="96015299-6364-4ABE-A68E-969E5BE093E9",g="0482141A-5B9F-42E0-B980-A48EA914BC27";function i(){var m=RAINIER.connect.AppletManager.getAppletById(f);if(m){RAINIER.ui.MainMenu.launchApplet(m,"","external-storage")}else{console.warn("Widget: cannot locate external storage applet")}}function j(){deviceManager.getDevices(true,true).success(function(){var o={},m={},n=RAINIER.jnap.Transaction({onComplete:p});n.add({action:"/jnap/nodes/storage/GetStorageCapabilities",data:{},cb:function(q){if(q.result==="OK"){o=q.output}}});n.add({action:"/jnap/nodes/storage/GetNodesPartitions",data:{},cb:function(r){var q;if(r.result==="OK"){m=r.output.storageNodes;$.each(m,function(s,t){t.deviceName=deviceManager.getDeviceByID(t.deviceID).deviceName});q=deviceManager.nodes.getMaster();m.sort(function(t,s){return t.deviceID===q.deviceID?-1:s.deviceID===q.deviceID?1:0})}}});n.send();function p(){var q=0;a.find("#partition-list > ul").empty();$.each(m,function(r,s){$.each(s.storageDevices,function(t,v){var u;if(v.partitionTableFormat==="Unsupported"){u=RAINIER.ui.template.createBlock(c,s,{});u.css("transform","translateX("+(q*100)+"%)");q++;a.find("#partition-list > ul").append(u)}else{$.each(v.partitions,function(w,x){var y=x.usedKB+x.availableKB;if(x.fileSystem==="Unsupported"){u=RAINIER.ui.template.createBlock(c,s,{})}else{u=RAINIER.ui.template.createBlock(h,s,{});if(o.supportedReadOnlyFileSystems.indexOf(x.fileSystem)>-1){u.find(".partition-read-only-icon").show()}u.find("progress").attr("max",y).attr("value",x.usedKB);if(x.usedKB/y>0.95){u.find("progress").addClass("high-usage")}u.find(".storageInfo").text(u.find(".storageInfo").text().replace("{storageUsed}",e.humanFileSize(x.usedKB*1024)).replace("{storageAvailable}",e.humanFileSize(y*1024)))}u.css("transform","translateX("+(q*100)+"%)");q++;a.find("#partition-list > ul").append(u)})}})});if(q===0){a.find("#partition-list > ul").append(RAINIER.ui.template.createBlock(b,{},{}));a.find("#pagination").hide()}else{a.find("#pagination").show()}l.init()}})}var l=(function(){var n=a.find("#partition-list > ul"),m=a.find("#page-numbers"),o=o||a.find("#page-numbers").text(),p=1,q=0;return{init:function(){var r=n.find("li").length;if(r>q){this.next()}q=r;this.updatePageNumbers()},updatePageNumbers:function(){m.text(o.replace("{pageNumber}",p).replace("{totalPages}",q))},next:function(){if(p>=q){p=1}else{p++}n.css("transform","translateX("+(p-1)*-100+"%)");this.updatePageNumbers()},previous:function(){if(p<=1){p=q}else{p--}n.css("transform","translateX("+(p-1)*-100+"%)");this.updatePageNumbers()}}})();function d(){l.init();a.find("#back-button").on("click",function(){l.previous()});a.find("#forward-button").on("click",function(){l.next()})}function k(){a.find("#external-storage-applet-link").click(function(){i();return false});a.find(".refresh-button").click(function(){j();return false});j();d();setInterval(j,120000);RAINIER.event.connect("externalstorage.updated",function(){j()})}k()}());