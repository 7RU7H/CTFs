(function(){var G=RAINIER.util.getDaysOfWeek(),E="000000000000000000000000000000000000000000000000",I="111111111111111111111111111111111111111111111111",x=$("#parentalcontrols-applet"),j=x.find("#idRadioBlockNever"),d=x.find("#idRadioBlockCustom"),y=x.find("#idRadioBlockAlways"),N=x.find("#idLinkBlockInetAccessEdit"),z=x.find("#deviceSelection"),H=$("#blockInternetAccessNet"),M=H.find(".currentTime span"),C=null,w=null,o=500,A=null,u;var f={parentalControlSettings:{},parentalControlSettingsSetup:{},devices:[]},p={},s={isEnabled:0,description:"default description",macAddresses:[],blockedURLs:[],wanSchedule:RAINIER.blockScheduler.defaultRule()};var q={onSpecificTimeBlockingPopupRequested:function(){var O=c();if(!O){return}if($(N).hasClass("disabledLink")){return}C=RAINIER.ui.dialog(H,{onShow:function(){clearTimeout(w);J();RAINIER.blockScheduler.init();RAINIER.blockScheduler.setCheckedCellsPol(O.getRule().wanSchedule)},onSubmit:function(){O=c().setWanSchedule(RAINIER.blockScheduler.getAccessSchedule());return true}});C.show()},onSpecificSiteEntered:function(P){var O=P.keyCode||P.which;if(O===13){if(a()){m()}}else{if(P.keyCode===27){$("#input-blocked-website").hide("fast",function(){$("#idBtnAddBlackListItem").show()})}}},onAddBlockSpecificSiteClicked:function(){$(this).hide();p.blockedSite.enable();x.find("#input-blocked-website").fadeIn("fast");x.find("#idTextAddBlackListItem").focus()},onNeverRadioButtonClicked:function(){j.attr("checked","checked");N.add("#blockRadios .pipe").fadeOut("slow")},onCustomRadioButtonClicked:function(){d.attr("checked","checked");N.add("#blockRadios .pipe").fadeIn("fast")},onAlwaysRadioButtonClicked:function(){y.attr("checked","checked");N.add("#blockRadios .pipe").fadeOut("slow")},onDeviceSelected:function(){z.find("> li").removeClass("selected");$(this).addClass("selected");$("#blockRadios input[type=radio]").removeAttr("disabled");if($(this).data().getRule().isEnabled===1){d.click()}else{if($(this).data().getRule().isEnabled===2){y.click()}else{j.click()}}x.find("#idSpanSiteBlackList").children().remove();L("idSpanSiteBlackList",$(this).data().getRule().blockedURLs||[]);b($(this).data().getRule().blockedURLs.length);x.find("#blockRadios input[type=radio]").removeAttr("disabled");x.find("#input-blocked-website").hide(0,function(){x.find("#idTextAddBlackListItem").val("");p.blockedSite.reset();p.blockedSite.disable()})},onClose:function(){RAINIER.ui.MainMenu.closeApplet()},onSave:function(){l()}};var F=(function(){function P(R){if(!R||!R.length||!f.devices.length){return}var S=f.parentalControlSettings,Q;$.each(R,function(U,T){S.rules.forEach(function(V,X){var W=X.macAddresses||[];W.forEach(function(Y,Z){if(Z===T){Q=X;return false}})})});return Q}var O={getRule:function(){var Q=this.data.rule||P(this.data.knownMACAddresses);if(Q&&!this.data.rule){this.data.rule=Q}Q=Q||jQuery.extend(true,{},s);Q.macAddresses=this.data.knownMACAddresses;return Q},setWanSchedule:function(Q){this.data.rule=this.getRule();this.data.rule.wanSchedule=Q},setBlockedURLs:function(Q){this.data.rule=this.getRule();this.data.rule.blockedURLs=Q},setInternetAccess:function(Q){this.data.rule=this.getRule();this.data.rule.isEnabled=Q}};return function(Q){var R={data:Q.data,deviceName:Q.friendlyName()};$.extend(R,O);return R}})();function D(R){var O=0,Q=0;for(var P in R.wanSchedule){if(R.wanSchedule[P]===I){O++}else{if(R.wanSchedule[P]===E){Q++}}}if(O===7){return 0}else{if(Q===7){return 2}else{return 1}}}function c(){return z.find("> li.selected").data()}function r(O){function R(W,Y){var X={deviceID:Y.data.deviceID,friendlyName:Y.deviceName};var T='<li id="{deviceID}">{friendlyName}</li>'.formatObj(X),V=$(T);V.attr("tooltip",X.friendlyName);RAINIER.ui.tooltip.add(V);V.click(q.onDeviceSelected);V.data(Y);for(var U=0;U<f.parentalControlSettings.rules.length;U++){if(f.parentalControlSettings.rules[U].macAddresses[0]===Y.data.knownMACAddresses[0]){Y.data.rule=f.parentalControlSettings.rules[U];if(f.parentalControlSettings.rules[U].isEnabled){V.data().setInternetAccess(D(Y.data.rule))}else{V.data().setInternetAccess(0)}V.data(Y)}}W.append(V)}var P=[],Q;for(Q=0;Q<O.length;Q++){var S=F(O[Q]);P.push(S)}P.sort(function(U,T){return(U.friendlyName<T.friendlyName)?-1:(U.friendlyName===T.friendlyName?0:-1)});z.text("");for(Q=0;Q<P.length;Q++){R(z,P[Q])}RAINIER.event.fire("applet.loaded")}String.prototype.flattenURL=function(){var Q="",O=this.split(".");for(var P=0;P<O.length;P++){Q+=O[P]}return Q};function k(O){O.mouseover(function(){$(this).find(".visualInfoRemove").show()});O.mouseout(function(){$(this).find(".visualInfoRemove").hide()});O.find(".visualInfoRemove").click(function(){e(this,true)})}function t(){if(A){var O=new Date(Date.now()-u);M.html(RAINIER.util.getTimeFromRouterDateString(O));w=setTimeout(t,o)}}function J(){RAINIER.network.getRouterCurrentTime(function(O){A=RAINIER.util.routerTimeToDate(O);u=Date.now()-A;t()})}function L(O,Q){var S=null,R="";for(var P=0;P<Q.length;P++){R=Q[P].flattenURL();S=$('<div id="'+R+'_remove_container" class="siteListContainer" ><span>'+Q[P]+'</span><a class="visualInfoRemove" id="'+R+'_remove"></a></div>');k(S);$("#"+O).append(S)}}function b(O){if(O<f.parentalControlSettingsSetup.maxRuleBlockedURLs){x.find("#idBtnAddBlackListItem").show()}else{x.find("#idBtnAddBlackListItem").hide()}}function e(P){$(P).parent().remove();var O=[];$("#idSpanSiteBlackList > div > span").each(function(Q){O[Q]=$(this).text()});c().setBlockedURLs(O);b(O.length)}function m(){function P(U,Q,R){var T=$("#"+U)[0],S=RAINIER.applets.ParentalControls.formatBlockedURL(T.value,f.parentalControlSettingsSetup.maxRuleBlockedURLLength);if(S===""){return}Q.push(S);var W=Q[Q.length-1].flattenURL();var V=$('<div id="'+W+'_remove_container" class="siteListContainer"><span>'+Q[Q.length-1]+'</span><a class="visualInfoRemove" id="'+W+'_remove"></a></div>');k(V);$("#"+R).append(V)}P("idTextAddBlackListItem",[],"idSpanSiteBlackList");var O=[];$("#idSpanSiteBlackList > div > span").each(function(Q){O[Q]=$(this).text()});c().setBlockedURLs(O);b(O.length);if($("input[name=BlockInternetAccessGroup]:checked").length===0){$("#idRadioBlockAlways").attr("checked","checked");if($("#idRadioBlockAlways").data().getRule!==undefined){$("#idRadioBlockAlways").data().getRule().isEnabled=1}}x.find("#idTextAddBlackListItem:visible").val("");x.find("#input-blocked-website").hide()}function a(){return p.blockedSite.isValid(true)}function v(){function O(T){var S=RAINIER.applets.ParentalControls.formatBlockedURL(T,f.parentalControlSettingsSetup.maxRuleBlockedURLLength),Q=c().getRule().blockedURLs;for(var R=0;R<Q.length;R++){if(S.toLowerCase()===Q[R].toLowerCase()){return false}}return true}var P={maxLen:f.parentalControlSettingsSetup.maxRuleBlockedURLLength,validCharSet:"ascii",whiteSpace:false};p.blockedSite=RAINIER.ui.buildInputValidBalloon($.extend(true,{},P,{els:x.find('input[id="idTextAddBlackListItem"]'),errors:[{test:O,when:false,message:RAINIER.ui.validation.strings.parentalControls.duplicatedBlockedSite}]}))}function K(){j.click(q.onNeverRadioButtonClicked);d.click(q.onCustomRadioButtonClicked);y.click(q.onAlwaysRadioButtonClicked);x.find("footer .submit").click(q.onSave);x.find("footer .cancel").click(q.onClose);x.find("#idTextAddBlackListItem").keyup(q.onSpecificSiteEntered);x.find("#idBtnAddBlackListItem").click(q.onAddBlockSpecificSiteClicked);N.click(q.onSpecificTimeBlockingPopupRequested);x.find(".editRouterTime").click(function(){if(C){C.close()}var O=RAINIER.connect.AppletManager.getAppletById("BDBC8297-8982-4BCF-84EC-91783FF9013C");if(O){RAINIER.ui.MainMenu.launchApplet(O,"")}else{console.warn("Wireless Scheduler: cannot locate Connectivity applet")}})}function i(){function O(S){var R={};for(var Q=0;Q<G.length;Q++){R[G[Q].toLowerCase()]=S}return R}var P={isParentalControlEnabled:false,rules:[]};P.isParentalControlEnabled=$('input[name="isParentalControlEnabled"]').is(":checked");z.find("> li").each(function(){var Q=$.extend(true,{},$(this).data().getRule());Q.macAddresses=[];if(!$.compare(Q,s)){if($(this).data().getRule().isEnabled===0){$(this).data().setWanSchedule(O(I))}else{if($(this).data().getRule().isEnabled===2){$(this).data().setWanSchedule(O(E))}}if($(this).data().getRule().isEnabled!==0||$(this).data().getRule().blockedURLs.length>0){$(this).data().setInternetAccess(true);P.rules.push($(this).data().getRule())}}});return P}function l(){function P(W){function Y(ac,ab){function aa(ae){var ad=0;$.each(ae,function(){ad++});return ad}if(ac===ab){return true}if(aa(ac)!==aa(ab)){return false}for(var Z in ac){if(ac[Z]!==ab[Z]){return false}}return true}function U(Z,ab){if(Z.length!==ab.length){return false}for(var aa=0;aa<Z.length;aa++){if($.inArray(Z[aa],ab)<0){return false}}return true}if(f.parentalControlSettingsSetup.isParentalControlEnabled!==W.isParentalControlEnabled){return true}if(f.parentalControlSettingsSetup.rules.length!==W.rules.length){return true}for(var V=0;V<W.rules.length;V++){for(var T=0;T<W.rules[V].macAddresses.length;T++){var R=W.rules[V].macAddresses[T],Q,X;for(var S=0;S<f.parentalControlSettingsSetup.rules.length;S++){X=f.parentalControlSettingsSetup.rules[S].macAddresses;if($.inArray(R,X)>=0){Q=f.parentalControlSettingsSetup.rules[S]}}if(Q){if(W.rules[V].isEnabled!==Q.isEnabled||!Y(W.rules[V].wanSchedule,Q.wanSchedule)||!U(W.rules[V].blockedURLs,Q.blockedURLs)){return true}}else{return true}}}return false}if(x.find("#idTextAddBlackListItem").is(":visible")){if(a()){m()}else{return}}var O=i();if(P(O)){if(O.rules.length>f.parentalControlSettingsSetup.maxRules){RAINIER.ui.dialogWarning({msg:x.find("#max-rules-warning").html(),hideSubmit:true,cancel:RAINIER.ui.button.strings.ok});return}RAINIER.ui.showWaiting();RAINIER.jnap.send("/jnap/parentalcontrol/SetParentalControlSettings",O,function(Q){RAINIER.ui.hideWaiting();if(Q.result==="OK"){f.parentalControlSettings=$.extend(true,{},O);f.parentalControlSettingsSetup=$.extend(true,{},f.parentalControlSettings);RAINIER.event.fire("Parental Controls Updated")}else{}})}RAINIER.ui.MainMenu.closeApplet()}function h(){RAINIER.binder.toDom(f.parentalControlSettingsSetup,x);x.find("#idTextAddBlackListItem").attr("maxLength",f.parentalControlSettingsSetup.maxRuleBlockedURLLength);r(f.devices)}function n(O){f.devices=O;RAINIER.jnap.send("/jnap/parentalcontrol/GetParentalControlSettings",{},function(Q){if(Q.result==="OK"){f.parentalControlSettings=Q.output;f.parentalControlSettingsSetup=$.extend(true,{},f.parentalControlSettings);x.find("#max-rules-warning").html(x.find("#max-rules-warning").html().replace(/{maxRules}/g,f.parentalControlSettingsSetup.maxRules));h();v();if($.cookie("app-flag")){var R=$.cookie("app-flag"),S=x.find("#"+R),P=S.offset().top-z.offset().top;console.warn("selecting device: "+R);x.find("#"+R).click();if(P>z.scrollTop()+S.outerHeight()){z.scrollTop(P)}}}else{}})}function g(){A=null;RAINIER.event.disconnect("applet.unloaded",g)}function B(O){if(!RAINIER.shared.util.areServicesSupported(["/jnap/parentalcontrol/ParentalControl"])){RAINIER.event.fire("applet.unsupportedFirmware");return}if(RAINIER.network.isNetworkSecuritySupported()&&O){x.find(".widget-config").hide();x.find("#shield-tagline").show();x.find("#blocked").show();x.find(".applet-button-section .close-panel").show();RAINIER.event.fire("applet.loaded");return}else{x.find(".widget-config").show();x.find("#original-tagline").show();x.find(".applet-button-section .cancel").show();x.find(".applet-button-section .submit").show()}x.find("#unblocked").show();$("#cbAddParentalControlWidget").attr("checked",RAINIER.connect.AppletManager.getWidgetShowState("6B749D0D-1E3B-4C2A-B0CE-D19EDA0225AC","6F46F21B-3C02-4F64-B954-95B800375512"));$("#cbAddParentalControlWidget").bind("click",function(){RAINIER.connect.AppletManager.toggleWidgetShowState("6B749D0D-1E3B-4C2A-B0CE-D19EDA0225AC","6F46F21B-3C02-4F64-B954-95B800375512")});RAINIER.util.trapEnter("#idTextAddBlackListItem");K();$("#idRadioBlockCustom").click(function(){N.add("#blockRadios + .pipe").fadeIn("fast");c().setInternetAccess(1)});$("#idRadioBlockNever").add("#idRadioBlockAlways").click(function(){N.add("#blockRadios + .pipe").fadeOut("slow");if($(this).index("#idRadioBlockNever:checked")!==-1){c().setInternetAccess(0)}else{if($(this).index("#idRadioBlockAlways:checked")!==-1){c().setInternetAccess(2)}}});$("#blockRadios input[type=radio]").attr("disabled",true);RAINIER.blockScheduler.populateBlockAccessTable();RAINIER.event.connect("applet.unloaded",g);RAINIER.deviceManager.getDevices({cb:n,exclusions:{excludeAuthority:true,excludeGuest:true,excludeNodes:true},threshold:-1});RAINIER.ui.placeholders.init()}if(RAINIER.network.isNetworkSecuritySupported()){RAINIER.applets.ParentalControls.isShieldSubscriptionActive(B)}else{B()}}());