(function(){var ag=$("#usb-storage-applet"),aI=$("#create-new-share"),bh=$("#select-existing-share"),U=$("#show-all-shares-dialog"),aL=$("#user-shares"),r=ag.find("#ftp-server"),x=ag.find("#media-server"),K=ag.find("#media-folders table"),a2=ag.find("#upgrade-warning"),H=ag.find("#threshold-warning"),o=ag.find("#sfa-warning"),aF=RAINIER.applets.USBStorage,z=RAINIER.ui.buildInputValidBalloon,O=null,N=null,aj=null,d=null,ai=null,a4=null,f=false,c=true,q=true,ae=null,bb="",a0=null,ad=null,D=null,ba=null,l=null,y=null,aE=0,at=null,ah="",aw=false,aG=false;var X={partitions:[],selectedPartitionName:null,smbServerSettings:{},ftpServerSettings:{},upnpMediaServerSettings:{},upnpMediaFolders:[],groups:[],maxGroups:null,smbRouterIpAddressWindows:null,smbRouterIpAddressMac:null,smbFolders:[],userShares:{userName:"",shareNames:[]},users:[],ftpFolders:[]};var aX={smbServerSettings:{},ftpServerSettings:{},upnpMediaServerSettings:{},upnpMediaFolders:[],groups:[]};var be={"smbServerSettings.secureAccessEnabled":"boolean","ftpServerSettings.isEnabled":"boolean","ftpServerSettings.port":"number","upnpMediaServerSettings.isEnabled":"boolean"};var aa={};var Q={onToggleWidget:function(){RAINIER.connect.AppletManager.toggleWidgetShowState("A2DB16C0-59B9-4C79-9BF2-E5A3A307F9C1","26BDD899-C17B-4032-B21C-3767AAB4FCCA")},onClose:function(){RAINIER.ui.MainMenu.closeApplet()},onApply:function(){R(false)},onSave:function(){R(true)},onSaveComplete:function(){RAINIER.ui.hideWaiting();if(q){if(c){Q.onClose()}else{if(f){ai.click()}}RAINIER.event.fire("storage.updated")}}};var k=(function(){function bj(bm,bn,bk,bl){delete bn.pathExists;RAINIER.jnap.send({action:"/jnap/storage/"+bl,data:bn,cb:function(bp){if(bp.result==="OK"){for(var bo=0;bo<bk.length;bo++){if(bk[bo].name===bn.name){bk[bo].path=bn.path;bk[bo].isReadOnly=bn.isReadOnly;bk[bo].groupsWithPermission=bn.groupsWithPermission.clone();break}}bm.completed()}else{bm.failed()}}})}function bi(bm,bk){for(var bl=0;bl<bk.length;bl++){if(bk[bl].name===bm){return $.extend({},bk[bl])}}return null}return{createGroup:function(bl,bm){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/CreateGroup",data:{name:bl,description:"",hasWritePermissions:bm},disableDefaultJnapErrHandler:true,cb:function(bp){if(bp.result==="OK"){for(var bo=0;bo<aX.groups.length;bo++){if(aX.groups[bo].name===bl){delete aX.groups[bo].password;X.groups.push(aX.groups[bo]);break}}bk.completed()}else{var bn=false;if(bp.result!=="_AjaxError"){if(bp.result==="ErrorGroupExists"||bp.result==="ErrorTooManyGroups"){RAINIER.ui.alert(RAINIER.ui.validation.strings.errors[bp.result],"",function(){bk.failed()});bn=true}else{RAINIER.ajax().executeDefaultJnapErrorHandler(bp)}}if(!bn){bk.failed()}}}})},createUser:function(bm,bl){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/CreateUser",data:{name:bm,fullName:"",description:"",memberOfGroup:bm,isEnabled:true,password:bl},disableDefaultJnapErrHandler:true,cb:function(bo){if(bo.result==="OK"){bk.completed()}else{var bn=false;if(bo.result!=="_AjaxError"){if(bo.result==="ErrorUserExists"||bo.result==="ErrorTooManyUsers"){RAINIER.ui.alert(RAINIER.ui.validation.strings.errors[bo.result],"",function(){bk.failed()})}else{RAINIER.ajax().executeDefaultJnapErrorHandler(bo)}}if(!bn){bk.failed()}}}})},editGroup:function(bl,bn,bm){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/EditGroup",data:{name:bl,description:bn,hasWritePermissions:bm},cb:function(bq){if(bq.result==="OK"){for(var bp=0;bp<aX.groups.length;bp++){if(aX.groups[bp].name===bl&&aX.groups[bp].password){delete aX.groups[bp].password;for(var bo=0;bo<X.groups.length;bo++){if(X.groups[bo].name===bl){X.groups[bo]=$.extend(true,{},X.groups[bo],aX.groups[bp]);break}}}}bk.completed()}else{bk.failed()}}})},editUser:function(bm,bl){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/EditUser",data:{name:bm,fullName:"",description:"",memberOfGroup:bm,isEnabled:true,password:bl},cb:function(bn){if(bn.result==="OK"){bk.completed()}else{bk.failed()}}})},deleteGroup:function(bl){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/DeleteGroup",data:{name:bl},cb:function(bn){if(bn.result==="OK"){for(var bm=0;bm<X.groups.length;bm++){if(X.groups[bm].name===bl){X.groups.splice(bm,1);break}}a3(bl);bk.completed()}else{bk.failed()}}})},deleteUser:function(bl){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/DeleteUser",data:{name:bl},cb:function(bm){if(bm.result==="OK"){bk.completed()}else{bk.failed()}}})},editSmbFolder:function(bl){var bk=this;bj(bk,bl,X.smbFolders,"EditSMBFolder")},addGroupToSmbFolder:function(bn,bm){var bk=this,bl=bi(bm,X.smbFolders);bl.groupsWithPermission.push(bn);bj(bk,bl,X.smbFolders,"EditSMBFolder")},editFtpFolder:function(bl){var bk=this;bj(bk,bl,X.ftpFolders,"EditFTPFolder")},addGroupToFtpFolder:function(bn,bm){var bk=this,bl=bi(bm,X.ftpFolders);bl.groupsWithPermission.push(bn);bj(bk,bl,X.ftpFolders,"EditFTPFolder")},deleteSmbFolder:function(bl){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/DeleteSMBFolder",data:{name:bl},cb:function(bm){if(bm.result==="OK"){X.smbFolders.remove(bl);bk.completed()}else{bk.failed()}}})},deleteFtpFolder:function(bl){var bk=this;RAINIER.jnap.send({action:"/jnap/storage/DeleteFTPFolder",data:{name:bl},cb:function(bm){if(bm.result==="OK"){X.ftpFolders.remove(bl);bk.completed()}else{bk.failed()}}})},updateSmbServerSettings:function(){var bk=this;var bl=RAINIER.jnap.Transaction({onComplete:function(bm){if(bm.result==="OK"){aP();bk.completed()}else{q=false;bk.failed()}}});delete aX.smbServerSettings.secureAccessEnabled;bl.add({action:"/jnap/storage/SetSMBServerSettings",data:aX.smbServerSettings,cb:function(bm){if(bm.result==="OK"){X.smbServerSettings.isAnonymousWriteEnabled=aX.smbServerSettings.isAnonymousWriteEnabled}}});P(bl);bl.send()}}}());function R(bj){var bi=false;c=bj||false;q=true;switch(aj){case"folder-access":if(b()){bi=true;if(am()){aS()}}break;case"ftp-server":if(T()){bi=true;if(C()){L()}}break;case"media-server":if(ao()){bi=true;if(ak()){aA()}}break}if(c&&!bi){Q.onClose()}}function aq(){var bi=false;switch(N){case"folder-access":bi=b();break;case"ftp-server":bi=T();break;case"media-server":bi=ao();break}return bi}function w(){switch(aj){case"status":aP();break;case"folder-access":ab();break;case"ftp-server":al();break;case"media-server":t();break}}function j(){aP()}function az(bi){if(bi>=0&&bi<=X.partitions.length){X.selectedPartitionName=X.partitions[bi].partitionName;X.label=I()?I().label:null}else{X.selectedPartitionName=null;X.label=null}}var I=(function(){var bi=null,bj=null;return function(){if(X.selectedPartitionName){if(!aG&&bj&&bi===X.selectedPartitionName){return bj}for(var bk=0;bk<X.partitions.length;bk++){if(X.partitions[bk].partitionName===X.selectedPartitionName){bi=X.selectedPartitionName;bj=X.partitions[bk];aG=false;return bj}}}return null}}());function aV(){X.usedSpaceLabel=aF.computeUsedSpaceLabel(I().usedKB,I().availableKB);var bi=(I().usedKB/(I().usedKB+I().availableKB))*100;RAINIER.ui.progressBar.update({element:ag.find("#partition-space div.progress-bar"),percent:bi})}function aC(bk){var bl=ag.find(bk),bi,bj;if(X.partitions.length>1){bl.show();bi=$();for(bj=0;bj<X.partitions.length;bj++){bi=bi.add($("<option>").text(X.partitions[bj].label))}bl.find("select").empty().append(bi)}else{bl.hide()}if(I()){for(bj=0;bj<X.partitions.length;bj++){if(I().partitionName===X.partitions[bj].partitionName){bl.find("select").prop("selectedIndex",bj);break}}}else{az(0)}}function aP(){aC("#status-select-partition");aV();X.smbRouterIpAddressWindows="\\\\"+X.routerIpAddress;X.smbRouterIpAddressMac="smb://"+X.routerIpAddress;X.ftpIpAddress=X.ftpIpAddress||X.routerIpAddress;X.ftpServerAddress="ftp://"+X.ftpIpAddress+":"+X.ftpServerSettings.port;g(X.smbServerSettings.secureAccessEnabled);ay(X.ftpServerSettings.isEnabled);bf(X.upnpMediaServerSettings.isEnabled);RAINIER.binder.toDom(X,ag.find("#status"),be)}function g(bi){if(typeof bi!=="boolean"){bi=RAINIER.binder.fromDom("#secure-folder-access-switch",be).smbServerSettings.secureAccessEnabled}if(bi){ag.find(".secure-folder-access-on").show();ag.find(".secure-folder-access-off").hide()}else{ag.find(".secure-folder-access-off").show();ag.find(".secure-folder-access-on").hide()}}function ay(bi){if(typeof bi!=="boolean"){bi=RAINIER.binder.fromDom("#ftp-server-switch",be).ftpServerSettings.isEnabled}if(bi){ag.find(".ftp-server-enabled").show();ag.find(".ftp-server-disabled").hide()}else{ag.find(".ftp-server-disabled").show();ag.find(".ftp-server-enabled").hide()}}function bf(bi){if(typeof bi!=="boolean"){bi=RAINIER.binder.fromDom("#media-server-switch",be).upnpMediaServerSettings.isEnabled}if(bi){ag.find(".dlna-server-enabled").show();ag.find(".dlna-server-disabled").hide()}else{ag.find(".dlna-server-disabled").show();ag.find(".dlna-server-enabled").hide()}}function A(){ab();var bi={validCharSet:"shareUserName",minLen:1,maxLen:22,whiteSpace:true,isRequired:true};aa.createShare={};aa.createShare.name=z($.extend(true,{},bi,{els:aI.find('#create-share-name-share input:[type="text"]')}))}function ab(){X.smbServerSettings.secureAccessEnabled=!X.smbServerSettings.isAnonymousWriteEnabled;aC("#folder-access-select-partition");var bj=$("<div></div>");p(bj);for(var bi=0;bi<X.groups.length;bi++){ap(bj,X.groups[bi])}ag.find("#users-tablebody").empty();ag.find("#users-tablebody").append(bj.children());RAINIER.binder.toDom(X,$("#folder-access"),be)}function s(){function bl(bn,bm){return bn===bm.name}function bj(bq,bp,bn){for(var bo=0;bo<bp.length;bo++){var br=RAINIER.applets.USBStorage.intersectArray(bp[bo].groupsWithPermission,X.groups,bl);if(br.length!==bp[bo].groupsWithPermission.length){bp[bo].groupsWithPermission=br;delete bp[bo].pathExists;var bm={};if(bn==="EditSMBFolder"){bm=k.editSmbFolder.curry(bp[bo])}else{bm=k.editFtpFolder.curry(bp[bo])}bq.add(bm)}}}var bi=this;var bk=RAINIER.taskmanager({parallel:false,callback:function(){bi.completed()}});bj(bk,X.smbFolders,"EditSMBFolder");bj(bk,X.ftpFolders,"EditFTPFolder");bk()}function p(bk){var bm=$("#first-authorized-user-row tr").clone();bm.find("#select-share").click(function(){X.userShares=null;i()});bm.find("button").click(aH);var bi={},bj={validCharSet:"storageUserName",minLen:1,maxLen:12,whiteSpace:false,isRequired:false},bl={validCharSet:"alpha",minLen:4,maxLen:64,whiteSpace:false,isRequired:false};bi.name=z($.extend(true,{},bj,{els:bm.find("input.name:text")}));bi.password=z($.extend(true,{},bl,{els:bm.find("input.password:text")}));bm.find("button").data(bi);bk.append(bm)}function G(bl){var bm=RAINIER.taskmanager({parallel:false});for(var bk=bl.length-1;bk>=0;bk--){if(!bl[bk].pathExists){var bj=k.deleteSmbFolder.curry(bl[bk].name);bm.add(bj);var bi=k.deleteFtpFolder.curry(bl[bk].name);bm.add(bi);bl.splice(bk,1)}}bm()}function F(bj){var bk=[];for(var bi=0;bi<bj.length;bi++){if(bj[bi].partitionName===I().partitionName){bk.push(bj[bi])}}return bk}function i(){RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/storage/GetSMBFolders",data:{},cb:function(bq){if(bq.result==="OK"){X.smbFolders=bq.output.smbFolders;G(X.smbFolders);var bn=F(X.smbFolders),bo=$("<div></div>");for(var bm=0;bm<bn.length;bm++){var bk=ag.find("#select-existing-share-row > div.checkbox-row").clone(),bj=bn[bm].name;bk.find("label").text(bj);RAINIER.ui.fixCustomControls(bk);bk.find('input:[type="checkbox"]').change(bi);var bl=ag.find("#add-user-cell button").data.shares;if(bl&&bl.indexOf(bj)>-1){bk.find('input:[type="checkbox"]').attr("checked",true)}bo.append(bk)}bh.find("#select-existing-share-rows").empty();bh.find("#select-existing-share-rows").append(bo.children());var bp=bh.find("#create-new-share-button");bp.hover(function(){bp.addClass("hover")},function(){bp.removeClass("hover")});bp.mousedown(function(){bp.addClass("active")});bp.mouseup(function(){bp.removeClass("active")});bp.mouseout(function(){bp.removeClass("active")});a0.show()}RAINIER.ui.hideWaiting()}});function bi(){var bk=bh.find("#select-existing-share-content span.ui-checkbox-checked").length;if(bk>0){bh.find("#select-existing-share-submit").removeAttr("disabled")}else{bh.find("#select-existing-share-submit").attr("disabled","disabled")}var bl=bh.find("#select-existing-share-rows span.ui-checkbox").length;var bj=bh.find("#select-existing-share-rows span.ui-checkbox-checked").length;bh.find("#all-shares-checkbox").addClass("dont-handle-click-event");bh.find("#all-shares-checkbox").attr("checked",bj===bl);bh.find("#all-shares-checkbox").removeClass("dont-handle-click-event")}}function af(bk){var bj=$(ag.find("#users-tablebody").children());for(var bi=1;bi<bj.length;bi++){if(bk===$(bj[bi]).find(".name-label").text()){return true}}return false}function aH(){var bi=$(this).data();if(bi.name.isValid(true)&&bi.password.isValid(true)){var bl=$(this.parentElement.parentElement);var bj=bl.find(".name").val();if(af(bj)){RAINIER.ui.alert(RAINIER.ui.validation.strings.errors.ErrorUserExists);return}var bm={};bm.name=bj;bm.password=bl.find(".password").val();bm.hasWritePermissions=(bl.find("option:selected").attr("value")==="readAndWrite");bm.isEditable=true;bm.isDeletable=true;if($(this).data.shares){bm.addShares=$(this).data.shares}var bk=$("<div></div>");ap(bk,bm);bk.find("tr").addClass("new-group");bk.find(".show-shares").remove();ag.find("#users-tablebody").append(bk.children());bl.find("input").val("");bl.find('option[value="readAndWrite"]').attr("selected","selected");delete $(this).data.shares}}function ap(bk,bm){var bj=$("#authorized-user-row tr").clone();bj.find(".name-label").text(bm.name);bj.find(".permissions-label").text(bm.hasWritePermissions?RAINIER.ui.common.strings.usb.readAndWrite:RAINIER.ui.common.strings.usb.read);if(bm.password){bj.data("password",bm.password);bj.find(".password-input").val(bm.password)}if(bm.hasWritePermissions){bj.find('option[value="readAndWrite"]').attr("selected","selected")}else{bj.find('option[value="read"]').attr("selected","selected")}if(!bm.isEditable&&bm.name!=="guest"){bj.find(".edit-user").remove()}if(!bm.isDeletable){bj.find(".delete-user").remove()}if(bm.addShares){bj.data("sharesToAdd",bm.addShares)}var bi={},bl={validCharSet:"alpha",minLen:4,maxLen:64,whiteSpace:false,isRequired:false};bi.password=z($.extend(true,{},bl,{els:bj.find("input.password-input:text")}));bj.data("validation",bi);bj.find(".edit-user").click(function(){var bn=$(this.parentElement.parentElement);bn.find(".password-input").val("");if(bn.find(".permissions-label").text()===RAINIER.ui.common.strings.usb.readAndWrite){bn.find('option[value="readAndWrite"]').attr("selected","selected")}else{bn.find('option[value="read"]').attr("selected","selected")}bn.addClass("edit")});bj.find(".cancel-edit-user").click(function(){var bn=$(this.parentElement.parentElement);if(bn.data("password")){bn.find(".password-input").val(bn.data("password"))}else{bn.find(".password-input").val("")}bn.removeClass("edit");if(am()){RAINIER.ui.inputBalloon.hide()}});bj.find(".delete-user").click(function(){var bn=$(this.parentElement.parentElement);bn.remove()});bj.find(".show-shares").click(function(){var bn=$(this.parentElement.parentElement);X.userShares={userName:bn.find(".name-label").text(),shareNames:[]};RAINIER.jnap.send({action:"/jnap/storage/GetSMBFolders",data:{},cb:function(bt){if(bt.result==="OK"){X.smbFolders=bt.output.smbFolders;G(X.smbFolders);var bq=F(X.smbFolders);for(var bp=0;bp<bq.length;bp++){var bs=bq[bp];for(var bo=0;bo<bs.groupsWithPermission.length;bo++){if(bs.groupsWithPermission[bo]===X.userShares.userName){X.userShares.shareNames.push(bs.name);break}}}if(X.userShares.userName==="admin"){$("#user-shares-table thead tr td:nth-child(2)").hide()}else{$("#user-shares-table thead tr td:nth-child(2)").show()}var br=$("<div></div>");$.each(X.userShares.shareNames,function(bu,bw){var bv=ag.find("#user-shares-row tr").clone();bv.find("label.user-shares-row-share-name").text(bw);if(X.userShares.userName!=="admin"){bv.find("a").click(function(){var bx=$(this.parentElement.parentElement);bx.remove()})}else{bv.find(" > td:nth-child(2)").hide()}br.append(bv)});aL.find("#user-shares-table tbody").empty();aL.find("#user-shares-table tbody").append(br.children());aL.find("#users-shares-user-name").text(X.userShares.userName);D.show()}RAINIER.ui.hideWaiting()}})});if(bm.name==="guest"){bj.find(".permissions-label").removeClass("static");bj.find(".permissions-input").remove()}bk.append(bj)}function b(){var bj=false,bk,bi;var bm=RAINIER.binder.fromDom("#folder-access",be);aX.smbServerSettings=$.extend(true,{},X.smbServerSettings,bm.smbServerSettings);aX.smbServerSettings.isAnonymousWriteEnabled=!aX.smbServerSettings.secureAccessEnabled;if(!$.compare(aX.smbServerSettings,X.smbServerSettings)){bj=true}if(ag.find("#authorized-users").css("display")!=="none"){aX.groups=[];for(bk=1;bk<ag.find("#users-tablebody").children().length;bk++){var bl=$(ag.find("#users-tablebody").children()[bk]);aX.groups[bk-1]={};aX.groups[bk-1].name=bl.find(".name-label").text();if(bl.hasClass("edit")){aX.groups[bk-1].password=bl.find(".password-input").val()}if(bl.hasClass("new-group")){aX.groups[bk-1].password=bl.find(".password-input").val();aX.groups[bk-1].description=""}if(bl.data("sharesToAdd")){aX.groups[bk-1].addShares=bl.data("sharesToAdd").slice()}aX.groups[bk-1].hasWritePermissions=(bl.find("option:selected").attr("value")==="readAndWrite");aX.groups[bk-1].isEditable=(bl.find(".edit-user").length>0);aX.groups[bk-1].isDeletable=(bl.find(".delete-user").length>0);if(aX.groups[bk-1].name==="guest"){aX.groups[bk-1].isEditable=false}}for(bk=0;bk<X.groups.length;bk++){for(bi=0;bi<aX.groups.length;bi++){if(X.groups[bk].name===aX.groups[bi].name){aX.groups[bi]=$.extend(true,{},X.groups[bk],aX.groups[bi]);break}}}for(bk=aX.groups.length-1;bk>=0;bk--){for(bi=bk-1;bi>=0;bi--){if(aX.groups[bk].name===aX.groups[bi].name){aX.groups.splice(bk,1);break}}}if(!$.compare(X.groups,aX.groups)){bj=true}}return bj}function am(){if(ag.find("#authorized-users").css("display")!=="none"){for(var bj=1;bj<ag.find("#users-tablebody").children().length;bj++){var bk=$(ag.find("#users-tablebody").children()[bj]);if(bk.hasClass("edit")){var bi=bk.data("validation");if(!bi.password.isValid(true)){return false}}}}return true}function a1(bl,bo){if(X.smbFolders){for(var bk=0;bk<bl.length;bk++){for(var bj=0;bj<X.smbFolders.length;bj++){if(X.smbFolders[bj].name===bl[bk]){var bi=X.smbFolders[bj];delete bi.pathExists;bi.groupsWithPermission.push(bo);var bn=bd.curry(bl[bk],bo);aE++;RAINIER.jnap.send({action:"/jnap/storage/EditSMBFolder",data:bi,cb:bn});break}}}}else{var bm=M.curry(bl,bo);aE++;RAINIER.jnap.send({action:"/jnap/storage/GetSMBFolders",data:{},cb:bm})}}function M(bi,bk,bj){if(bj.result==="OK"){X.smbFolders=bj.output.smbFolders;a1(bi,bk)}else{q=false}at()}function bd(bi,bk,bj){if(bj.result==="OK"){aO(bi,bk)}else{q=false}at()}function aO(bi,bk){if(X.ftpFolders){$.each(X.ftpFolders,function(){if(bi===this.name){var bl=this;delete bl.pathExists;bl.groupsWithPermission.push(bk);aE++;RAINIER.jnap.send({action:"/jnap/storage/EditFTPFolder",data:bl,cb:function(bm){if(bm.result!=="OK"){q=false}at()}});return false}})}else{var bj=aW.curry(bi,bk);aE++;RAINIER.jnap.send({action:"/jnap/storage/GetFTPFolders",data:{},cb:bj})}}function aW(bi,bk,bj){if(bj.result==="OK"){X.ftpFolders=bj.output.ftpFolders;aO(bi,bk)}else{q=false}at()}function a3(bj){var bi;for(bi=0;bi<X.smbFolders.length;bi++){X.smbFolders[bi].groupsWithPermission.remove(bj)}for(bi=0;bi<X.ftpFolders.length;bi++){X.ftpFolders[bi].groupsWithPermission.remove(bj)}}function aJ(bl,bn,bk){if(!bk||bk.length===0){return}for(var bj=0;bj<bk.length;bj++){var bi=k.addGroupToSmbFolder.curry(bn,bk[bj]);bl.add(bi);var bm=k.addGroupToFtpFolder.curry(bn,bk[bj]);bl.add(bm)}}function aS(){var bn=RAINIER.taskmanager({parallel:false,callback:function(bt){if(bt){}else{q=false}ar()}});if(!$.compare(aX.smbServerSettings,X.smbServerSettings)){bn.add(k.updateSmbServerSettings)}if(ag.find("#authorized-users").css("display")!=="none"){if(!$.compare(X.groups,aX.groups)){for(var bm=0;bm<X.groups.length;bm++){var bk=false;for(var bl=0;bl<aX.groups.length;bl++){if(X.groups[bm].name===aX.groups[bl].name){bk=true;break}}if(!bk){var bq=k.deleteGroup.curry(X.groups[bm].name);bn.add(bq);var br=k.deleteUser.curry(X.groups[bm].name);bn.add(br)}}for(var bp=0;bp<aX.groups.length;bp++){var bj="newGroup",bi,bs;for(var bo=0;bo<X.groups.length;bo++){if(X.groups[bo].name===aX.groups[bp].name){if(aX.groups[bp].password){bj="editGroup"}else{bj="unchangedGroup"}break}}if(bj==="newGroup"){bi=k.createGroup.curry(aX.groups[bp].name,aX.groups[bp].hasWritePermissions);bn.add(bi);bs=k.createUser.curry(aX.groups[bp].name,aX.groups[bp].password);bn.add(bs);aJ(bn,aX.groups[bp].name,aX.groups[bp].addShares)}else{if(bj==="editGroup"){if(aX.groups[bp].password){if(aX.groups[bp].name==="guest"){bs=k.editUser.curry(aX.groups[bp].name,aX.groups[bp].password);bn.add(bs)}else{bi=k.editGroup.curry(aX.groups[bp].name,X.groups[bo].description,aX.groups[bp].hasWritePermissions);bn.add(bi);bs=k.editUser.curry(aX.groups[bp].name,aX.groups[bp].password);bn.add(bs)}}}}}}}RAINIER.ui.showWaiting();bn()}function ar(){if(q){ab();Q.onSaveComplete()}else{an()}}function ax(){al();Z()}function al(){aN();RAINIER.binder.toDom(X,r,be)}function aN(){var bj=$("<div></div>");for(var bi=0;bi<X.ftpServerSettings.supportedEncodings.length;bi++){var bk=X.ftpServerSettings.supportedEncodings[bi];var bl=$($("#option-template option").clone());bl.val(bk);bl.text(bk);bj.append(bl)}r.find("#ftp-server-encoding").empty();r.find("#ftp-server-encoding").append(bj.children())}function Z(){var bi={validCharSet:"numeric",minVal:1,maxVal:65535,isRequired:true,isBlankOkOnBlur:false};aa.ftpServerSettings={};aa.ftpServerSettings.port=z($.extend(true,{},bi,{els:r.find('input:[name="ftpServerSettings.port"]')}))}function T(){var bi=false;var bj=RAINIER.binder.fromDom(r,be);aX.ftpServerSettings=$.extend(true,{},X.ftpServerSettings,bj.ftpServerSettings);if(!$.compare(aX.ftpServerSettings,X.ftpServerSettings)){bi=true}return bi}function C(){return aa.ftpServerSettings.port.isValid(true)}function P(bi){delete aX.ftpServerSettings.supportedEncodings;aX.ftpServerSettings.isAnonymousReadAccessEnabled=aX.smbServerSettings.isAnonymousWriteEnabled;bi.add({action:"/jnap/storage/SetFTPServerSettings",data:aX.ftpServerSettings,cb:function(bj){if(bj.result==="OK"){X.ftpServerSettings=$.extend(true,{},X.ftpServerSettings,aX.ftpServerSettings);aP()}else{q=false}}})}function L(bj){var bi=RAINIER.jnap.Transaction({onComplete:Q.onSaveComplete});if(aX.ftpServerSettings.isEnabled&&!X.ftpServerSettings.isEnabled&&!aX.smbServerSettings.secureAccessEnabled){if(!bj){RAINIER.ui.dialogWarning({msg:o.html(),onSubmit:function(){L(true)}});return}else{delete aX.smbServerSettings.secureAccessEnabled;aX.smbServerSettings.isAnonymousWriteEnabled=false;bi.add({action:"/jnap/storage/SetSMBServerSettings",data:aX.smbServerSettings,cb:function(bk){if(bk.result==="OK"){X.smbServerSettings.isAnonymousWriteEnabled=aX.smbServerSettings.isAnonymousWriteEnabled;X.smbServerSettings.secureAccessEnabled=!aX.smbServerSettings.isAnonymousWriteEnabled;ag.find("#secure-folder-access-switch").prop("checked",!aX.smbServerSettings.isAnonymousWriteEnabled);g()}}})}}P(bi);RAINIER.ui.showWaiting();bi.send()}function bg(){if(!aF.mediaServerSupported()){$(".media-server-visible").css("visibility","hidden");return}t();E()}function t(){V();ac(X.upnpMediaFolders)}function E(){x.find("#media-server-scan").click(function(){RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/storage/TriggerUPnPMediaFolderScan",data:{},cb:function(bi){if(bi.result==="OK"){setTimeout(function(){aY()},3000)}else{RAINIER.ui.hideWaiting()}}})});ag.find("#add-media-folder button").click(function(){Y("media")})}function V(){X.upnpMediaServer={};X.upnpMediaServer.autoScanInterval=X.upnpMediaServerSettings.autoScanIntervalMinutes/60;if(typeof X.upnpMediaServerSettings.lastScanTime==="undefined"){x.find(".media-server-last-scan-hide").show();x.find(".media-server-last-scan-show").hide()}else{x.find(".media-server-last-scan-hide").hide();x.find(".media-server-last-scan-show").show();X.upnpMediaServer.lastScanTime=RAINIER.util.utcToLocal(RAINIER.util.utcTimeToDate(X.upnpMediaServerSettings.lastScanTime))}aC("#media-server-select-partition");RAINIER.binder.toDom(X,x,be)}function aZ(){var bi=RAINIER.binder.fromDom(x,be);aX.upnpMediaServerSettings=$.extend(true,{},X.upnpMediaServerSettings,bi.upnpMediaServerSettings);aX.upnpMediaServerSettings.autoScanIntervalMinutes=bi.upnpMediaServer.autoScanInterval*60}function ac(bi){var bj=$("<div></div>");var bk=0;$.each(bi,function(){var bl=$("#media-folder-row tr").clone();bl.find(".name-label").text(this.name);bl.find(".path-label").text(this.path);bl.data({isReadOnly:this.isReadOnly,groupsWithPermission:this.groupsWithPermission,partitionName:this.partitionName});bl.find(".delete-media-folder").click(function(){$(this.parentElement.parentElement).remove();au();ac(aX.upnpMediaFolders)});if(this.partitionName!==I().partitionName){bl.hide()}else{bk++}bj.append(bl)});if(bi.length===0){bj.append($("#media-folder-everything-row tr").clone())}else{if(bk===0){bj.append($("#media-folder-nothing-row tr").clone())}}RAINIER.ui.clearTbl(K);K.append(bj.children())}function au(){var bi=K.find("tr:not(:first-child)");aX.upnpMediaFolders=[];for(var bk=0;bk<bi.length;bk++){var bl=$(bi[bk]);if(bl.attr("id")!=="media-folder-everything"&&bl.attr("id")!=="media-folder-nothing"){var bj={name:bl.find(".name-label").text(),path:bl.find(".path-label").text(),isReadOnly:bl.data().isReadOnly,groupsWithPermission:bl.data().groupsWithPermission,partitionName:bl.data().partitionName};aX.upnpMediaFolders.append(bj)}}}function ao(){return a()||aK()}function a(){var bi=false;aZ();if(!$.compare(aX.upnpMediaServerSettings,X.upnpMediaServerSettings)){bi=true}return bi}function aK(){var bi=false;au();if(!$.compare(aX.upnpMediaFolders,X.upnpMediaFolders)){bi=true}return bi}function ak(){return true}function a5(bj){X.upnpMediaFolders=bj;for(var bi=0;bi<X.upnpMediaFolders.length;bi++){delete X.upnpMediaFolders[bi].pathExists}}function av(bi,bo,bn){var bm=[];for(var bk=0;bk<bi.length;bk++){var bl=true;for(var bj=0;bj<bo.length;bj++){if(bn(bi[bk],bo[bj])){bl=false;break}}if(bl){bm.append(bi[bk])}}return bm}function aA(){var bm=RAINIER.taskmanager({parallel:false,callback:function(bq){q=false;RAINIER.jnap.send({action:"/jnap/storage/GetUPnPMediaFolders",data:{},cb:function(br){if(br.result==="OK"){a5(br.output.upnpMediaFolders);bg();if(bq){q=true}}Q.onSaveComplete()}})}});if(a()){delete aX.upnpMediaServerSettings.lastScanTime;bm.add(function(){var bq=this;RAINIER.jnap.send({action:"/jnap/storage/SetUPnPMediaServerSettings",data:aX.upnpMediaServerSettings,cb:function(br){if(br.result==="OK"){X.upnpMediaServerSettings=$.extend(true,{},X.upnpMediaServerSettings,aX.upnpMediaServerSettings);aP();bq.completed()}else{bq.failed()}}})})}if(aK()){var bn=av(aX.upnpMediaFolders,X.upnpMediaFolders,bo),bi=av(X.upnpMediaFolders,aX.upnpMediaFolders,bo),bj,bk;for(bj=0;bj<bi.length;bj++){bk=bp.curry(bi[bj].name);bm.add(bk)}for(bj=0;bj<bn.length;bj++){bk=bl.curry(bn[bj]);bm.add(bk)}}RAINIER.ui.showWaiting();bm();function bl(br){var bq=this;RAINIER.jnap.send({action:"/jnap/storage/CreateUPnPMediaFolder",data:br,cb:function(bs){if(bs.result==="OK"){bq.completed()}else{bq.failed();if(bs.result!=="_AjaxError"){if(bs.result==="ErrorFolderExists"||bs.result==="ErrorTooManyFolders"){RAINIER.ui.alert(RAINIER.ui.validation.strings.errors[bs.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(bs)}}}},disableDefaultJnapErrHandler:true})}function bp(br){var bq=this;RAINIER.jnap.send({action:"/jnap/storage/DeleteUPnPMediaFolder",data:{name:br},cb:function(bs){if(bs.result==="OK"){bq.completed()}else{bq.failed()}}})}function bo(bq,br){return(bq.partitionName===br.partitionName&&bq.path===br.path&&bq.name===br.name)}}function aU(bk){var bj=[];for(var bi=0;bi<bk.length;bi++){bj.push(bk[bi].name)}for(bi=0;bi<bj.length;bi++){if(bj.lastIndexOf(bj[bi])!==bi){return true}}return false}function bc(){Q.onClose()}function a6(){function bj(bl,bk){return bl.name===bk.name}var bi=this;if(aU(X.smbFolders)){RAINIER.ui.alert(RAINIER.ui.strings.usbStorage.duplicateShareText,RAINIER.ui.strings.usbStorage.duplicateShareTitle,bc);return false}if(av(X.users,X.groups,bj).length>0||av(X.groups,X.users,bj).length>0||av(X.smbFolders,X.ftpFolders,bj).length>0||av(X.ftpFolders,X.smbFolders,bj).length>0){ba.show()}else{bi.completed()}}function a7(){if(RAINIER.ui.isWaiting()){RAINIER.ui.hideWaiting()}RAINIER.event.fire("applet.loaded");RAINIER.event.fire("storage.updated")}function aQ(){j();A();ax();bg();var bi=RAINIER.taskmanager({parallel:false,callback:function(){a7()}});bi.add(a6);bi.add(s);bi()}function an(bi){if(!bi||typeof bi!=="boolean"){bi=false;RAINIER.ui.showWaiting()}var bj="/jnap/storage/GetPartitions";if(!RAINIER.shared.util.areServicesSupported(["/jnap/storage/Storage2"])){bj="/jnap/storage/GetMountedPartitions"}RAINIER.jnap.send({action:bj,data:{},cb:function(bm){var bl;if(bm.result==="OK"){bl=$.grep(bm.output.partitions,function(bn){return bn.fileSystem!=="Unsupported"&&bn.partitionTableFormat!=="Unsupported"});if(bl.length>0){X.partitions=bl;ag.find("#usb-status-empty").hide();ag.find("#usb-status-device").show();if(bl.length!==bm.output.partitions.length){ag.find(".drive-unsupported").show()}else{ag.find(".drive-unsupported").hide()}u(false);var bk=RAINIER.jnap.Transaction({onComplete:aQ});bk.add({action:"/jnap/storage/GetSMBServerSettings",data:{},cb:function(bn){if(bn.result==="OK"){X.smbServerSettings.workgroup=bn.output.workgroup;X.smbServerSettings.isAnonymousWriteEnabled=bn.output.isAnonymousWriteEnabled;aX.smbServerSettings=$.extend(true,{},X.smbServerSettings)}}});bk.add({action:"/jnap/router/GetLANSettings",data:{},cb:function(bn){if(bn.result==="OK"){X.routerIpAddress=bn.output.ipAddress}}});bk.add({action:RAINIER.jnapActions.getWANStatus(),data:{},cb:function(bn){if(bn.result==="OK"&&bn.output.wanConnection){X.ftpIpAddress=bn.output.wanConnection.ipAddress}else{X.ftpIpAddress=null}}});bk.add({action:"/jnap/storage/GetFTPServerSettings",data:{},cb:function(bn){if(bn.result==="OK"){X.ftpServerSettings=bn.output;delete X.ftpServerSettings.maxFTPFolders;aX.ftpServerSettings=$.extend(true,{},X.ftpServerSettings)}}});if(aF.mediaServerSupported()){bk.add({action:"/jnap/storage/GetUPnPMediaServerSettings",data:{},cb:function(bn){if(bn.result==="OK"){a9(bn.output)}}});bk.add({action:"/jnap/storage/GetUPnPMediaFolders",data:{},cb:function(bn){if(bn.result==="OK"){a5(bn.output.upnpMediaFolders)}}})}bk.add({action:"/jnap/locale/GetTimeSettings",data:{},cb:function(bn){if(bn.result==="OK"){X.timeSettings=bn.output}}});bk.add({action:"/jnap/storage/GetGroups",data:{},cb:function(bn){if(bn.result==="OK"){X.groups=bn.output.groups;X.maxGroups=bn.output.maxGroups}}});bk.add({action:"/jnap/storage/GetUsers",data:{},cb:function(bn){if(bn.result==="OK"){X.users=bn.output.users}}});bk.add({action:"/jnap/storage/GetSMBFolders",data:{},cb:function(bn){if(bn.result==="OK"){X.smbFolders=bn.output.smbFolders}}});bk.add({action:"/jnap/storage/GetFTPFolders",data:{},cb:function(bn){if(bn.result==="OK"){X.ftpFolders=bn.output.ftpFolders}}});if(RAINIER.shared.util.areServicesSupported(["/jnap/storage/UPnPMediaServer2"])){bk.add({action:"/jnap/storage/IsMediaThresholdReached",data:{},cb:function(bn){if(bn.result==="OK"){if(bn.output.isReached){l.show()}}}})}bk.send()}else{u(true);ag.find("#usb-status-device").hide();if(bm.output.partitions.length!==bl.length){ag.find("#usb-status-empty").show();ag.find("#unsupported-device-info").show();ag.find("#no-device-found-info").hide()}else{ag.find("#usb-status-empty").show();ag.find("#unsupported-device-info").hide();ag.find("#no-device-found-info").show()}a7()}}else{if(RAINIER.ui.isWaiting()){RAINIER.ui.hideWaiting()}}}})}function u(bi){ag.find("#folder-access, #tab-folder-access, #ftp-server, #tab-ftp-server, #media-server, #tab-media-server").toggleClass("disabled",bi)}function a9(bi){X.upnpMediaServerSettings=bi;delete X.upnpMediaServerSettings.maxUPnPMediaFolders}function aY(){RAINIER.jnap.send({action:"/jnap/storage/GetUPnPMediaServerSettings",data:{},cb:function(bi){if(bi.result==="OK"){a9(bi.output);t()}RAINIER.ui.hideWaiting()}})}function aR(){var bi,bj;RAINIER.ui.showWaiting();var bk=RAINIER.taskmanager({parallel:false,callback:function(){an(true)}});for(bj=0;bj<X.users.length;bj++){if(X.users[bj].name!=="admin"&&X.users[bj].name!=="guest"){bi=k.deleteUser.curry(X.users[bj].name);bk.add(bi)}}for(bj=0;bj<X.groups.length;bj++){if(X.groups[bj].name!=="admin"&&X.groups[bj].name!=="guest"){bi=k.deleteGroup.curry(X.groups[bj].name);bk.add(bi)}}for(bj=0;bj<X.smbFolders.length;bj++){bi=k.deleteSmbFolder.curry(X.smbFolders[bj].name);bk.add(bi)}for(bj=0;bj<X.ftpFolders.length;bj++){bi=k.deleteFtpFolder.curry(X.ftpFolders[bj].name);bk.add(bi)}bk()}function W(bi,bj){var bk="/jnap/storage/GetPartitions";if(!RAINIER.shared.util.areServicesSupported(["/jnap/storage/Storage2"])){bk="/jnap/storage/GetMountedPartitions"}if(!bj){bj=0}RAINIER.jnap.send({action:bk,data:{},cb:function(bn){if(bn.result==="OK"){var bm=$.grep(bn.output.partitions,function(bo){return bo.fileSystem!=="Unsupported"&&bo.partitionTableFormat!=="Unsupported"});if(bj<12){var bl=$.grep(bm,function(bo){return bo.storageDeviceName===bi});if(bl.length>0){bj++;setTimeout(function(){W(bi,bj)},5000);return}}az(-1);an()}}})}function aM(){var bi="/jnap/storage/RemoveStorageDevice";RAINIER.ui.showWaiting();RAINIER.jnap.send({action:bi,data:{storageDeviceName:I().storageDeviceName},cb:function(bj){if(bj&&(bj.result==="OK"||bj.result==="ErrorUnknownStorageDevice")){W(I().storageDeviceName)}else{RAINIER.ui.hideWaiting();if(!bj||bj.result!=="_AjaxError"){RAINIER.ajax().executeDefaultJnapErrorHandler(bj,bi)}}},disableDefaultJnapErrHandler:true})}function aB(){if(!RAINIER.network.storageSupported()){RAINIER.event.fire("applet.unsupportedFirmware");return}O=RAINIER.ui.tabs.init({fireEvents:true,initialTab:$.cookie("initial-tab")});O.connect(function(bl,bj){if(bj.type==="tab"){N=bj.srcTabId;aj=bj.destTabId;ai=bj.destTab;var bk=false;if(bj.srcIdx>-1){bk=aq()}else{N=aj}if(bk||bj.destContent.hasClass("disabled")){aj=N;bl.cancelEvent=true;if(bk){a4.show()}}else{if(bj.destTabId==="status"){ag.find("footer .cancel").hide();ag.find("footer .apply").hide()}else{if(bj.destTabId==="folder-access"){ag.find("#folder-access-select-partition > select").change()}else{if(bj.destTabId==="media-server"){ag.find("#media-server-select-partition > select").change()}}ag.find("footer .cancel").show();ag.find("footer .apply").show()}}}else{d=bj.srcTabId}});O.fireInit();a8();RAINIER.ui.progressBar.build("usb-status-device div.progress-bar");ag.find("#refresh-usb-status").click(an);ag.find("#refresh-usb").click(function(){aG=true;an()});ag.find("#remove-usb").click(aM);ag.find("#status-select-partition select").change(function(){var bj=ag.find("#status-select-partition select").prop("selectedIndex");if(bj===-1){bj=0}az(bj);aV();RAINIER.binder.toDom(X,ag.find("#usb-information-panel"),be)});ag.find("#folder-access-select-partition > select").change(function(){var bj=ag.find("#folder-access-select-partition > select").prop("selectedIndex");if(bj===-1){bj=0}az(bj)});ag.find("#media-server-select-partition > select").change(function(){var bj=ag.find("#media-server-select-partition > select").prop("selectedIndex");if(bj===-1){bj=0}az(bj);au();ac(aX.upnpMediaFolders)});ag.find("#cbAddWidget").attr("checked",RAINIER.connect.AppletManager.getWidgetShowState("A2DB16C0-59B9-4C79-9BF2-E5A3A307F9C1","26BDD899-C17B-4032-B21C-3767AAB4FCCA"));a4=RAINIER.ui.dialog($("#dialog-tabchange"),{onSubmit:function(){f=true;R(false)}});ae=RAINIER.ui.dialog(aI,{onShow:function(){aI.find(".network-context").css("display",bb==="network"?"block":"none");aI.find(".media-context").css("display",bb==="media"?"block":"none")}});a0=RAINIER.ui.dialog(bh,{});ad=RAINIER.ui.dialog(U,{onSubmit:B});D=RAINIER.ui.dialog(aL,{onSubmit:aT});aL.find("#user-shares-add-share").click(function(){D.close();i()});aL.find(".close-button").click(function(){D.close()});ba=RAINIER.ui.dialog(a2,{onSubmit:aR});a2.find("#upgrade-cancel").click(function(){ba.close();Q.onClose()});a2.find(".close-button").click(function(){a2.find("#upgrade-cancel").click()});l=RAINIER.ui.dialog(H);y=RAINIER.ui.dialog($("#drive-unsupported-info"));ag.on("click",".unsupported-learn-more-link",function(){y.show();return false});$("#dialog-tabchange #no-save").unbind("click");$("#dialog-tabchange #no-save").click(function(){a4.close();w();ai.click()});ag.find("#secure-folder-access-switch").change(g);ag.find("#ftp-server-switch").change(ay);ag.find("#media-server-switch").change(bf);ag.find("#show-all-shares").click(n);U.find("#show-all-shares-dialog-create-new-share-link").click(function(){ad.close();Y("network")});U.find(".close-button").click(function(){ad.close()});bh.find("#create-new-share-button").click(function(){a0.close();aw=true;Y("network")});bh.find("#all-shares-checkbox").change(function(){if(!bh.find("#all-shares-checkbox").hasClass("dont-handle-click-event")){var bk=bh.find('#select-existing-share-rows input:[type="checkbox"]');var bl=(bh.find("#all-shares-row span.ui-checkbox-checked").length>0);for(var bj=0;bj<bk.length;bj++){$(bk[bj]).attr("checked",bl)}}});bh.find("#select-existing-share-submit").click(J);bh.find(".close-button").click(function(){a0.close()});aI.find("#create-share-cancel").click(function(){ae.close();if(aw){aw=false;i()}});var bi=aI.find("#select-folder-up-directory");bi.hover(function(){bi.addClass("hover")},function(){bi.removeClass("hover")});bi.mousedown(function(){bi.addClass("active")});bi.mouseup(function(){bi.removeClass("active")});bi.mouseout(function(){bi.removeClass("active")});aI.find("#select-folder-up-directory").click(h);aI.find('#create-share-share-all input:[type="checkbox"]').click(m);aI.find("#create-share-submit").click(e);aI.find(".close-button").click(function(){aI.find("#create-share-cancel").click()});ag.find("footer .cancel").click(Q.onClose);ag.find("footer .submit").click(Q.onSave);ag.find("footer .apply").click(Q.onApply);ag.find("#cbAddWidget").click(Q.onToggleWidget);an(true)}aB();function a8(){if(!aF.mediaServerSupported()){ag.find("#tab-media-server").remove();ag.find("div.tab-content#media-server").remove()}}function aT(){RAINIER.ui.showWaiting();aE=0;delete X.ftpFolders;var bj=true;var bm=aL.find("#user-shares-table tbody").children();for(var bo=0;bo<X.userShares.shareNames.length;bo++){var bk=X.userShares.shareNames[bo];var bi=true;for(var bn=0;bn<bm.length;bn++){if(bk===$(bm[bn]).find("label.user-shares-row-share-name").text()){bi=false;break}}if(bi){bj=false;var bp={};for(var bl=0;bl<X.smbFolders.length;bl++){if(X.smbFolders[bl].name===bk){bp=X.smbFolders[bl];var bs=bp.groupsWithPermission.indexOf(X.userShares.userName);bp.groupsWithPermission.splice(bs,1);delete bp.pathExists;break}}var bq=br.curry(bp);aE++;RAINIER.jnap.send({action:"/jnap/storage/EditSMBFolder",data:bp,cb:bq})}}if(bj){X.userShares=null;RAINIER.ui.hideWaiting()}at=function(){aE--;if(aE===0){X.userShares=null;RAINIER.ui.hideWaiting()}};function br(bt,bu){if(bu.result==="OK"){aE++;RAINIER.jnap.send({action:"/jnap/storage/EditFTPFolder",data:bt,cb:function(){at()}})}at()}}function B(){RAINIER.ui.showWaiting();aE=0;var bp=true;var bo=$(U.find("#show-all-shares-table tbody").children());var bj=I();for(var bm=0;bm<X.smbFolders.length;bm++){var bl=false;if(X.smbFolders[bm].partitionName===bj.partitionName){for(var bk=0;bk<bo.length;bk++){if($(bo[bk]).find(".show-all-shares-row-share-name").text()===X.smbFolders[bm].name){bl=true;break}}if(!bl){bp=false;aE++;var bi=bn.curry(X.smbFolders[bm].name);RAINIER.jnap.send({action:"/jnap/storage/DeleteSMBFolder",data:{name:X.smbFolders[bm].name},cb:bi})}}}if(bp){RAINIER.ui.hideWaiting()}function bn(br,bq){aE--;if(bq.result==="OK"){aE++;RAINIER.jnap.send({action:"/jnap/storage/DeleteFTPFolder",data:{name:br},cb:function(){aE--;if(aE===0){RAINIER.ui.hideWaiting()}}})}else{if(aE===0){RAINIER.ui.hideWaiting()}}}}function n(){RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/storage/GetSMBFolders",data:{},cb:function(bk){if(bk.result==="OK"){X.smbFolders=bk.output.smbFolders;G(X.smbFolders);var bi=F(X.smbFolders);var bj=$("<div></div>");$.each(bi,function(bl,bp){var bm=ag.find("#show-all-shares-row tr").clone(),bo="";bm.find("label.show-all-shares-row-share-name").text(bp.name);for(var bn=0;bn<bp.groupsWithPermission.length;bn++){bo+=bp.groupsWithPermission[bn]+" / "}bo=bo.substring(0,bo.length-2);bm.find(".show-all-shares-row-users-list").text(bo);bm.find("a").click(function(){var bq=$(this.parentElement.parentElement);bq.remove()});bj.append(bm)});U.find("#show-all-shares-table tbody").empty();U.find("#show-all-shares-table tbody").append(bj.children());ad.show()}RAINIER.ui.hideWaiting()}})}function J(){var bk=[];var bl=bh.find("#select-existing-share-rows span.ui-checkbox-checked");for(var bj=0;bj<bl.length;bj++){var bi=$(bl[bj].parentElement).find("label").text();bk.push(bi)}if(X.userShares){RAINIER.ui.showWaiting();delete X.smbFolders;delete X.ftpFolders;at=function(){aE--;if(aE===0){X.userShares=null;a0.close();RAINIER.ui.hideWaiting();at=null}};a1(bk,X.userShares.userName)}else{ag.find("#add-user-cell button").data.shares=bk;a0.close()}}function m(){var bp=$(this.parentElement),bj=aI.find("#select-folder"),bo=bj.find("input"),bi=bj.find("span.ui-radio"),bn=bj.find("div"),bm,bk,bl;if(bp.find("span.ui-checkbox-checked").length>0){for(bm=0;bm<bo.length;bm++){$(bo[bm]).prop("checked",false);$(bo[bm]).prop("disabled","disabled");var bq=$(bo[bm].parentElement);bq.removeClass("selected")}for(bk=0;bk<bi.length;bk++){$(bi[bk]).addClass("ui-radio-disabled");$(bi[bk]).addClass("ui-radio-state-disabled")}for(bl=0;bl<bn.length;bl++){$(bn[bl]).addClass("disabled")}aI.find("#create-share-submit").removeAttr("disabled");aI.find('#create-share-name-share input:[type="text"]').val("")}else{for(bm=0;bm<bo.length;bm++){$(bo[bm]).removeProp("disabled")}for(bk=0;bk<bi.length;bk++){$(bi[bk]).removeClass("ui-radio-disabled");$(bi[bk]).removeClass("ui-radio-state-disabled")}for(bl=0;bl<bn.length;bl++){$(bn[bl]).removeClass("disabled")}aI.find("#create-share-submit").attr("disabled","disabled")}}function h(){if(!$(this).hasClass("disabled")){if(ah.length>2){ah=ah.replace(/.$/,"");var bi=ah.lastIndexOf("/");ah=ah.substring(0,bi+1);S(ah)}}}function Y(bi){bb=bi;aI.find("#create-share-share-all").toggle(bb!=="media");aI.find("#create-share-share-all input").prop("checked",false);ah="/";S(ah);aI.find("#create-share-name-share input").val("")}function S(bi){RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/storage/ListSubdirectories",data:{partitionName:I().partitionName,path:bi},cb:function(bk){if(bk.result==="OK"){aI.find("#create-share-submit").prop("disabled","disabled");var bj=$("<div></div>");$.each(bk.output.subdirectories,function(bl,bo){var bn=$("#create-share-folders-row > li").clone();bn.find("label").text(bo);RAINIER.ui.fixCustomControls(bn);bn.find("input").change(function(){var bp=$(this.parentElement);var bs=$(this.parentElement.parentElement).children();for(var br=0;br<bs.length;br++){var bq=$(bs[br]);if(bq.find("span.ui-radio-checked").length>0){bq.addClass("selected")}else{bq.removeClass("selected")}}aI.find("#create-share-name-share > input:[type=text]").val(bp.find("label").text());aI.find("#create-share-submit").removeAttr("disabled")});var bm=bn.find("div.select-folder-enter-directory");bm.click(function(){if(!$(this).hasClass("disabled")){var bp=$(this.parentElement);ah+=bp.find("label").text()+"/";S(ah)}});bm.hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});bm.mousedown(function(){$(this).addClass("active")});bm.mouseup(function(){$(this).removeClass("active")});bm.mouseout(function(){$(this).removeClass("active")});bj.append(bn)});aI.find("#select-folder > ul li:not(:first)").remove();aI.find("#select-folder > ul").append(bj.children());aI.find("#select-folder > ul label:[tooltip]").each(function(){$(this).attr("tooltip",$(this).text())});RAINIER.ui.tooltip.add(aI.find("#select-folder > ul label:[tooltip]"));ae.show()}RAINIER.ui.hideWaiting()}})}function e(){if(aa.createShare.name.isValid(true)){RAINIER.ui.showWaiting();var bj="";if(aI.find("#create-share-share-all span.ui-checkbox-checked").length===0){var bk=aI.find("#select-folder li span.ui-radio-checked");bj=$(bk).parent().find("label").text()}var bi={name:aI.find("#create-share-name-share > input").val(),partitionName:I().partitionName,path:ah+bj,isReadOnly:false,groupsWithPermission:["admin"]};if(bb==="network"){v(bi)}else{if(bb==="media"){au();aX.upnpMediaFolders.append(bi);ac(aX.upnpMediaFolders);RAINIER.ui.hideWaiting();ae.close()}}}}function v(bi){var bj=aD.curry(bi);RAINIER.jnap.send({action:"/jnap/storage/CreateSMBFolder",data:bi,cb:bj,disableDefaultJnapErrHandler:true})}function aD(bi,bj){if(bj.result==="OK"){RAINIER.jnap.send({action:"/jnap/storage/CreateFTPFolder",data:bi,cb:function(bk){RAINIER.ui.hideWaiting();ae.close();if(bk.result==="OK"){X.ftpFolders.push(bi);if(aw){aw=false;i()}}else{if(bk.result!=="_AjaxError"){if(bk.result==="ErrorFolderExists"||bk.result==="ErrorTooManyFolders"){RAINIER.ui.alert(RAINIER.ui.validation.strings.errors[bk.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(bk)}}}},disableDefaultJnapErrHandler:true})}else{RAINIER.ui.hideWaiting();ae.close();if(bj.result!=="_AjaxError"){if(bj.result==="ErrorFolderExists"||bj.result==="ErrorTooManyFolders"){RAINIER.ui.alert(RAINIER.ui.validation.strings.errors[bj.result])}else{RAINIER.ajax().executeDefaultJnapErrorHandler(bj)}}}}}());