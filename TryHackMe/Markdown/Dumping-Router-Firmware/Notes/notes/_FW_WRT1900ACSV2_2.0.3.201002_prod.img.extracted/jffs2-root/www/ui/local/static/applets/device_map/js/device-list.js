window.RAINIER=window.RAINIER||{};RAINIER.applets=RAINIER.applets||{};RAINIER.applets.devicelist=(function(){var s=$("#networkmap-applet"),C=s.find("#device-info"),n=s.find("#cannot-delete-online"),P=s.find("#clear-list-warning"),r=$("#divStatsContent"),p=RAINIER.ui.buildInputValidBalloon,u=null,F="generic-device",N=null,h=null,f="",j=null,E=null,x=true,b={existingIdsMap:{},newIds:[],newIdsLengthBeforeAdd:0},K,w=false,d=false,k=true,B={};var A=RAINIER.ui.template.createTemplate($("#templateDevice > div")),o=RAINIER.ui.template.createTemplate($("#templDeviceConn tr"));var y={onRenameClick:function(){C.find(".dialog-header").addClass("edit");C.find("#name-text").focus()},onRenameSave:function(){var Q=C.find("#name-text").val();C.find(".dialog-header").removeClass("edit");if(j.friendlyName()!==Q){RAINIER.ui.showWaiting();if(RAINIER.connect.isWanConnected()&&j.isAuthority()&&RAINIER.network.uiLoadedFromCloud()){l(Q)}j.setUserName(Q,function(){C.find("#device-name h1").text(Q);m(true,true)})}else{}},onIconClick:function(){if(C.hasClass("folded")){q()}else{C.addClass("folded")}},onIconSave:function(){if(f!==F){RAINIER.ui.showWaiting();j.setUserType(F,function(){m(true,true)})}},onDeviceDelete:function(Q){RAINIER.ui.showWaiting();this.removeMe(function(S,R){RAINIER.ui.hideWaiting();if(S.result==="ErrorCannotDeleteDevice"){m(true,false);h.show()}else{if(S.result==="OK"){m(true,true);RAINIER.event.fire("devices.deviceDeleted")}else{RAINIER.ajax().executeDefaultJnapErrorHandler(S,R)}}});if(Q){$.cancelEvents(Q)}},onInfoClick:function(){C.removeClass("folded");C.find(".dialog-header").removeClass("edit");j=this;f=window.RAINIER.ui.getDeviceIcon(j);q();C.find("#device-name h1").text(j.friendlyName());C.find("#device-name").attr("tooltip",j.friendlyName());C.find("#name-text").val(j.friendlyName());RAINIER.ui.tooltip.add(C.find("#device-name"));C.find("#device-icon-wrapper").removeClass(F);F=window.RAINIER.ui.getDeviceIcon(j);C.find("#device-icon-wrapper").addClass(F);e(j);N.show()}};function e(){var U={name:j.friendlyName(),manufacturer:j.manufacturer()||"",model:j.modelNumber()||"",operatingSystem:j.operatingSystem()||""},R=j.connections(),Q={},T=null,S=0;r.find("#spacer-row, #ip-row, #ipv6-row, #mac-row").remove();RAINIER.binder.toDom(U,r,{});if(R){for(S=0;S<R.length;S++){Q={ipAddress:R[S].ipAddress||"--",ipv6Address:R[S].ipv6Address||"--",macAddress:R[S].macAddress,netType:(R[S].wireless)?RAINIER.ui.common.strings.netType.wireless:RAINIER.ui.common.strings.netType.lan,num:S+1};T=RAINIER.ui.template.createBlock(o,Q);r.find("tr:last-child").after(T)}}$.each(j.knownMACAddresses(),function(V,W){if($.grep(R,function(X){return X.macAddress===W}).length===0){Q={ipAddress:"--",ipv6Address:"--",macAddress:W,netType:RAINIER.ui.common.strings.offline,num:++S};T=RAINIER.ui.template.createBlock(o,Q);r.find("tr:last-child").after(T)}});T=s.find("#templDeviceConn tr#spacer-row").clone();r.find("tr:last-child").after(T)}function l(Q){var R={network:{friendlyName:Q}};RAINIER.cloud.send({url:"/cloud/device-service/rest/networks/"+RAINIER.network.getCurrentNetworkID(),type:"PUT",data:R,cb:function(S){RAINIER.event.fire("rainier.defaultNetworkRenamed")},cbError:function(S){console.warn(["default network rename error",S]);return false}})}function O(T,R){var S={name:R.friendlyName(),isConnected:R.isOnline()?RAINIER.ui.common.strings.online:RAINIER.ui.common.strings.offline},Q=RAINIER.ui.template.createBlock(A,S);Q.find("h2").attr("tooltip",S.name);Q.click(y.onInfoClick.bind(R));if(R.isAuthority()){u=y.onInfoClick.bind(R)}Q.find(".device-icon").addClass(RAINIER.ui.getDeviceIcon(R));if(R.isOnline()===true){Q.find(".close-button").addClass("disabled");Q.mouseover(function(){$(this).addClass("hover")});Q.mouseout(function(){$(this).removeClass("hover pressed")})}else{Q.find(".close-button").click(y.onDeviceDelete.bind(R));Q.addClass("offline");Q.mouseout(function(){$(this).removeClass("pressed")})}Q.mousedown(function(){$(this).addClass("pressed")});Q.mouseup(function(){$(this).removeClass("pressed")});T.append(Q)}function c(){if($.cookie("app-flag")==="edit-authority"){$.cookie("app-flag",null,{expiration:null,path:"/"});setTimeout(function(){s.find(".primary-device").click();setTimeout(function(){y.onRenameClick()},250)},250)}if($.cookie("initial-tab")==="guest-network"){s.find("#tab-header-guest-network").click()}RAINIER.applets.networkmap.App.smartmapView.setLockState(false)}function i(R){var U=s.find("#device-list"),Q=s.find("#device-list-guest"),S=0;if(!x){G(R)}R.sort(function(W,V){var X=b.newIds.indexOf(W.deviceID()),Y=b.newIds.indexOf(V.deviceID());if(X===Y){W=W.friendlyName().toLowerCase();V=V.friendlyName().toLowerCase();if(W===V){return 0}else{if(W>V){return 1}else{return -1}}}else{if(X>Y){return -1}else{return 1}}});U.text("");Q.text("");$.each(R,function(){if(j!==null&&j.deviceID()===this.deviceID()){j=this;e(j)}if(this.isGuest()){S++;O(Q,this);RAINIER.ui.tooltip.add(Q.find("h2"))}else{O(U,this);RAINIER.ui.tooltip.add(U.find("h2"))}});if(x){x=false;for(var T=0;T<R.length;T++){b.existingIdsMap[R[T].deviceID()]=true}RAINIER.event.fire("applet.loaded");if($.cookie("app-flag")){if($.cookie("app-flag")==="edit-authority"){if(u){setTimeout(function(){u();setTimeout(function(){y.onRenameClick()},250)},250)}}}}RAINIER.ui.hideWaiting()}function G(Q){var S;for(var R=0;R<Q.length;R++){S=Q[R].deviceID();if(!b.existingIdsMap[S]){b.existingIdsMap[S]=true;b.newIds.push(S)}}}function t(Q){var S=false,R=null;if(K&&Q&&Q.length>K.length){S=true}i(Q);if(b.newIds.length>b.newIdsLengthBeforeAdd){R=RAINIER.ui.alert("",RAINIER.ui.strings.deviceList.deviceAddedSuccessfully)}else{R=RAINIER.ui.alert("",RAINIER.ui.strings.deviceList.noDeviceAdded)}}function q(){C.removeClass("folded");if(j.isGuest()){C.find("#change-icon").hide();C.find("#edit-link").hide()}else{C.find("#change-icon").show();C.find("#edit-link").show()}}function v(){var Q=$(this).attr("class").replace("device-icon ","");C.find("#device-icon-wrapper").removeClass(F);C.find("#device-icon-wrapper").addClass(Q);F=Q}function m(R,Q){R=!!R;Q=!!Q;if(R){RAINIER.deviceManager.getDevices({cb:i,threshold:-1,doPollForChange:Q})}else{RAINIER.deviceManager.getDevices(i)}}function D(){var Q={validationType:"utf8LengthTooLong",maxLen:255,isRequired:true};B.deviceName=p($.extend(true,{},Q,{els:C.find('input[id="name-text"]')}))}function a(Q){s.find("ul.tabs").hide();Q.show();s.find("#folding-wrapper").addClass("expand")}function J(Q){s.find("#folding-wrapper").removeClass("expand");s.find("ul.tabs").show();setTimeout(function(){Q.hide()},600)}function L(){d=false}function H(){return w}function I(){return d}function z(){return k}function g(){var R=RAINIER.jnap.Transaction(),Q={};RAINIER.applets.guestNetwork.getSettings(Q,function(S){if(!S.isGuestNetworkEnabled){k=false;s.find("#guests-disabled").show();s.find(".no-guests").hide();s.find("#guest-net-label").hide();s.find("#tab-header-guest-network span").text("0")}},R);if(RAINIER.shared.util.areServicesSupported(["/jnap/router/Router2"])||RAINIER.shared.util.areServicesSupported(["/jnap/router/RouterBroadcom"])){R.add({action:RAINIER.jnapActions.getCTFSettings(),data:{},cb:function(S){if(S.result==="OK"){d=S.output.isCTFEnabled}else{}}})}R.send()}function M(){var Q=RAINIER.shared.util.areServicesSupported(["/jnap/devicelist/DeviceList2"]);w=RAINIER.shared.util.areServicesSupported(["/jnap/networktraffic/IPTrafficStatistics2"]);s.find(".tab-content").css("display","none");g();N=RAINIER.ui.dialog(C,{cancelClose:true,onSubmit:function(){if(B.deviceName.isValid(true)){y.onRenameSave();y.onIconSave();j=null;N.close()}}});h=RAINIER.ui.dialog(n);s.find("#cbAddWidget").attr("checked",RAINIER.connect.AppletManager.getWidgetShowState("EEBEB3F4-5482-4DAE-8D77-1BA5AC7D19BE","3B5D90D7-476B-491B-B5BA-CF09EB06873C"));s.find("#cbAddWidget").click(function(){RAINIER.connect.AppletManager.toggleWidgetShowState("EEBEB3F4-5482-4DAE-8D77-1BA5AC7D19BE","3B5D90D7-476B-491B-B5BA-CF09EB06873C")});s.find("#refresh-devices").click(function(){m(true,true)});C.find("#edit-link > a").click(y.onRenameClick);C.find("#name-text").keyup(function(R){return(R.keyCode||R.which)===13?$.cancelEvents(R):true});C.find("#change-icon").click(y.onIconClick);C.find("#lnkResetDialog").click(q);C.find("#divChange div.device-icon-box > div > div").click(v);RAINIER.ui.tooltip.add("#device-info .device-icon-box > div > div");D();E=RAINIER.ui.tabs.init({fireEvents:true,initialTab:$.cookie("initial-tab")});E.connect(function(T,R){var S=R.destTabId;if(S==="known-guests"||S==="guest-network"){s.find("#show-add-a-device").attr("disabled","disabled").addClass("disabled");s.find("#show-bandwidth-report").attr("disabled","disabled").addClass("disabled")}else{s.find("#show-add-a-device").removeAttr("disabled").removeClass("disabled");s.find("#show-bandwidth-report").removeAttr("disabled").removeClass("disabled")}if(S==="known-devices"||S==="known-guests"){s.find("#network-footer").hide()}});E.fireInit();if($.cookie("initial-tab")==="guest-network"){s.find("#online-network").css("display","none")}RAINIER.event.connect("tab.changed",function(S,R){var T=R.destTabId;if(T==="online-network"||T==="guest-network"){if(RAINIER.applets.networkmap&&RAINIER.applets.networkmap.App){RAINIER.applets.networkmap.App.smartmapView.setCurrentTabId(T)}}});RAINIER.event.connect("New Device Connected",function(){RAINIER.ui.showWaiting();RAINIER.deviceManager.getDevices(t,null,-1)});RAINIER.event.connect("Add Device Button Pressed",function(){K=b;b.newIdsLengthBeforeAdd=b.newIds.length});if(w){s.find("#bw-rpt-btn-wrapper").css("display","block")}if(Q){s.find("#clear-devices-btn-wrapper").css("display","block");s.find("#clear-devices").click(function(){RAINIER.ui.dialogWarning({msg:P.html(),submit:RAINIER.ui.button.strings.ok,cancel:RAINIER.ui.button.strings.cancel,onSubmit:function(){function R(){RAINIER.deviceManager.clearDevices();m(true);RAINIER.event.disconnect("router.interruptionCompleted",R)}RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/devicelist/ClearDeviceList",data:{preserveProperties:true},cb:function(S){if(S.result==="OK"){RAINIER.event.connect("router.interruptionCompleted",R)}}})}})})}}M();return{hasTrafficAPI:H,isCTFEnabled:I,isGuestAccessEnabled:z,onInfoClick:y.onInfoClick,onDeviceDelete:y.onDeviceDelete,unfoldSection:a,foldSection:J,ctfDisabled:L,checkAppFlag:c}}());