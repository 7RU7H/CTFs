RAINIER.firmwareUpdateCheckCounter=0;RAINIER.lastFirmwareUpdateCheckTime=null;RAINIER.firmwareUpdateSettings=null;RAINIER.GET_FIRMWARE_UPDATE_STATUS_INTERVAL=2500;RAINIER.GET_FIRMWARE_UPDATE_STATUS_TIMEOUT=10000;RAINIER.GET_FIRMWARE_UPDATE_STATUS_COUNT=15;RAINIER.CHECK_FIRMWARE_UPDATE_STATUS_INTERVAL=5000;RAINIER.CHECK_FIRMWARE_UPDATE_STATUS_MAX_TRIES=60;RAINIER.lastFirmwareUpdateStatus=null;RAINIER.powerTableSettings=null;function updateFinished(){var a="/ui/dynamic/setup/change_radio_settings.html";if(RAINIER.powerTableSettings&&RAINIER.powerTableSettings.isPowerTableSelectable){a="/ui/dynamic/setup/power_table.html"}if(RAINIER.setup.isRebooting){RAINIER.shared.ui.goToVerifiedUrl(a)}else{RAINIER.setup.goToPage(a)}}function internetCheckFinished(a){if(!a){RAINIER.shared.util.deleteCookie("hasInternet")}updateFinished()}function checkFirmwareUpdateStatus(b,a){getFirmwareUpdateStatus(function(g){var d=g.output?g.output.lastOperationFailure:null,c=g.result,e=g.output&&g.output.pendingOperation&&(g.output.pendingOperation.operation==="Rebooting"||g.output.pendingOperation.operation==="Downloading"||g.output.pendingOperation.operation==="Installing"),f=RAINIER.CHECK_FIRMWARE_UPDATE_STATUS_INTERVAL;if(RAINIER.lastFirmwareUpdateStatus===null&&g.output.pendingOperation){RAINIER.lastFirmwareUpdateStatus=g.output.pendingOperation.operation}if(e||c==="_AjaxError"||c==="_ErrorNotReady"||c==="_ErrorUnknownSession"){if(b>=a){RAINIER.setup.executeDefaultAjaxErrorHandler();return}if(e&&(RAINIER.lastFirmwareUpdateStatus!==g.output.pendingOperation.operation)){RAINIER.lastFirmwareUpdateStatus=g.output.pendingOperation.operation;b=0}else{b++}}else{if(d&&d!=="CheckFailed"){console.warn("cache.firmwareStatus.lastOperationFailure is present: "+d)}if(RAINIER.shared.util.getCookie("hasInternet")){pollForInternet(internetCheckFinished)}else{updateFinished()}return}if(g.output&&g.output.pendingOperation&&g.output.pendingOperation==="Rebooting"){f=45*1000}setTimeout(function(){checkFirmwareUpdateStatus(b,a)},f)})}function updateFirmware(){window.onbeforeunload=function(){return RAINIER.shared.util.decodeHtml(RAINIER.setup.ui.confirmExitUpdate)};RAINIER.setup.isRebooting=true;RAINIER.jnap.send({action:"/jnap/firmwareupdate/UpdateFirmwareNow",data:{onlyCheck:false},cb:function(a){if(a.result==="OK"){setTimeout(function(){checkFirmwareUpdateStatus(0,RAINIER.CHECK_FIRMWARE_UPDATE_STATUS_MAX_TRIES)},RAINIER.CHECK_FIRMWARE_UPDATE_STATUS_INTERVAL)}}})}function repeatFirmwareUpdateCheck(c){if(c.result==="OK"){var d=c.output,a=(RAINIER.lastFirmwareUpdateCheckTime!==d.lastSuccessfulCheckTime),b=(!d.pendingOperation||d.pendingOperation.operation!=="Checking");if(d.availableUpdate){showView("landing")}else{if((a&&b)||RAINIER.firmwareUpdateCheckCounter>RAINIER.GET_FIRMWARE_UPDATE_STATUS_COUNT){showView("noUpdates")}else{RAINIER.firmwareUpdateCheckCounter++;setTimeout(function(){getFirmwareUpdateStatus(repeatFirmwareUpdateCheck)},RAINIER.GET_FIRMWARE_UPDATE_STATUS_INTERVAL)}}}else{RAINIER.ajax().executeDefaultJnapErrorHandler(c)}}function getFirmwareUpdateStatus(a){RAINIER.jnap.send({action:"/jnap/firmwareupdate/GetFirmwareUpdateStatus",data:{},cb:function(b){if(!b||!b.result){b={result:"_ErrorNotReady"}}if(typeof a==="function"){a(b)}},disableDefaultJnapErrHandler:true,disableDefaultAjaxErrHandler:true,disableDefaultRebootErrHandler:true,timeoutMs:RAINIER.GET_FIRMWARE_UPDATE_STATUS_TIMEOUT})}function checkForFirmwareUpdateHelper(){getFirmwareUpdateStatus(function(a){RAINIER.lastFirmwareUpdateCheckTime=a.output.lastSuccessfulCheckTime;RAINIER.jnap.send({action:"/jnap/firmwareupdate/UpdateFirmwareNow",data:{onlyCheck:true},cb:function(b){if(b.result==="OK"){setTimeout(function(){getFirmwareUpdateStatus(repeatFirmwareUpdateCheck)},RAINIER.GET_FIRMWARE_UPDATE_STATUS_INTERVAL)}}})})}function saveAutoUpdateSettingAndUpdateFirmware(){var b=document.getElementById("automaticUpdatesCheckbox");var a=b.checked;var c=RAINIER.firmwareUpdateSettings.updatePolicy==="AutomaticallyCheckAndInstall";if(a!==c){if(a){RAINIER.firmwareUpdateSettings.updatePolicy="AutomaticallyCheckAndInstall"}else{RAINIER.firmwareUpdateSettings.updatePolicy="Manual"}RAINIER.jnap.send({action:"/jnap/firmwareupdate/SetFirmwareUpdateSettings",data:RAINIER.firmwareUpdateSettings,cb:function(d){if(d.result==="OK"){updateFirmware()}}})}else{updateFirmware()}}function saveAutoUpdateSetting(){var a=document.getElementById("updateAutomaticallyCheckbox").checked;var b=RAINIER.firmwareUpdateSettings.updatePolicy==="AutomaticallyCheckAndInstall";if(a!==b){if(a){RAINIER.firmwareUpdateSettings.updatePolicy="AutomaticallyCheckAndInstall"}else{RAINIER.firmwareUpdateSettings.updatePolicy="Manual"}RAINIER.jnap.send({action:"/jnap/firmwareupdate/SetFirmwareUpdateSettings",data:RAINIER.firmwareUpdateSettings,cb:function(c){if(c.result==="OK"){updateFinished()}}})}else{updateFinished()}}function goToNextPage(){var a=getCurrentView();startPleaseWaitTimer();if(a==="landing"){showView("updating");saveAutoUpdateSettingAndUpdateFirmware()}else{if(a==="noUpdates"){showView("noUpdates");saveAutoUpdateSetting()}else{}}}function init(b){if(b.result==="OK"){RAINIER.jnapCache.set(RAINIER.jnapActions.getDeviceInfo(),b.output);var a=RAINIER.jnap.Transaction({onComplete:function(c){if(c.result==="OK"){checkForFirmwareUpdateHelper()}}});a.add({action:"/jnap/firmwareupdate/GetFirmwareUpdateSettings",data:{},cb:function(c){if(c.result==="OK"){RAINIER.firmwareUpdateSettings=c.output}}});if(RAINIER.shared.util.areServicesSupported(["/jnap/powertable/PowerTable"])){a.add({action:"/jnap/powertable/GetPowerTableSettings",data:{},cb:function(c){if(c.result==="OK"){RAINIER.powerTableSettings=c.output}}})}a.send()}}window.onbeforeunload=function(){return RAINIER.shared.util.decodeHtml(RAINIER.setup.ui.confirmExit)};window.onload=function(){startPleaseWaitTimer();getRouterInfo(false,init);showView("loading")};