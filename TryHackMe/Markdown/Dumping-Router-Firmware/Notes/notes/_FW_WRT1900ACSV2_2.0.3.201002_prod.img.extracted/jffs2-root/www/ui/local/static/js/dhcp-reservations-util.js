window.RAINIER=window.RAINIER||{};RAINIER.applets=RAINIER.applets||{};RAINIER.applets.dhcpReservations=(function(){var J=null,q=null,K=null,u=null,j={description:"",ipAddress:"",macAddress:""},l=RAINIER.ui.common.strings.netType.lan,n=RAINIER.ui.common.strings.netType.wireless,h=RAINIER.ui.common.strings.offline,p=RAINIER.ui.buildInputValidBalloon,v=false;var w=new RegExp(RAINIER.ui.validation.tests.isNotHostName.source,"g");var o={lanSettings:{},lanSettingsSetup:{},dhcpLease:{}};var b={reservationList:[]};var i=null,g=null,A=null;var H={openDHCPReservations:function(M,N){B();y(M,N);u.show()},onEditReservation:function(){var M=$(this);M.addClass("edit");M.removeClass("hover");RAINIER.binder.toDom(RAINIER.binder.fromDom(M.find(".spEdit.ip")),M.find(".spStatic.ip"),{})},onCancelEditReservation:function(){var N=$(this),M=this.index()-1;RAINIER.ui.inputBalloon.hide();RAINIER.ui.validation.removeInvalidMarks(N);N.removeClass("edit");if(b.reservationList[M].description===""&&b.reservationList[M].ipAddress===""&&b.reservationList[M].macAddress===""){b.reservationList.splice(M,1);N.remove()}else{RAINIER.binder.toDom(b.reservationList[M],N,{})}},onDelReservation:function(){RAINIER.ui.inputBalloon.hide();var M=this.index()-1;b.reservationList.splice(M,1);$(this).remove()},onUpdReservation:function(){RAINIER.ui.inputBalloon.hide();var M=this.index()-1,N=$(this),O=RAINIER.binder.fromDom(N);if(f(this)){b.reservationList[M]=O;RAINIER.binder.toDom(b.reservationList[M],N,{});N.removeClass("edit")}},onSaveComplete:function(){if(v){u.close()}}};function C(M){if(M.lanSettings.dhcpSettings){var N=[];["dnsServer1","dnsServer2","dnsServer3","winsServer"].forEach(function(O){if(M.lanSettings.dhcpSettings[O]==="0.0.0.0"){N.push(O)}});$.delAttr(M.lanSettings.dhcpSettings,N)}}function B(){if(K.find('input[type="checkbox"]:checked').length>0){J.find("#add-reservation").removeAttr("disabled")}else{J.find("#add-reservation").attr("disabled","disabled")}}function E(O,M){var N=RAINIER.ui.template.createBlock(i,M);N.find('input[type="checkbox"]').click(B);O.append(N)}function x(M){RAINIER.ui.clearTbl(K);RAINIER.ui.clearTbl(q);function N(){var O=RAINIER.jnap.Transaction({onComplete:function(){if(typeof M==="function"){M()}y()}});O.add({action:"/jnap/router/GetLANSettings",data:{},cb:function(P){if(P.result==="OK"){o.lanSettings=P.output||{};o.lanSettingsSetup=$.extend(true,o.lanSettingsSetup,o.lanSettings);o.lanSettings.dhcpSettings.reservations=$.extend(true,[],P.output.dhcpSettings.reservations)||{};o.lanSettingsSetup.dhcpSettings.reservations=$.extend(true,[],o.lanSettings.dhcpSettings.reservations);o.lanSettingsSetup.subnetMask=RAINIER.util.fromPrefixLengthToSubnet(o.lanSettings.networkPrefixLength);$.delAttr(o.lanSettings,"minNetworkPrefixLength","maxNetworkPrefixLength","maxDHCPReservationDescriptionLength","minAllowedDHCPLeaseMinutes","maxAllowedDHCPLeaseMinutes");b.lanSettings=$.extend(true,{},o.lanSettings);RAINIER.binder.toDom(o,$("#dhcp-reservations-block"),{})}else{}}});O.add({action:"/jnap/router/GetDHCPClientLeases",data:{},cb:function(P){if(P.result==="OK"){o.dhcpLease=P.output||{}}else{}}});O.send()}RAINIER.deviceManager.getDevices(N,"excludeAuthority",-1)}function k(M){if(M){q.find("tr").each(function(N){if(N>0){if($(this).find("span.mac").text()===M.macAddress){$(this).find("span.desc").text(M.friendlyName());return}}})}}function r(P){var M=RAINIER.util.dot2num(P),O=RAINIER.util.dot2num(o.lanSettingsSetup.dhcpSettings.firstClientIPAddress),N=RAINIER.util.dot2num(o.lanSettingsSetup.dhcpSettings.lastClientIPAddress);if(M>=O&&M<=N){return true}else{return false}}function D(U){function O(Y){var V=RAINIER.util.dot2num(RAINIER.util.getObjVal(RAINIER.binder.fromDom(Y.parent()),Y.attr("name"))),X=q.find('.spStatic.ip > div[name="ipAddress"]');for(var W=0;W<X.length;W++){if($(X[W]).is(":visible")&&V===RAINIER.util.dot2num(RAINIER.util.getObjVal(RAINIER.binder.fromDom($(X[W]).parent()),$(X[W]).attr("name")))){return false}}return true}function T(W){var V=RAINIER.util.getObjVal(RAINIER.binder.fromDom(W.parent()),W.attr("name"));return r(V)}function S(X){var W=q.find('span[class="spStatic mac"]');for(var V=0;V<W.length;V++){if($(W[V]).is(":visible")&&X.toUpperCase()===$(W[V]).text().toUpperCase()){return false}}return true}function P(X){var V=RAINIER.util.dot2num(RAINIER.util.getObjVal(RAINIER.binder.fromDom(X.parent()),X.attr("name"))),W=RAINIER.util.dot2num(o.lanSettings.ipAddress);return(V===W)}var M={},Q={minLen:1,maxLen:o.lanSettingsSetup.maxDHCPReservationDescriptionLength,validationType:"hostName",whiteSpace:false,isRequired:true},N={validCharSet:"numeric",minLen:1,maxLen:3,validationType:"validHost",whiteSpace:false},R={minLen:17,maxLen:17,validationType:"macAddress",blankIsOkOnblur:false,isRequired:true};M.deviceName=p($.extend(true,{},Q,{els:U.find('input[name="description"]:text')}));M.ipAddress=p($.extend(true,{},N,{elContainer:U.find('.spEdit > div[name="ipAddress"]'),errors:[{test:O.curry(U.find('.spEdit > div[name="ipAddress"]')),when:false,message:RAINIER.ui.validation.strings.connectivity.duplicatedIpAddress},{test:T.curry(U.find('.spEdit > div[name="ipAddress"]')),when:false,message:RAINIER.ui.validation.strings.invalidIPAddress},{test:P.curry(U.find('.spEdit > div[name="ipAddress"]')),when:true,message:RAINIER.ui.validation.strings.invalidIPAddress}],elInputSubnetMask:$("#dhcp-reservations-block").find('div.ip-input[name="lanSettingsSetup.subnetMask"]'),elInputRouterIPAddress:$("#dhcp-reservations-block").find('div.ip-input:[name="lanSettings.ipAddress"]')}));M.macAddress=p($.extend(true,{},R,{els:U.find('input[name="macAddress"]:text'),elContainer:U.find('input[name="macAddress"]:text'),errors:[{test:S,when:false,message:RAINIER.ui.validation.strings.connectivity.duplicatedMacAddress}]}));U.data(M)}function f(N){var M=N.data();return M.deviceName.isValid(true)&&M.ipAddress.isValid(true)&&M.macAddress.isValid(true)}function e(O,N){if(!N){for(var M=0;M<b.reservationList.length;M++){if(b.reservationList[M].macAddress.toUpperCase()===O.macAddress.toUpperCase()||b.reservationList[M].ipAddress===O.ipAddress){return false}}}var P=RAINIER.ui.template.createBlock(A,O);if(O.ipAddress){RAINIER.binder.toDom(O,P.find('.spStatic.ip > div[name="ipAddress"]').parent(),{});RAINIER.binder.toDom(O,P.find('.spEdit.ip > div[name="ipAddress"]').parent(),{})}P.find(".spStatic.mac").text(O.macAddress);P.find(".spEdit.mac > input").val(O.macAddress);if(RAINIER.ui.validation.tests.isNotHostName.test(O.description)){N=true;O.description="";O.ipAddress="";O.macAddress=""}D(P);RAINIER.util.trapEnter(P);if(N){P.addClass("edit")}P.find("td").hover(function(){var Q=$(this).parent();if(!Q.hasClass("edit")){Q.addClass("hover")}},function(){$(this).parent().removeClass("hover")});P.find('input[name="macAddress"]').change(function(){var Q=$.trim(P.find('input[name="macAddress"]').val());Q=Q.replace(/-/g,":");P.find('input[name="macAddress"]').val(Q)});P.find("#edit-device").click(H.onEditReservation.bind(P));P.find("#delete-device").click(H.onDelReservation.bind(P));P.find("#save-device").click(H.onUpdReservation.bind(P));P.find("#cancel").click(H.onCancelEditReservation.bind(P));if($.compare(O,j)){q.find("tr:first-child").after(P)}else{q.append(P)}return true}function y(Q,M){var U,V,O;function P(X,Y){var W;if(Y){U={name:Y.friendlyName(),ipAddress:X.ipAddress,macAddress:X.macAddress};W=[U];O=Y.connections();c(W);U.netType=h;if(W.length){if(O.length){$.each(O,function(Z,aa){if(aa.macAddress===U.macAddress&&aa.ipAddress===U.ipAddress){if(aa.wireless){U.netType=n}else{U.netType=l}}})}E(K,U)}}}RAINIER.ui.clearTbl(K);RAINIER.ui.clearTbl(q);b.reservationList=[];$.each(o.dhcpLease.leases,function(){RAINIER.deviceManager.getDeviceByMACAddress(P.curry(this),this.macAddress)});if(Q){var N=Q.connections(),R=Q.friendlyName().replace(w,""),S="",T=[];$.each(o.lanSettingsSetup.dhcpSettings.reservations,function(W,X){if(F(Q,X.macAddress)){T.push(X)}});if(N.length){$.each(N,function(W,X){S=R;if(W>0){S+=W}U={macAddress:X.macAddress,description:S,ipAddress:X.ipAddress};if(!M||t(X.macAddress)){b.reservationList.push(U);e(U,true);$.each(T,function(Y,Z){if(Z.macAddress===X.macAddress){T.splice(Y,1)}});V=J.find("#reservation-list > tbody > tr.edit:eq(0)")}})}if(T.length){$.each(T,function(W,X){U={macAddress:X.macAddress,description:X.description,ipAddress:X.ipAddress};b.reservationList.push(U);e(U,true)})}}$.each(o.lanSettings.dhcpSettings.reservations,function(){U=$.extend({},this);if(!Q||!F(Q,U.macAddress)){if(e(U,false)){b.reservationList.push(U)}}if(U.macAddress){RAINIER.deviceManager.getDeviceByMACAddress(k,U.macAddress)}})}function a(){var N=[],M;b.reservationList=b.reservationList.filter(function(O){return(!$.compare(O,j))});$.each(o.lanSettingsSetup.dhcpSettings.reservations,function(O,P){for(M=b.reservationList.length-1;M>-1;M--){if(P.macAddress===b.reservationList[M].macAddress){N.push($.extend(true,{},b.reservationList[M]));b.reservationList.splice(M,1);break}}});$.each(b.reservationList,function(O,P){N.push($.extend(true,{},P))});b.lanSettings.dhcpSettings.reservations=$.extend(true,[],N);b.reservationList=$.extend(true,[],N);return b.lanSettings.dhcpSettings.reservations}function c(R){var O=RAINIER.util.dot2num(o.lanSettingsSetup.dhcpSettings.firstClientIPAddress),N=RAINIER.util.dot2num(o.lanSettingsSetup.dhcpSettings.lastClientIPAddress),P,M;if(R){for(var Q=0;Q<R.length;Q++){P=R[Q].ipAddress;M=RAINIER.util.dot2num(P);if(!RAINIER.ui.validation.tests.isHostValidForGivenRouterIPAddressAndSubnetMask(P,o.lanSettings.ipAddress,o.lanSettingsSetup.subnetMask)||M<O||M>N){R.splice(Q,1);Q--}}}}function s(R){var P=q.find('tr[class="edit"]'),M=4,T=0,O=(RAINIER.network.isAuthorityRemote()?5:10)*1000;function N(){RAINIER.ui.showMasterWaiting();console.warn("connection.enableCheck");RAINIER.event.disconnect("connection.enableCheck",N);setTimeout(function(){RAINIER.deviceManager.getDevices({cb:null,threshold:-1,exclusions:{excludeAuthority:true}});H.onSaveComplete();RAINIER.ui.hideMasterWaiting();RAINIER.ui.hideWaiting()},O)}for(var Q=0;Q<P.length;Q++){if(!f($(P[Q]))){return}else{$(P[Q]).find("#save-device").click()}}b.lanSettings=$.extend(true,b.lanSettings,o.lanSettings);a();console.warn(["DHCP Reservations: (store, cache, hasChanges)",b.lanSettings,o.lanSettings,!$.compare(b.lanSettings,o.lanSettings)]);if(!$.compare(o.lanSettings,b.lanSettings)){C(b);if(R){RAINIER.ui.showWaiting()}else{RAINIER.ui.blockUI()}var S={action:"/jnap/router/SetLANSettings",data:b.lanSettings,cb:function(U){if(U.result==="OK"){o.lanSettings.dhcpSettings.reservations=$.extend([],b.lanSettings.dhcpSettings.reservations);o.lanSettingsSetup.dhcpSettings.reservations=$.extend(true,[],o.lanSettings.dhcpSettings.reservations);v=true}else{if(R){v=false}else{if(T++<M){setTimeout(function(){RAINIER.jnap.send(S)},4000)}else{RAINIER.jnap.executeDefaultJnapErrorHandler(U,S.action)}}}if(R&&v){RAINIER.event.connect("connection.enableCheck",N);if(RAINIER.network.isAuthorityRemote()){RAINIER.event.fire("router.interruptionStarted");setTimeout(function(){RAINIER.event.fire("connection.enableCheck");RAINIER.event.fire("router.interruptionCompleted")},5000)}}}};RAINIER.jnap.send(S)}else{if(R){u.close()}}}function L(N){var M=false;$.each(o.dhcpLease.leases,function(O,P){if($.grep(N.knownMACAddresses(),function(Q){return Q===P.macAddress}).length>0){M=true;return false}});return M}function F(O,N){var M=false;if($.grep(O.knownMACAddresses(),function(P){return P===N}).length>0){M=true}return M}function z(N){var M=false;$.each(o.lanSettings.dhcpSettings.reservations,function(O,P){if(F(N,P.macAddress)){M=true;return false}});return M}function t(N){var M=false;$.each(o.lanSettings.dhcpSettings.reservations,function(O,P){if(P.macAddress===N){M=true;return false}});return M}function I(P){var O=true,N=P.connections();function M(R){var S=false;if($.grep(R,function(T){return !RAINIER.applets.dhcpReservations.isIPAddressInDhcpRange(T.ipAddress)}).length>0){S=true}return S}if(N.length>1||M(N)){O=false;RAINIER.applets.dhcpReservations.openDHCPReservations(P)}else{var Q={macAddress:N[0].macAddress,description:P.friendlyName().replace(w,""),ipAddress:N[0].ipAddress};b.reservationList.push(Q);s(false)}return O}function d(){return o.lanSettingsSetup.isDHCPEnabled}function m(N){var P=o.lanSettings.ipAddress.split("."),M=g.find("span.spEdit > div.ip-input").children(":not(span)");for(var O=0;O<o.lanSettingsSetup.minNetworkPrefixLength/8;O++){if($(M[O]).is("input")){$(M[O]).replaceWith("<label>"+P[O]+"</label>")}}g.find("#description").attr("maxLength",o.lanSettingsSetup.maxDHCPReservationDescriptionLength);A=RAINIER.ui.template.createTemplate(g);if(!u){u=RAINIER.ui.dialog(J,{cancelClose:true,onSubmit:function(){s(true)}});J.find(".close-button").click(function(){x();u.close()});J.find("#add-reservation").click(function(){J.find("#devices-list").find("tr").each(function(Q){if(Q>0){if($(this).find('input[type="checkbox"]').is(":checked")){var T=$(this).find(".desc").text().substr(0,o.lanSettingsSetup.maxDHCPReservationDescriptionLength),R=$(this).find(".ipAddr").text(),U=$(this).find(".mac").text();var S={macAddress:U,description:T.replace(w,""),ipAddress:R};if(e(S,false)){b.reservationList.push(S)}else{RAINIER.ui.alert(RAINIER.ui.validation.strings.connectivity.dhcpReservationAlreadyExists)}$(this).find('input[type="checkbox"]').attr("checked",false)}}});B()});J.find("#add-device").click(function(){var Q=$.extend({},j);if(e(Q,true)){b.reservationList.unshift(Q)}})}if(typeof N==="function"){N()}}function G(M){J=$("#dhcp-reservations-dialog");q=J.find("#reservation-list");K=J.find("#devices-list");i=RAINIER.ui.template.createTemplate($("#templateDeviceRow tr"));g=$("#immutableTemplateReserveRow tr");x(function(){m(M)})}return{init:G,openDHCPReservations:H.openDHCPReservations,scrubInvalidDHCPReservations:c,dhcpReservationsToDom:y,dhcpReservationsFromDom:a,stripDefaultIPValues:C,deviceHasDhcpAddress:L,deviceHasDhcpReservation:z,reserveDevice:I,isDHCPEnabled:d,isIPAddressInDhcpRange:r}}());