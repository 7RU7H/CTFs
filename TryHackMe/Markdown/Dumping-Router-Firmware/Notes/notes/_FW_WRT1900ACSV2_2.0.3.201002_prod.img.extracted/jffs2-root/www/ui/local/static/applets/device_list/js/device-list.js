(function(){var J=$("#device-list-applet"),z=J.find("#device-info"),k=J.find("#cannot-delete-online"),M=J.find("#clear-list-warning"),q=$("#divStatsContent"),o=RAINIER.ui.buildInputValidBalloon,s=null,E="generic-device",I=null,e=null,c="",g=null,D=null,u=true,a={existingIdsMap:{},newIds:[],newIdsLengthBeforeAdd:0},G,v=null,C="BDBC8297-8982-4BCF-84EC-91783FF9013C",y={};var x=RAINIER.ui.template.createTemplate($("#templateDevice > div")),A=RAINIER.ui.template.createTemplate($("#templNodeFwDetails tr")),m=RAINIER.ui.template.createTemplate($("#templDeviceConn tr"));var w={onRenameClick:function(){z.find(".dialog-header").addClass("edit");z.find("#name-text").focus()},onRenameSave:function(){var N=z.find("#name-text").val();z.find(".dialog-header").removeClass("edit");if(g.friendlyName()!==N){RAINIER.ui.showWaiting();if(RAINIER.connect.isWanConnected()&&g.isAuthority()&&RAINIER.network.uiLoadedFromCloud()){i(N)}g.setUserName(N,function(){z.find("#device-name h1").text(N);j(true,true)});if(RAINIER.network.isBehindNode()&&g.nodeType){RAINIER.network.clearNodesCurrentFirmwareVersions();setTimeout(function(){RAINIER.network.checkNodesCurrentFirmwareVersions()},5000)}}else{}},onIconClick:function(){if(z.hasClass("folded")){z.removeClass("folded")}else{z.addClass("folded")}},onIconSave:function(){if(c!==E){RAINIER.ui.showWaiting();g.setUserType(E,function(){j(true,true)})}},onDeviceDelete:function(N){RAINIER.ui.showWaiting();this.removeMe(function(P,O){RAINIER.ui.hideWaiting();if(P.result==="ErrorCannotDeleteDevice"){j(true,false);e.show()}else{if(P.result==="OK"){j(true,true)}else{RAINIER.ajax().executeDefaultJnapErrorHandler(P,O)}}});$.cancelEvents(N)},onInfoClick:function(){z.removeClass("folded");z.find(".dialog-header").removeClass("edit");g=this;c=window.RAINIER.ui.getDeviceIcon(g);z.find("#device-name h1").text(g.friendlyName());z.find("#device-name").attr("tooltip",g.friendlyName());z.find("#name-text").val(g.friendlyName());RAINIER.ui.tooltip.add(z.find("#device-name"));z.find("#device-icon-wrapper").removeClass(E);E=window.RAINIER.ui.getDeviceIcon(g);z.find("#device-icon-wrapper").addClass(E);b(true);I.show()}};var h={knownDevices:J.find("#known-devices-tab"),knownGuests:J.find("#known-guests-tab")};var d={knownGuests:false};function n(){var O;if(!g){return}O=_.result(_.find(v.output.firmwareUpdateStatus,{deviceUUID:g.deviceID()}),"availableUpdate");if(O){q.find(".available-fw").addClass("show");var N=RAINIER.connect.AppletManager.getAppletById(C);q.find("#update-nodes").click(function(){I.close();RAINIER.ui.herald.close("firmware-update");RAINIER.ui.MainMenu.launchApplet(N,"","update-firmware")})}else{q.find(".up-to-date-fw").addClass("show")}}function b(S){var R={name:g.friendlyName(),manufacturer:g.manufacturer()||"",model:g.modelNumber()||"",operatingSystem:g.operatingSystem()||""},O=g.connections(),N={},Q=null,P=0;p(S);if(RAINIER.network.isBehindNode()&&g.nodeType()){R.model=symmetryUtil.firmwareUpdate.getRouterModelLabel(g.data);R.currentVersion=g.firmwareVersion()||"";Q=RAINIER.ui.template.createBlock(A,R);q.find("tr:last-child").after(Q);q.find(".checking-fw, .up-to-date-fw, .available-fw").removeClass("show");v=RAINIER.network.getNodesAvailableUpdates();if(!v){q.find(".checking-fw").addClass("show");RAINIER.network.checkNodesFwUpdate(function(){q.find(".checking-fw").removeClass("show");v=RAINIER.network.getNodesAvailableUpdates();n()})}else{n()}}RAINIER.binder.toDom(R,q,{});if(O){for(P=0;P<O.length;P++){N={ipAddress:O[P].ipAddress||"--",ipv6Address:O[P].ipv6Address||"--",macAddress:O[P].macAddress,netType:(O[P].wireless)?RAINIER.ui.common.strings.netType.wireless:RAINIER.ui.common.strings.netType.lan,num:P+1};Q=RAINIER.ui.template.createBlock(m,N);q.find("tr:last-child").after(Q)}}$.each(g.knownMACAddresses(),function(T,U){if($.grep(O,function(V){return V.macAddress===U}).length===0){N={ipAddress:"--",ipv6Address:"--",macAddress:U,netType:RAINIER.ui.common.strings.offline,num:++P};Q=RAINIER.ui.template.createBlock(m,N);q.find("tr:last-child").after(Q)}});Q=J.find("#templDeviceConn tr#spacer-row").clone();q.find("tr:last-child").after(Q)}function i(N){var O={network:{friendlyName:N}};RAINIER.cloud.send({url:"/cloud/device-service/rest/networks/"+RAINIER.network.getCurrentNetworkID(),type:"PUT",data:O,cb:function(P){RAINIER.event.fire("rainier.defaultNetworkRenamed")},cbError:function(P){console.warn(["default network rename error",P]);return false}})}function K(Q,O){var P={name:O.friendlyName(),isConnected:O.isOnline()?RAINIER.ui.common.strings.online:RAINIER.ui.common.strings.offline},N=RAINIER.ui.template.createBlock(x,P);N.find("h2").attr("tooltip",P.name);N.click(w.onInfoClick.bind(O));if(O.isAuthority()){s=w.onInfoClick.bind(O)}N.find(".device-icon").addClass(RAINIER.ui.getDeviceIcon(O));if(O.isOnline()===true){N.find(".close-button").addClass("disabled");N.mouseover(function(){$(this).addClass("hover")});N.mouseout(function(){$(this).removeClass("hover pressed")})}else{N.find(".close-button").click(w.onDeviceDelete.bind(O));N.addClass("offline");N.mouseout(function(){$(this).removeClass("pressed")})}N.mousedown(function(){$(this).addClass("pressed")});N.mouseup(function(){$(this).removeClass("pressed")});Q.append(N)}function f(O){var R=J.find("#device-list"),N=J.find("#device-list-guest"),P=0;if(!u){F(O)}O.sort(function(T,S){var U=a.newIds.indexOf(T.deviceID()),V=a.newIds.indexOf(S.deviceID());if(U===V){T=T.friendlyName().toLowerCase();S=S.friendlyName().toLowerCase();if(T===S){return 0}else{if(T>S){return 1}else{return -1}}}else{if(U>V){return -1}else{return 1}}});R.text("");N.text("");$.each(O,function(){if(g!==null&&g.deviceID()===this.deviceID()){g=this;b(false)}if(this.isGuest()){P++;K(N,this);RAINIER.ui.tooltip.add(N.find("h2"))}else{K(R,this);RAINIER.ui.tooltip.add(R.find("h2"))}});if(!P){J.find("#no-guests").show()}else{J.find("#no-guests").hide()}if(u){u=false;for(var Q=0;Q<O.length;Q++){a.existingIdsMap[O[Q].deviceID()]=true}RAINIER.event.fire("applet.loaded");if($.cookie("app-flag")){if($.cookie("app-flag")==="edit-authority"){if(s){setTimeout(function(){s();setTimeout(function(){w.onRenameClick()},250)},250)}}}}RAINIER.ui.hideWaiting()}function F(N){var P;for(var O=0;O<N.length;O++){P=N[O].deviceID();if(!a.existingIdsMap[P]){a.existingIdsMap[P]=true;a.newIds.push(P)}}}function r(N){var P=false,O=null;if(G&&N&&N.length>G.length){P=true}f(N);if(a.newIds.length>a.newIdsLengthBeforeAdd){O=RAINIER.ui.alert("",RAINIER.ui.strings.deviceList.deviceAddedSuccessfully)}else{O=RAINIER.ui.alert("",RAINIER.ui.strings.deviceList.noDeviceAdded)}}function p(N){q.find("#spacer-row, #fw-row, #ip-row, #ipv6-row, #mac-row").remove();if(!N){return}z.removeClass("folded");if(g.isGuest()||g.nodeType()){z.find("#change-icon").hide();if(g.isGuest()){z.find("#edit-link").hide()}}else{z.find("#change-icon").show();z.find("#edit-link").show()}}function t(){var N=$(this).attr("class").replace("device-icon ","");z.find("#device-icon-wrapper").removeClass(E);z.find("#device-icon-wrapper").addClass(N);E=N}function j(O,N){O=!!O;N=!!N;if(O){RAINIER.deviceManager.getDevices({cb:f,threshold:-1,doPollForChange:N})}else{RAINIER.deviceManager.getDevices(f)}}function B(){var N={validationType:"utf8LengthTooLong",maxLen:255,isRequired:true};y.deviceName=o($.extend(true,{},N,{els:z.find('input[id="name-text"]')}))}function L(){d.knownGuests=!RAINIER.network.isBehindNode()||(RAINIER.network.isBehindNode()&&RAINIER.shared.util.areServicesSupported(["/jnap/devicelist/DeviceList4"]));if(d.knownGuests){h.knownDevices.after(h.knownGuests)}else{if(!h.knownGuests.hasClass("selected")){h.knownGuests.remove()}}}function l(){if(RAINIER.network.isBehindNode()){RAINIER.deviceManager.stopUpdateNodeConnections()}RAINIER.event.disconnect("applet.unloaded",l)}function H(){var N=RAINIER.shared.util.areServicesSupported(["/jnap/devicelist/DeviceList2"]);L();J.find(".tab-content").css("display","none");I=RAINIER.ui.dialog(z,{cancelClose:true,onSubmit:function(){if(y.deviceName.isValid(true)){w.onRenameSave();w.onIconSave();g=null;I.close()}}});e=RAINIER.ui.dialog(k);J.find("#cbAddWidget").attr("checked",RAINIER.connect.AppletManager.getWidgetShowState("691E0149-A1D4-450C-9922-82CAA65B16C0","FE6A30AF-CA8E-4A26-9B01-ACB66C23044F"));J.find("#cbAddWidget").click(function(){RAINIER.connect.AppletManager.toggleWidgetShowState("691E0149-A1D4-450C-9922-82CAA65B16C0","FE6A30AF-CA8E-4A26-9B01-ACB66C23044F")});RAINIER.ui.tooltip.add(".refresh, .clear-btn");J.find("#refresh-devices").click(function(){j(true,true)});if(N){J.find("#clear-devices-btn-wrapper").css("display","block");J.find("#clear-devices").click(function(){RAINIER.ui.dialogWarning({msg:M.html(),submit:RAINIER.ui.button.strings.ok,cancel:RAINIER.ui.button.strings.cancel,onSubmit:function(){function O(){RAINIER.deviceManager.clearDevices();j(true);RAINIER.event.disconnect("router.interruptionCompleted",O)}RAINIER.ui.showWaiting();RAINIER.jnap.send({action:"/jnap/devicelist/ClearDeviceList",data:{preserveProperties:true},cb:function(P){if(P.result==="OK"){RAINIER.event.connect("router.interruptionCompleted",O)}}})}})})}z.find("#edit-link > a").click(w.onRenameClick);z.find("#name-text").keyup(function(O){return(O.keyCode||O.which)===13?$.cancelEvents(O):true});z.find("#change-icon, #lnkResetDialog").click(w.onIconClick);z.find("#divChange div.device-icon-box > div > div").click(t);j(true);RAINIER.ui.tooltip.add("#device-info .device-icon-box > div > div");B();D=RAINIER.ui.tabs.init({fireEvents:true,initialTab:$.cookie("initial-tab")});D.connect(function(P,O){if(O.destTabId==="known-guests"){J.find("#add-device-btn-wrapper").hide()}else{J.find("#add-device-btn-wrapper").show()}});D.fireInit();RAINIER.event.connect("New Device Connected",function(){RAINIER.ui.showWaiting();RAINIER.deviceManager.getDevices(r,null,-1)});RAINIER.event.connect("Add Device Button Pressed",function(){G=a;a.newIdsLengthBeforeAdd=a.newIds.length});if(RAINIER.network.isBehindNode()){RAINIER.deviceManager.updateNodeConnections(function(){RAINIER.deviceManager.getDevices(f)})}RAINIER.event.connect("applet.unloaded",l);RAINIER.event.connect(["devices.revisionUpdated","devices.guestNetworkUpdated"],j)}H()}());